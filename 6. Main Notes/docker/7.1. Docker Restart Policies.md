# 7.1. Docker Restart Policies

2025-08-09 10:49
Status: #DONE
Tags: [[Docker]]

---
### Mastering Docker Restart Policies: Ensuring Container Reliability

When we’re managing containers with Docker, ensuring they start up reliably—especially after crashes or system restarts—is a key concern. Docker provides restart policies to automate this process, giving us control over how and when our containers come back online. Let’s break down these policies, explore their nuances, and see how they behave, particularly when the Docker daemon itself restarts.

#### What Are Docker Restart Policies?

Docker restart policies determine whether and when a container automatically restarts after it stops or when the Docker daemon (the background service managing Docker) restarts. Think of the Docker daemon as the "boss" of our container playground—it keeps everything running smoothly. If the boss takes a break or restarts, we need to decide if our containers should jump back into action. We set these policies using the `--restart` flag when running a container with the `docker run` command. The example shows the syntax:
```
docker run --it --name mycent --restart [flag] cents:latest
```
- **`--it`**: Runs the container in interactive mode with a terminal, letting us type commands directly.
- **`--name mycent`**: Names the container `mycent` for easy reference.
- **`--restart [flag]`**: Specifies the restart policy (e.g., `no`, `on-failure`, `always`, `unless-stopped`).
- **`cents:latest`**: The image we’re using to create the container.

Now, let’s dive into each policy and what it means for us.

#### Detailed Explanation of Each Restart Policy

1. **No (Default Policy)**
   - **Description**: This policy means we don’t want the container to restart automatically. It’s the default setting, acting like a "hands-off" approach—our container stays stopped unless we manually start it again.
   - **Behavior on Exit**: If the container stops (due to an error or manual stop), it stays off.
   - **Behavior on Docker Daemon Restart**: If the Docker daemon restarts (e.g., after a server reboot), the container remains stopped. We’d need to start it manually with:
     ```
     docker start mycent
     ```
   - **Use Case**: Ideal for development or one-off tasks where we want full control.

2. **On-Failure**
   - **Description**: This policy restarts the container only if it exits with a non-zero exit code, which typically indicates an error. Imagine it as a safety net—our container only gets back up if something went wrong.
   - **Behavior on Exit**: If the container stops with an exit code of 0 (successful exit), it stays stopped. If it exits with, say, 1 (error), it restarts.
   - **Behavior on Docker Daemon Restart**: After a daemon restart, the container’s state is checked. If it was stopped due to an error before the restart, it will attempt to restart. If it was stopped cleanly (exit code 0), it remains off.
   - **Use Case**: Great for critical applications where we want to recover from crashes but not from intentional stops.

3. **Always**
   - **Description**: This policy ensures the container always restarts if it stops, no matter the reason. It’s like a persistent robot that keeps getting back to work, even if we tell it to take a break.
   - **Behavior on Exit**: Whether the container stops due to an error, a manual stop, or a clean exit, it restarts automatically.
   - **Behavior on Docker Daemon Restart**: If the daemon restarts, the container restarts as well, regardless of its previous state. This ensures high availability, even after a system reboot.
   - **Use Case**: Perfect for production services (e.g., web servers) that must run continuously.

4. **Unless-Stopped**
   - **Description**: This is similar to `always`, but with a twist—it won’t restart the container if it was manually stopped. Think of it as a robot that restarts unless we explicitly tell it to stay off.
   - **Behavior on Exit**: If the container stops due to an error or clean exit, it restarts. If we stop it manually with:
     ```
     docker stop mycent
     ```
     it stays stopped.
   - **Behavior on Docker Daemon Restart**: After a daemon restart, the container restarts only if it was running before the restart. If we had stopped it manually, it remains stopped, even after the daemon comes back online.
   - **Use Case**: Useful for services we want to keep running automatically but allow manual intervention without persistent restarts.

#### Comparing Restart Policies with a Focus on Docker Daemon Restart

Here’s a detailed table comparing the restart policies, with special attention to their behavior when the Docker daemon restarts:

| **Policy**      | **Restart on Exit (Any Reason)** | **Restart on Exit with Error (Non-Zero Code)** | **Behavior on Docker Daemon Restart** | **Use Case Example**          |
|------------------|----------------------------------|-----------------------------------------------|---------------------------------------|-------------------------------|
| **no**           | No                               | No                                            | Remains stopped                      | Development testing           |
| **on-failure**   | No                               | Yes                                           | Restarts if stopped by error, otherwise remains stopped | Error recovery for apps       |
| **always**       | Yes                              | Yes                                           | Always restarts                      | High-availability web server  |
| **unless-stopped** | Yes                          | Yes                                           | Restarts if running, stays stopped if manually stopped | Managed production services   |

- **Explanation of Columns**:
  - **Restart on Exit (Any Reason)**: Whether the container restarts regardless of why it stopped (e.g., error, manual stop, or clean exit).
  - **Restart on Exit with Error**: Specific to `on-failure`, where only non-zero exit codes trigger a restart.
  - **Behavior on Docker Daemon Restart**: Highlights the policy’s action after the Docker daemon (the core service managing containers) restarts, which could happen due to a server reboot or service reload.
  - **Use Case Example**: Practical scenarios where each policy shines.

#### Additional Insights and Best Practices

- **Setting the Policy**: We apply the restart policy at container creation. For example, to run a container with the `always` policy:
  ```
  docker run --restart always --name myweb -d nginx:latest
  ```
  The `-d` flag runs it in detached mode, letting it run in the background.

- **Checking the Policy**: To see the current restart policy, we can inspect the container:
  ```
  docker inspect mycent | grep RestartPolicy
  ```
  This outputs the policy name and any additional settings (e.g., maximum retry attempts for `on-failure`).

- **Modifying the Policy**: We can’t change the restart policy after a container is created. If we need a different policy, we must recreate the container with the new `--restart` flag.

- **Linux Kernel Context (ELI5)**: Imagine the Linux kernel as the "brain" of our computer that tells all the programs (like Docker) how to work together. The Docker daemon is like a manager that the brain trusts to handle containers. When the manager (daemon) restarts, it checks its notes (restart policies) to decide which containers to wake up. For non-tech folks, this is like a teacher leaving the classroom and asking a helper to restart certain games based on rules we set!
  - **Technical Detail**: The Docker daemon interacts with the Linux kernel’s containerization features (e.g., namespaces and cgroups) to manage container lifecycles. Restart policies are stored as part of the container’s configuration in the daemon’s state, ensuring consistency across restarts. The kernel ensures the daemon can restore container processes based on these policies.

- **Common Pitfalls**: If we use `always` on a container that should be stopped for maintenance, we might need to remove it with:
  ```
  docker rm -f mycent
  ```
  and recreate it with a different policy. Also, `on-failure` requires monitoring exit codes, which we can check with:
  ```
  docker inspect mycent --format '{{.State.ExitCode}}'
  ```

- **Monitoring**: For production, we might pair these policies with health checks (using `HEALTHCHECK` in the Dockerfile) to ensure restarts only occur when the container is truly ready.

By understanding and applying these restart policies, we can ensure our containers behave reliably, whether we’re testing locally or running critical services in production. The choice of policy depends on our needs for automation, error recovery, and manual control, especially during system restarts.