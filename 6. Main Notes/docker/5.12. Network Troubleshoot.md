# 5.12. Network Troubleshoot

2025-08-09 10:49
Status: #DONE
Tags: [[Docker]]

---

When working with Docker containers, network issues can be particularly challenging to diagnose. We have two main approaches to troubleshoot these problems: installing troubleshooting tools directly in the application container (not recommended) or using a dedicated troubleshooting container that shares the network namespace with our application container. The second approach is cleaner and more maintainable, which we'll explore in depth.

## Understanding Network Namespaces

**ELI5 Explanation**: Imagine your container is like a house with its own private phone system (network). Normally, you can't listen to calls happening in another house. But what if you could temporarily connect your phone to your neighbor's phone system? That's what sharing a network namespace does - it lets one container see another container's network activity.

**Technical Explanation**: Docker creates separate network namespaces for containers by default, providing network isolation. When we use `--net container:<name>`, we're instructing Docker to have the new container share the same network namespace as the specified container, allowing us to inspect its network traffic and configuration.

## Basic Network Troubleshooting Setup

To demonstrate network troubleshooting, we first need a sample application container. Let's use NGINX:

```
docker run -d --name mynginx -p 80:80 nginx
```

This creates an NGINX web server container named `mynginx` that maps port 80 on the host to port 80 in the container.

Now we can launch our troubleshooting container that shares the network namespace:

```
docker run -it --network container:mynginx nicolaka/netshoot
```

![[5.12. Netshoot Welcome Screen.png]]

This shows the netshoot container starting up with the same network interface as our NGINX container, ready for troubleshooting.

## Essential Network Troubleshooting Tools

### 1. tcpdump - Network Traffic Analysis

**ELI5**: tcpdump is like putting a microphone on your network cable to hear all the conversations (packets) going back and forth.

**Technical**: tcpdump is a powerful command-line packet analyzer that captures and displays network traffic in real-time. It can filter traffic by protocol, port, host, and more.

Example from our NGINX container:
```
tcpdump -i eth0 port 80 -c 1 -X
```

This command:
- `-i eth0`: Listens on the eth0 interface
- `port 80`: Filters for traffic on port 80 (HTTP)
- `-c 1`: Captures only 1 packet then exits
- `-X`: Shows packet contents in hex and ASCII

![[5.12. tcpdump Output.png]]

The output shows a TCP SYN packet (connection initiation) from 172.17.0.1 trying to connect to our NGINX server.

### 2. netstat - Network Connection Monitoring

**ELI5**: netstat is like checking which doors (ports) in your house are open and who's currently visiting.

**Technical**: netstat displays network connections, routing tables, interface statistics, masquerade connections, and multicast memberships.

Example usage:
```
netstat -na
```

![[5.12. netstat Output.png]]

This shows our NGINX container listening on port 80 (0.0.0.0:80 means listening on all available network interfaces) for both IPv4 and IPv6 connections.

### 3. nmap - Network Exploration and Security Auditing

**ELI5**: nmap is like knocking on all the doors (ports) of a house to see which ones are open.

**Technical**: nmap is a network scanner used to discover hosts and services on a computer network by sending packets and analyzing responses.

Example scanning our NGINX container:
```
nmap -p 1-1024 -dd 172.17.0.2 | grep open
```

This scans ports 1-1024 on the container IP (172.17.0.2) and shows only open ports. The `-dd` flag provides very verbose debugging output.

![[5.12. nmap Output.png]]

We can see port 80 (HTTP) is open, which makes sense for our NGINX web server.

### 4. iperf - Network Performance Testing

**ELI5**: iperf is like timing how fast you can send a bucket of water between two hoses to test the hose's capacity.

**Technical**: iperf is a tool for active measurements of the maximum achievable bandwidth on IP networks.

Example setup:
1. First create a dedicated network:
```
docker network create perf-test
```

2. Start a server container:
```
docker run -itd --name perf-test-a --network perf-test nicolaka/netshoot iperf -s -p 9999
```

3. Start a client container to test bandwidth:
```
docker run -itd --name perf-test-b --network perf-test nicolaka/netshoot iperf -c perf-test-a -p 9999
```

![[5.12. iperf Results.png]]

The results show excellent bandwidth (28.7 Gbits/sec) between containers on the same Docker network, which is expected for local container-to-container communication.

### 5. iftop - Bandwidth Monitoring

**ELI5**: iftop is like a speedometer for your network connection, showing which "cars" (connections) are using the most "road" (bandwidth).

**Technical**: iftop displays bandwidth usage on an interface by host connection, showing incoming and outgoing traffic.

Example usage:
```
iftop -i eth0
```

This would show real-time bandwidth usage on the eth0 interface of our container.

## Host Network Troubleshooting

Sometimes the issue isn't in the container but on the host itself. For these cases, we can run netshoot with the host's network namespace:

```
docker run -it --net host nicolaka/netshoot
```

This gives us access to all host network interfaces and allows troubleshooting at the host level.

## Best Practices and Considerations

1. **Security**: Be cautious with privileged access. The `--privileged` flag gives the container access to all host devices and bypasses many security restrictions.

2. **Resource Usage**: Tools like tcpdump can be resource-intensive. Always limit capture size with `-c` or duration with `-G` in production environments.

3. **Cleanup**: Remember to remove test containers after troubleshooting:
```
docker rm -f perf-test-a perf-test-b
docker network rm perf-test
```

4. **Persistent Tools**: For frequent troubleshooting, consider creating a custom image based on netshoot with your commonly used tools pre-installed.

By leveraging these tools and techniques, we can effectively diagnose and resolve even the most challenging Docker network issues while maintaining clean separation between our application containers and troubleshooting tools.