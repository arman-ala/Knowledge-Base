### Limiting Disk Usage for Docker Containers: Understanding the Error

When you try to limit the disk usage of a Docker container, you might run into some hiccups, as shown in the error message. Let’s break down what’s happening and how to fix it, then dive into the details of mount options and filesystems as requested.

#### The Error: Why Can’t We Limit the Container’s Disk Size?

The command you tried to run is:

```bash
docker run --name limited_centos7 --storage-opt size=5G centos:centos7.9.2009
```

This command attempts to create a container named "limited_centos7" based on the `centos:centos7.9.2009` image, with a disk size limit of 5 GiB using the `--storage-opt size=5G` flag. However, it fails with the following error:

```
docker: Error response from daemon: --storage-opt is supported only for overlay over xfs with 'pquota' mount option
```

Let’s unpack this error:
- The `--storage-opt size` flag is used to limit the size of the container’s writable layer (the part of the container’s filesystem that stores changes like new files or logs). This is different from memory limits we discussed earlier—it’s about controlling disk usage.
- The error tells us that this option is only supported when:
  1. The Docker storage driver is `overlay` (or `overlay2`, which is a newer version of `overlay`).
  2. The underlying filesystem (called the "backing filesystem") is XFS.
  3. The XFS filesystem is mounted with the `pquota` (project quota) option enabled.

#### Checking Your Docker Setup with `docker info`

The `docker info` output you provided gives us a snapshot of your Docker environment:

![[3.7.2_result_info.png]]

Here’s what we learn:
- **Storage Driver: overlay2**: Your Docker setup is using the `overlay2` storage driver, which is good because it’s a requirement for using `--storage-opt size`. The `overlay2` driver is efficient and widely recommended for modern Docker setups, as we discussed earlier.
- **Backing Filesystem: xfs**: The underlying filesystem is XFS, which also meets the requirement for `--storage-opt size`. So far, so good!
- **Containers and Images**: You have 7 containers (1 running, 6 stopped) and 3 images, which gives us a sense of your environment’s activity.

However, the error mentions that the XFS filesystem needs the `pquota` mount option, and that’s where the problem lies. Even though your backing filesystem is XFS, it’s not mounted with `pquota` enabled, so Docker can’t enforce the disk size limit.

#### Fixing the Issue: Enabling the `pquota` Mount Option

To use `--storage-opt size`, you need to ensure your XFS filesystem is mounted with the `pquota` option. Here’s how to check and fix it:
1. **Check Current Mount Options**: Run the following command to see how your XFS filesystem is mounted (replace `/dev/sdX` with your actual device, which you can find using `df -h` or `lsblk`):

```bash
cat /proc/mounts | grep xfs
```

```bash
mount | grep xfs
```

This might output something like:

![[3.7.2_result_mount_grep.png]]

In this example, the mount options are `rw,relatime,seclabel,logbufs=8,logbsize=32k,attr2,inode64,noquota`. Notice `noquota`—this means quotas (including project quotas) are disabled.

2. **Remount with `pquota`**: To enable `pquota`, you need to remount the filesystem. First, edit your `/etc/fstab` file to add `pquota` to the mount options for your XFS filesystem. Open `/etc/fstab` with a text editor (like `nano` or `vim`):

```bash
sudo nano /etc/fstab
```

Find the line for your XFS filesystem, which might look like:

```
/dev/sda1 / xfs defaults 0 0
```

Change it to include `pquota`:

```
/dev/sda1 / xfs defaults,pquota 0 0
```

Save the file and exit. Then, remount the filesystem:

```bash
sudo mount -o remount /
```

3. **Verify the Mount Options**: Run the `cat /proc/mounts | grep xfs` command again to confirm `pquota` is now included:

```
/dev/sda1 / xfs rw,relatime,attr2,inode64,pquota 0 0
```

4. **Restart Docker**: After changing the mount options, restart the Docker daemon to apply the changes:

```bash
sudo systemctl restart docker
```

Now, try running your command again:

```bash
docker run --name limited_centos7 --storage-opt size=5G centos:centos7.9.2009
```

This should work, and the container’s writable layer will be limited to 5 GiB. If it tries to use more disk space (e.g., by writing large log files), Docker will prevent it, and the container might fail with an out-of-space error.

#### Understanding Mount Options and `pquota`

Mount options are settings you apply when mounting a filesystem to control its behavior. For XFS, the `pquota` mount option is specifically required for Docker’s `--storage-opt size` because it enables **project quotas**, which Docker uses to enforce disk limits for containers. Let’s explore `pquota` and other common mount options for XFS, and compare them in a table.

**What is `pquota`?**  
The `pquota` (project quota) option allows XFS to enforce disk usage limits on a per-project basis. In Docker’s case, each container is treated as a "project," and the `--storage-opt size` flag sets a quota for that project’s writable layer. This ensures the container can’t exceed the specified disk size (5 GiB in your example).

**Other Common Mount Options for XFS**  
Here are some other mount options you might encounter with XFS:
- **usrquota**: Enables user quotas, which limit disk usage per user.
- **grpquota**: Enables group quotas, which limit disk usage per group.
- **noquota**: Disables all quotas (user, group, and project), which is likely the default in your current setup.
- **rw**: Mounts the filesystem as read-write (you can write to it).
- **ro**: Mounts the filesystem as read-only (you can’t write to it).
- **relatime**: Updates file access times only when necessary, improving performance.
- **noatime**: Disables updating file access times entirely, for even better performance.

**Table: Comparing Mount Options for XFS**

| **Mount Option** | **What It Does**                                                                 | **Use Case**                                                                 |
|------------------|----------------------------------------------------------------------------------|------------------------------------------------------------------------------|
| `pquota`         | Enables project quotas to limit disk usage for specific projects (like containers). | Required for Docker’s `--storage-opt size` to limit container disk usage.    |
| `usrquota`       | Enables user quotas to limit disk usage per user.                                | Useful for multi-user systems to restrict disk usage per user.              |
| `grpquota`       | Enables group quotas to limit disk usage per group.                              | Useful for restricting disk usage for groups of users (e.g., a dev team).    |
| `noquota`        | Disables all quotas (user, group, project).                                      | Default setting when quotas aren’t needed; prevents Docker disk limits.     |
| `rw`             | Mounts the filesystem as read-write, allowing modifications.                     | Standard for most systems where you need to write data.                     |
| `ro`             | Mounts the filesystem as read-only, preventing modifications.                    | Useful for read-only workloads, like serving static data.                   |
| `relatime`       | Updates file access times only when the file is modified or after a set interval.| Balances performance and access time updates; common default for XFS.       |
| `noatime`        | Disables updating file access times, reducing disk I/O.                          | Improves performance for high I/O workloads, like databases or containers.  |

These options let you fine-tune how your filesystem behaves, depending on your needs. For Docker, `pquota` is the key to enabling disk size limits, but you might use others like `noatime` to boost performance.

#### Understanding Filesystems: XFS and Others

The "backing filesystem" is the filesystem on your host where Docker stores its data (like container writable layers and images). In your case, it’s XFS, but Docker supports other filesystems too. Let’s explore XFS and other common filesystems, and compare their features in a table.

**What is XFS?**  
XFS is a high-performance filesystem designed for scalability and reliability. It’s great for large-scale systems because it supports large files, fast crash recovery, and advanced features like project quotas (which Docker needs for `--storage-opt size`). XFS uses a journaling mechanism to ensure data consistency after a crash, and it’s widely used in enterprise environments.

**Other Common Filesystems**  
Here are some other filesystems Docker can work with:
- **ext4**: A widely used filesystem for Linux, known for its reliability and good performance for general-purpose workloads.
- **btrfs**: A modern filesystem with features like snapshots, subvolumes, and built-in RAID support, making it great for advanced storage management.
- **zfs**: A filesystem with powerful features like snapshots, data deduplication, and built-in volume management, often used in high-end storage systems.
- **overlayfs**: Not a traditional filesystem but a union filesystem used by Docker’s `overlay` and `overlay2` storage drivers to layer container filesystems.

**Table: Comparing Filesystems**

| **Filesystem** | **Key Features**                                                                 | **Pros**                                                                 | **Cons**                                                                 | **Docker Support**                     |
|----------------|----------------------------------------------------------------------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|----------------------------------------|
| **XFS**        | High performance, scalability, journaling, supports project quotas.              | Fast for large files, reliable crash recovery, good for Docker with `pquota`. | Requires `pquota` for disk limits, less flexible than btrfs/zfs.         | Supported with `overlay2` (needs `pquota` for `--storage-opt size`). |
| **ext4**       | Reliable, widely used, journaling, good general-purpose performance.            | Stable, widely supported, good for most workloads.                      | Lacks advanced features like snapshots or project quotas.                | Supported, but no disk size limits.    |
| **btrfs**      | Snapshots, subvolumes, built-in RAID, compression, supports quotas.              | Great for snapshots and storage management, native Docker support.      | Can be slower for some workloads, more complex to manage.                | Supported, can use `--storage-opt size` natively. |
| **zfs**        | Snapshots, deduplication, volume management, data integrity checks.             | Powerful for storage management, excellent data integrity.              | High memory usage, complex setup, licensing concerns on Linux.           | Supported, can use `--storage-opt size` natively. |
| **overlayfs**  | Union filesystem, layers filesystems for Docker’s storage drivers.              | Lightweight, efficient for Docker’s layered architecture.               | Not a standalone filesystem; relies on a backing filesystem like XFS.    | Used by `overlay`/`overlay2` drivers, not a backing filesystem. |

Each filesystem has its strengths, and your choice depends on your workload. For Docker, XFS with `pquota` is a solid choice if you need to limit container disk usage, but btrfs and zfs offer more advanced features like snapshots, which can be handy for backups or rollbacks. If you have more questions about filesystems or Docker storage, just let me know!