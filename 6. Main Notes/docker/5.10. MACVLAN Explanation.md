### Understanding the MACVLAN Driver for Connecting Containers to Existing Networks

#### Introduction to MACVLAN and Network Connectivity (ELI5 Explanation)

Imagine you have a big toy box where all your toys (like containers) share one phone line to talk to the outside world. With a bridge network, they all use the same phone number, so no one outside knows which toy is calling—it just sees the box! The MACVLAN driver is like giving each toy its own special phone number and address. Now, when a toy calls, everyone outside can see exactly which toy it is, and it can talk directly to the big playground (the network) without sharing. This makes it easier to keep track of who’s doing what, like knowing if your robot or car is downloading a game!

#### Technical Description of MACVLAN and Network Connectivity

The MACVLAN driver in Docker enables the connection of containerized applications to existing physical networks or Virtual Local Area Networks (VLANs) by assigning each container a unique Media Access Control (MAC) address and Internet Protocol (IP) address. This approach contrasts with the bridge network, where containers share the host’s network interface and appear as a single entity to external systems. The provided document emphasizes this capability, focusing on prerequisites and compatibility across various platforms.

#### Benefits and Limitations of MACVLAN

The MACVLAN driver provides enhanced performance by eliminating the need for port mappings or additional bridges, allowing direct connection of the container’s network interface to the host’s interface or sub-interface. For example, in a scenario where a container downloads files, the bridge network masks the container’s identity under the host’s IP, whereas MACVLAN assigns a distinct IP (e.g., 10.0.0.92), enabling external traceability. However, a significant limitation is the requirement for the host’s Network Interface Card (NIC) to operate in promiscuous mode, which accepts all network traffic. This mode is often prohibited on public cloud platforms due to security constraints, restricting its applicability in such environments.

#### Diagram Explanation: Connecting to a Physical Network

![[5.10. Diagram showing containers connected to a physical network using MACVLAN.png.png]]

This diagram illustrates the MACVLAN configuration, depicting multiple containers with unique IP and MAC addresses (e.g., 10.0.0.92 with MAC: 22:46, 10.0.0.36 with MAC: 21:26) connected to a virtual machine (VM) and a physical host. The underlying physical network or VLAN (e.g., 10.0.0.0/24) serves as the foundation, facilitating direct communication and enhancing isolation and visibility for each container.

#### Handling Multiple VLANs

The document addresses multi-VLAN scenarios. For instance, consider a physical network with two VLANs:
- VLAN 100: 10.0.0.0/24
- VLAN 200: 192.168.3.0/24

![[5.10. Diagram showing VLAN 100 and VLAN 200 on a physical network.png.png]]

This diagram represents a physical network trunking two VLANs, with VLAN 100 using subnet 10.0.0.0/24 and VLAN 200 using 192.168.3.0/24. Trunking, based on 802.1Q tagging, allows the physical network interface to manage traffic for both VLANs, enabling containers to be configured for specific VLANs.

#### Prerequisites and Compatibility (Based on New Document)

The new document outlines essential prerequisites for implementing the MACVLAN driver, focusing on system and infrastructure compatibility. Key requirements include:
- **Operating System Support**: MACVLAN is supported on Linux hosts with kernel versions 3.9 or higher, with version 4.0 recommended for optimal performance. Docker Desktop on Mac and Windows requires Docker EE (Enterprise Edition) or Windows Server, as native support is limited.
- **Cloud Provider Restrictions**: Many cloud providers block promiscuous mode on NICs, necessitating alternative solutions or specific permissions.
- **Hardware and Network Infrastructure**: The host must have a compatible NIC and network equipment capable of handling VLAN tagging (802.1Q). Linux-based systems are the primary environment, requiring proper configuration of network management tools.
- **Docker Environment**: A properly configured Docker environment with network management essentials ensures seamless integration. The document emphasizes the need for technical specifications, including kernel compatibility and hardware access control.

These prerequisites ensure that the MACVLAN driver operates effectively within the intended network infrastructure, addressing potential compatibility issues across diverse platforms.

#### Creating a Docker Network with MACVLAN

To connect a container to a specific VLAN (e.g., VLAN 100), we create a Docker network using the MACVLAN driver with the following command:

```
docker network create -d macvlan \
  --subnet=10.0.0.0/24 \
  --ip-range=10.0.0.0/25 \
  --gateway=10.0.0.1 \
  --parent=eth0 \
  macvlan100
```

- **`-d macvlan`**: Designates the MACVLAN driver for network creation.
- **`--subnet=10.0.0.0/24`**: Defines the IP range (10.0.0.0 to 10.0.0.255) with a subnet mask of 255.255.255.0, accommodating 256 addresses.
- **`--ip-range=10.0.0.0/25`**: Restricts assignable IPs to 10.0.0.0 to 10.0.0.127, offering granular control.
- **`--gateway=10.0.0.1`**: Specifies the gateway IP, the network’s exit point (e.g., for internet access).
- **`--parent=eth0`**: Links the network to the host’s interface (e.g., eth0) or sub-interface (e.g., eth0.100 for VLAN 100).
- **`macvlan100`**: Assigns the network name for reference.

This command establishes a network named "macvlan100" for VLAN 100, ensuring containers connect directly to the specified subnet.

#### Practical Example and Clarifications

Consider a web server container. With a bridge network, its traffic appears as the host’s IP (e.g., 10.0.0.1), obscuring its identity. Using the MACVLAN network, it receives a unique IP (e.g., 10.0.0.92), allowing external systems to identify it. This is valuable for environments requiring isolation or monitoring. The Persian text correctly notes the bridge network’s limitation and MACVLAN’s improvement, but full connectivity depends on proper VLAN and routing configuration, including NIC support for 802.1Q tagging and compatible network switches.

#### Conclusion and Additional Considerations

Implementing MACVLAN enhances container networking by providing direct access to physical networks and VLANs, improving performance and visibility. We must address the promiscuous mode requirement and ensure compatibility with cloud providers, hardware, and Linux kernel versions. For multiple VLANs, additional networks (e.g., for VLAN 200) can be created by adjusting the `--parent` to `eth0.200` and updating the subnet, ensuring independent operation. This solution leverages Linux sub-interfaces and physical network interfaces, making it suitable for advanced container virtualization and routing needs.