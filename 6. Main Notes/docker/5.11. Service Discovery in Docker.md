# 5.11. Service Discovery in Docker

2025-08-09 19:43
Status: #DONE  
Tags: [[Docker]]

---
### Exploring Service Discovery in Docker with DNS Resolution

#### Introduction to Service Discovery and DNS (ELI5 Explanation)

Imagine you and your friends are playing in different rooms, and you want to send a toy ball to your friend named "c2" but don’t know where they are. You ask your big helper (the local resolver) who checks a magic phone book. If the helper doesn’t know, it calls the super-smart Docker phone book (DNS server) that knows everyone’s address because it wrote them down when they joined the game. The Docker phone book tells your helper where "c2" is (like an IP address), and then you can throw the ball to the right room! But, this only works if you and "c2" are playing in the same playground (same network).

#### Technical Description of Service Discovery and DNS Resolution

Service discovery in Docker, supported by the libnetwork library, enables containers and Swarm services to locate each other by name, provided they are on the same network. This process leverages an embedded Docker DNS server for name resolution, facilitating seamless communication among containerized applications.

#### Diagram Explanation: DNS Resolution Process

![[5.11. Diagram showing DNS resolution process for container c1 pinging c2.png]]

This diagram illustrates the step-by-step process when container "c1" issues a `ping c2` command. It includes:
- A DNS server (represented by the Docker logo) maintaining IP mappings.
- The local resolver within "c1" initiating the query.
- Arrows numbered 1 to 5, depicting the flow from the ping command to the DNS query and final ping request to "c2".

#### Step-by-Step Process of DNS Resolution

1. **Issuing the Ping Command**: The "c1" container executes `ping c2`. Its local DNS resolver first checks its cache for "c2"’s IP address. All Docker containers are equipped with this local resolver, acting like a quick memory check.
2. **Recursive Query to Docker DNS**: If the local resolver lacks the IP, it sends a recursive query to the embedded Docker DNS server, which all containers are pre-configured to access.
3. **DNS Server Response**: The Docker DNS server, which records name-to-IP mappings for containers created with the `--name` or `--net-alias` flags, provides "c2"’s IP address to the local resolver.
4. **IP Address Return**: The DNS server returns "c2"’s IP to "c1"’s local resolver. This step fails if "c1" and "c2" are on different networks, as name resolution is network-scoped.
5. **Ping Request Sent**: "c1" sends an ICMP echo request to "c2"’s IP, enabling communication.

![[5.11. Service Discover Example.png]]

#### Automatic Registration and Configuration

Docker automatically registers each container’s name and IP with the embedded DNS service upon creation using the `--name` or `--net-alias` flags. It also configures every container to use this DNS service for converting names to IPs. This ensures seamless service discovery within the same network, a critical feature for container orchestration and communication.

#### Customizing DNS Settings

We can customize DNS settings using the following command:

```
docker run -it --name custom-dns \
  --dns=8.8.8.8 \
  --dns-search=nigelpoulton.com \
  alpine sh
```

- **`-it`**: Runs the container interactively with a terminal.
- **`--name custom-dns`**: Names the container "custom-dns" for easy identification.
- **`--dns=8.8.8.8`**: Specifies the Google DNS server (8.8.8.8) as the primary nameserver, overriding the default Docker DNS for external queries.
- **`--dns-search=nigelpoulton.com`**: Adds "nigelpoulton.com" as a search domain for unqualified names, aiding resolution of names like "service" to "service.nigelpoulton.com".
- **`alpine sh`**: Uses the Alpine Linux image and starts a shell.

After running this, we can inspect the container’s `/etc/resolv.conf` file with:

```
# cat /etc/resolv.conf
```

This file, generated by Docker, includes:
- `nameserver 8.8.8.8`: Indicates the custom DNS server.
- `search nigelpoulton.com`: Reflects the search domain.

The contents may vary if connected to a custom network, but the functionality remains consistent. Typing `exit` returns us to the local terminal.

#### Practical Example

Consider "c1" as a web server and "c2" as a database, both on the same Docker network. When "c1" pings "c2" to check connectivity, the Docker DNS resolves "c2"’s IP, enabling communication. Adding a custom DNS (e.g., 8.8.8.8) with `--dns` allows "c1" to reach external services, enhancing its functionality.

#### Conclusion and Considerations

Service discovery via Docker’s embedded DNS streamlines container communication within the same network, leveraging automatic registration and local resolution. Custom DNS settings enhance connectivity to external services, requiring careful configuration of `/etc/resolv.conf`. This approach ensures robust network management, though it is limited to same-network resolution unless supplemented with external DNS options.