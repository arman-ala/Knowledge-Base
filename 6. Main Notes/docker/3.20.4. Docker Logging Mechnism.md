## Understanding Docker Logging: Log Drivers, Options, and Analyzers

Let’s dive into Docker logging, a mechanism that helps us manage and access logs from our containers. We’ll explore log drivers, which control how logs are handled, discuss log options, and explain the two logging methods: blocking (direct) and non-blocking. We’ll also look at how to send logs to log analyzers like Graylog or Logstash, which are commonly used in organizations for centralized log management.

![[3.20.4_result_info.png]]

### What Are Docker Log Drivers?

Docker uses log drivers to manage how container logs (stdout and stderr) are captured, stored, and forwarded. Each container can be configured with a specific log driver, which determines where the logs are sent—whether to a file, a system logging service, or an external log management system. The default log driver in Docker Community Edition is `json-file`, but we can change this to suit our needs.

To check the current log driver for the Docker daemon, we can run:

```bash
docker info --format '{{.LoggingDriver}}'
```

This typically outputs `json-file`, confirming the default driver. We can change the default log driver by editing the Docker daemon configuration file at `/etc/docker/daemon.json`. For example, to set the default driver to `syslog`, we’d add:

```json
{
  "log-driver": "syslog"
}
```

After making this change, we’d need to restart the Docker daemon for it to take effect.

### Logging Methods: Blocking vs. Non-Blocking

Docker supports two methods for delivering log messages from containers to the log driver:

- **Blocking (Direct)**: This is the default method, where logs are sent directly from the container to the log driver. It ensures that no log messages are lost, but it can slow down the container if the log driver is slow to process messages (e.g., if the driver is writing to a remote system with high latency).
- **Non-Blocking**: In this mode, <mark style="background: #ADCCFFA6;">logs are stored in an intermediate per-container ring buffer, which the log driver consumes asynchronously. This prevents the container from being slowed down by the log driver, but if the buffer fills up, older messages are dropped to make room for new ones</mark>.

To configure non-blocking mode with a 4MB buffer, we can run a container like this:

```bash
docker run -it --name centos_log --log-opt mode=non-blocking --log-opt max-buffer-size=4m centos:latest
```

### Available Log Drivers in Docker Community Edition

Docker Community Edition supports several log drivers, each designed for different use cases. Below is a table listing all available log drivers, their descriptions, and example outputs when we run a container and generate logs.

![[3.20.4_result_log_driver.png]]

First, let’s run a container to generate some logs:

```bash
docker run -it --name centos_log --log-driver local centos:latest
```

Inside the container, we can generate a log message:

```bash
echo "Hello, Docker logging!" && exit
```

Now, let’s explore the log drivers and what their output looks like when we inspect the logs with `docker logs centos_log`.

| Driver       | Description                                                                                     | Example Output (from `docker logs centos_log`)                     |
|--------------|-------------------------------------------------------------------------------------------------|--------------------------------------------------------------------|
| `none`       | Disables logging for the container. No logs are stored or available.                            | No output (logs are disabled).                                     |
| `local`      | Stores logs in a custom format designed for minimal overhead, optimized for local storage.      | Binary format (not human-readable directly; requires parsing).     |
| `json-file`  | The default driver; stores logs in JSON format on the host filesystem.                          | `{"log":"Hello, Docker logging!\n","stream":"stdout","time":"2025-04-02T12:34:56.789Z"}` |
| `syslog`     | Sends logs to the system’s syslog facility. Requires a syslog daemon running on the host.       | `Apr  2 12:34:56 host centos_log[123]: Hello, Docker logging!`     |
| `journald`   | Sends logs to the systemd journal. Requires journald running on the host.                       | `MESSAGE=Hello, Docker logging! CONTAINER_NAME=centos_log`         |
| `gelf`       | Sends logs to a Graylog Extended Log Format (GELF) endpoint, like Graylog or Logstash.          | `{"version":"1.1","host":"centos_log","short_message":"Hello, Docker logging!","timestamp":1648725296}` |
| `fluentd`    | Sends logs to a Fluentd daemon (forward input). Requires Fluentd running on the host or network.| `{"container_name":"centos_log","message":"Hello, Docker logging!"}` |
| `awslogs`    | Sends logs to Amazon CloudWatch Logs. Requires AWS credentials and configuration.               | Logs appear in CloudWatch as: `Hello, Docker logging!`             |
| `splunk`     | Sends logs to Splunk using the HTTP Event Collector. Requires Splunk configuration.             | `event: {"message":"Hello, Docker logging!","container":"centos_log"}` |
| `etwlogs`    | Sends logs as Event Tracing for Windows (ETW) events. Only available on Windows platforms.      | Not applicable (Windows-only; no output on Linux).                 |
| `gcplogs`    | Sends logs to Google Cloud Platform (GCP) Logging. Requires GCP credentials.                    | Logs appear in GCP as: `Hello, Docker logging!`                    |
| `logentries` | Sends logs to Rapid7 Logentries (now part of InsightIDR). Requires a Logentries token.          | `Hello, Docker logging!` (formatted for Logentries).               |

**Insight**:
- The `json-file` driver stores logs in `/var/lib/docker/containers/<container_id>/<container_id>-json.log` on the host, as we discussed earlier.
- For drivers like `syslog`, `journald`, `fluentd`, and `gelf`, the corresponding daemon or service must be running and configured to receive logs.
- The `etwlogs` driver is Windows-specific and not available on Linux-based systems like the one running `centos:latest`.

### Configuring Log Options

Log drivers support various options to customize their behavior, which we can set in the `daemon.json` file or per-container using the `--log-opt` flag. For example, with the `json-file` driver, we can set options like:

```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3",
    "labels": "production,status",
    "env": "os,customer"
  }
}
```

- `max-size`: Limits the size of each log file (e.g., 10MB).
- `max-file`: Specifies the number of log files to keep before rotating (e.g., 3).
- `labels` and `env`: Include specific container labels or environment variables in the logs.

To apply these options to a specific container, we can run:

```bash
docker run -it --name centos_log --log-driver json-file --log-opt max-size=10m --log-opt max-file=3 centos:latest
```

**Insight**:
- Not all log drivers support the same options. For example, `syslog` supports options like `syslog-address` to specify the syslog server, while `awslogs` requires options like `awslogs-region` and `awslogs-stream`.
- We can check a container’s logging configuration with:
  ```bash
  docker inspect --format '{{.HostConfig.LogConfig.Type}}' centos_log
  ```
  This confirms the log driver (e.g., `json-file`).

#### Comprehensive Table of All `log-opts` Available for Docker Log Drivers

Docker’s logging system allows us to customize how logs are handled through the `--log-opt` flag, which sets options for the log driver. These options can be specified when running a container with `docker run` or globally in the Docker daemon configuration file (`/etc/docker/daemon.json`). The available `log-opts` depend on the log driver being used, as each driver supports a specific set of options. Below is a table covering all possible `log-opts` for the log drivers available in Docker Community Edition, along with their descriptions and the drivers they apply to.

##### Table of All `log-opts` for Docker Log Drivers

| Option Name                 | Description                                                                                     | Applicable Log Drivers                                                                                      | Example Usage                                         |
| --------------------------- | ----------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------- | ----------------------------------------------------- |
| `mode`                      | Sets the logging mode: `blocking` (direct, default) or `non-blocking` (uses a ring buffer).     | All drivers                                                                                                 | `--log-opt mode=non-blocking`                         |
| `max-buffer-size`           | Sets the size of the ring buffer for non-blocking mode (e.g., `4m` for 4MB).                    | All drivers (when `mode=non-blocking`)                                                                      | `--log-opt max-buffer-size=4m`                        |
| `max-size`                  | Limits the size of each log file before rotation (e.g., `10m` for 10MB).                        | `json-file`, `local`                                                                                        | `--log-opt max-size=10m`                              |
| `max-file`                  | Specifies the maximum number of log files to keep before rotating (e.g., `3`).                  | `json-file`, `local`                                                                                        | `--log-opt max-file=3`                                |
| `labels`                    | Includes specified container labels in the logs (comma-separated).                              | `json-file`, `local`, `syslog`, `journald`, `gelf`, `fluentd`, `awslogs`, `splunk`, `gcplogs`, `logentries` | `--log-opt labels=production,status`                  |
| `env`                       | Includes specified environment variables in the logs (comma-separated).                         | `json-file`, `local`, `syslog`, `journald`, `gelf`, `fluentd`, `awslogs`, `splunk`, `gcplogs`, `logentries` | `--log-opt env=os,customer`                           |
| `env-regex`                 | Includes environment variables matching a regex pattern in the logs.                            | `json-file`, `local`, `syslog`, `journald`, `gelf`, `fluentd`, `awslogs`, `splunk`, `gcplogs`, `logentries` | `--log-opt env-regex=^APP_`                           |
| `tag`                       | Customizes the log tag with container metadata (e.g., `{{.Name}}/{{.ID}}`).                     | `json-file`, `syslog`, `journald`, `gelf`, `fluentd`, `awslogs`, `splunk`, `gcplogs`, `logentries`          | `--log-opt tag="{{.ImageName}}/{{.Name}}/{{.ID}}"`    |
| `compress`                  | Enables (`true`) or disables (`false`) compression of rotated log files. Default: `true`.       | `json-file`, `local`                                                                                        | `--log-opt compress=false`                            |
| `syslog-address`            | Specifies the syslog server address (e.g., `udp://localhost:514` or `tcp://syslog-server:514`). | `syslog`                                                                                                    | `--log-opt syslog-address=udp://localhost:514`        |
| `syslog-facility`           | Sets the syslog facility (e.g., `local0`, `kern`).                                              | `syslog`                                                                                                    | `--log-opt syslog-facility=local0`                    |
| `syslog-tls-ca-cert`        | Path to the CA certificate for TLS-encrypted syslog connections.                                | `syslog`                                                                                                    | `--log-opt syslog-tls-ca-cert=/path/to/ca.pem`        |
| `syslog-tls-cert`           | Path to the client certificate for TLS-encrypted syslog connections.                            | `syslog`                                                                                                    | `--log-opt syslog-tls-cert=/path/to/cert.pem`         |
| `syslog-tls-key`            | Path to the client key for TLS-encrypted syslog connections.                                    | `syslog`                                                                                                    | `--log-opt syslog-tls-key=/path/to/key.pem`           |
| `syslog-tls-skip-verify`    | Skips TLS verification for syslog connections (`true` or `false`).                              | `syslog`                                                                                                    | `--log-opt syslog-tls-skip-verify=true`               |
| `gelf-address`              | Specifies the GELF server address (e.g., `udp://graylog:12201`).                                | `gelf`                                                                                                      | `--log-opt gelf-address=udp://graylog:12201`          |
| `gelf-compression-type`     | Sets the compression type for GELF messages (`gzip`, `zlib`, `none`). Default: `gzip`.          | `gelf`                                                                                                      | `--log-opt gelf-compression-type=none`                |
| `gelf-compression-level`    | Sets the compression level for GELF messages (0-9). Default: 1.                                 | `gelf`                                                                                                      | `--log-opt gelf-compression-level=6`                  |
| `fluentd-address`           | Specifies the Fluentd server address (e.g., `tcp://fluentd:24224`).                             | `fluentd`                                                                                                   | `--log-opt fluentd-address=tcp://fluentd:24224`       |
| `fluentd-async`             | Enables asynchronous connection to Fluentd (`true` or `false`). Default: `false`.               | `fluentd`                                                                                                   | `--log-opt fluentd-async=true`                        |
| `fluentd-buffer-limit`      | Sets the buffer limit for Fluentd messages (e.g., `1m` for 1MB).                                | `fluentd`                                                                                                   | `--log-opt fluentd-buffer-limit=1m`                   |
| `fluentd-retry-wait`        | Sets the initial wait time between retries for Fluentd (e.g., `1s`).                            | `fluentd`                                                                                                   | `--log-opt fluentd-retry-wait=1s`                     |
| `fluentd-max-retries`       | Sets the maximum number of retries for Fluentd connections.                                     | `fluentd`                                                                                                   | `--log-opt fluentd-max-retries=10`                    |
| `awslogs-region`            | Specifies the AWS region for CloudWatch Logs (e.g., `us-east-1`).                               | `awslogs`                                                                                                   | `--log-opt awslogs-region=us-east-1`                  |
| `awslogs-group`             | Specifies the CloudWatch Logs log group name.                                                   | `awslogs`                                                                                                   | `--log-opt awslogs-group=my-log-group`                |
| `awslogs-stream`            | Specifies the CloudWatch Logs log stream name.                                                  | `awslogs`                                                                                                   | `--log-opt awslogs-stream=my-log-stream`              |
| `awslogs-create-group`      | Automatically creates the log group if it doesn’t exist (`true` or `false`). Default: `false`.  | `awslogs`                                                                                                   | `--log-opt awslogs-create-group=true`                 |
| `awslogs-datetime-format`   | Specifies the datetime format for log timestamps (e.g., `%Y-%m-%dT%H:%M:%S`).                   | `awslogs`                                                                                                   | `--log-opt awslogs-datetime-format=%Y-%m-%dT%H:%M:%S` |
| `splunk-url`                | Specifies the Splunk HTTP Event Collector URL (e.g., `https://splunk:8088`).                    | `splunk`                                                                                                    | `--log-opt splunk-url=https://splunk:8088`            |
| `splunk-token`              | Specifies the Splunk HTTP Event Collector token.                                                | `splunk`                                                                                                    | `--log-opt splunk-token=your-splunk-token`            |
| `splunk-index`              | Specifies the Splunk index to store logs in.                                                    | `splunk`                                                                                                    | `--log-opt splunk-index=my-index`                     |
| `splunk-source`             | Sets the Splunk source field for logs.                                                          | `splunk`                                                                                                    | `--log-opt splunk-source=docker`                      |
| `splunk-sourcetype`         | Sets the Splunk sourcetype field for logs.                                                      | `splunk`                                                                                                    | `--log-opt splunk-sourcetype=docker_logs`             |
| `splunk-insecureskipverify` | Skips SSL verification for Splunk connections (`true` or `false`). Default: `false`.            | `splunk`                                                                                                    | `--log-opt splunk-insecureskipverify=true`            |
| `gcplogs-project`           | Specifies the GCP project ID for logging.                                                       | `gcplogs`                                                                                                   | `--log-opt gcplogs-project=my-gcp-project`            |
| `gcplogs-log`               | Specifies the log ID for GCP Logging.                                                           | `gcplogs`                                                                                                   | `--log-opt gcplogs-log=my-log`                        |
| `logentries-token`          | Specifies the Logentries token for sending logs.                                                | `logentries`                                                                                                | `--log-opt logentries-token=your-logentries-token`    |

### Additional Insights

- **Driver-Specific Options**: Not all `log-opts` are supported by every log driver. For example, `max-size` and `max-file` are specific to `json-file` and `local`, while `awslogs-region` is only for `awslogs`. Always check the Docker documentation for the specific driver you’re using to ensure compatibility.
- **Global Configuration**: We can set `log-opts` globally in `/etc/docker/daemon.json` to apply to all containers. For example:
```json
{
	"log-driver": "json-file",
    "log-opts": {
	    "max-size": "10m",
	    "max-file": "3"
    }
}
```
  This ensures all containers use the `json-file` driver with the specified options unless overridden.
- **Non-Blocking Mode**: The `mode=non-blocking` and `max-buffer-size` options are critical for high-throughput applications where we don’t want logging to slow down the container. However, we must monitor the buffer size to avoid losing logs if the buffer fills up.
- **Security Considerations**: For drivers like `syslog`, `splunk`, and `gelf`, options related to TLS (e.g., `syslog-tls-cert`, `splunk-insecureskipverify`) ensure secure log transmission. Always use secure connections when sending logs to external systems.
- **Custom Tags**: The `tag` option (as discussed in a previous query) allows us to add metadata to logs, which is especially useful for drivers like `syslog` or `gelf` when integrating with log analyzers like Graylog or ELK Stack.

This table provides a complete reference for customizing Docker logging behavior, ensuring we can tailor log management to our specific needs.

### Popular Log Analyzers and Their Use Cases

In many organizations, we use log analyzers to centralize, process, and analyze logs from multiple containers. These tools help us monitor, troubleshoot, and gain insights from our containerized applications. Below is a table of popular log analyzers, their descriptions, and where they’re typically used.

| Log Analyzer   | Description                                                                                     | Use Case                                                                                     |
|----------------|-------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------|
| Graylog        | A centralized log management platform that supports GELF and other formats.                     | Ideal for organizations needing a scalable log management solution with powerful search and alerting capabilities. |
| Logstash       | Part of the ELK Stack, Logstash collects, processes, and forwards logs to Elasticsearch.         | Best for integrating with Elasticsearch and Kibana for log visualization and analysis in large-scale environments. |
| Fluentd        | A flexible log collector that unifies log collection and forwarding, often used with Kubernetes. | Commonly used in cloud-native environments for aggregating logs from multiple sources.       |
| Splunk         | A robust log analysis platform that supports advanced searching, monitoring, and visualization. | Preferred in enterprise settings for security monitoring, IT operations, and compliance.     |
| ELK Stack      | Combines Elasticsearch, Logstash, and Kibana for log storage, processing, and visualization.    | Widely used for centralized logging in DevOps, with Kibana dashboards for real-time insights.|
| Datadog        | A monitoring and analytics platform that includes log management and integrates with APM.        | Great for teams needing unified monitoring of logs, metrics, and traces in cloud environments. |

**Insight**:
- To send logs directly to a log analyzer like Graylog (using GELF) or Logstash (via Fluentd), we can configure the log driver accordingly. For example:
  ```bash
  docker run -it --name centos_log --log-driver gelf --log-opt gelf-address=udp://graylog-server:12201 centos:latest
  ```
  This sends logs to a Graylog server at the specified address.
- For the ELK Stack, we might use the `fluentd` driver to forward logs to Logstash, which then sends them to Elasticsearch for indexing and visualization in Kibana.

### Additional Notes

- **Performance Considerations**: The non-blocking mode is useful for high-throughput applications where we don’t want logging to slow down the container. However, we need to monitor the buffer size to avoid losing logs.
- **Security**: When sending logs to external systems (e.g., AWS CloudWatch or Splunk), ensure that network connections are secure (e.g., using TLS) and that credentials are properly managed.
- **Log Rotation**: For the `json-file` driver, setting `max-size` and `max-file` prevents log files from growing indefinitely, which is crucial for managing disk space on the host.