# 3.7.1. Limited Containers in the Context of Resource

2025-08-09 10:49
Status: #DONE
Tags: [[Docker]]

---

## Managing Docker Container Resources: Setting Limits for Memory and CPU

When you spin up a Docker container, it gets access to all the resources on your host system by default—like RAM, CPU, and more. This can be a problem if one container hogs everything, leaving nothing for others! To keep things fair and efficient, we can set limits on these resources, ensuring each container plays nicely. Let’s walk through how to do this, starting with checking your system’s available resources, then setting memory and CPU limits for your containers.

#### Checking Available Resources with `free -mh`

First, let’s see how much memory and swap space is available on your system. The `free -mh` command gives you a quick snapshot in a human-readable format (that’s what the `-h` flag does—it shows sizes in GiB or MiB instead of raw bytes). Here’s the output from the image:

```
arman@Docker:~$ free -mh
```
![[3.7.1_result_free.png]]

Let’s break this down:
- **Mem (Memory)**:
  - **total: 1.6Gi**: Your system has 1.6 GiB of RAM in total. This is on the lower side for a system running Docker, so you’ll want to be careful with resource allocation.
  - **used: 1.2Gi**: 1.2 GiB of RAM is currently in use by running processes (including Docker containers).
  - **free: 791Mi**: 791 MiB of RAM is free and ready to be used.
  - **shared: 12Mi**: 12 MiB of RAM is shared between processes (e.g., shared memory segments).
  - **buff/cache: 557Mi**: 557 MiB is used by buffers and cache—temporary storage that the system uses to speed things up. This can be reclaimed if needed.
  - **available: 468Mi**: 468 MiB is the amount of RAM the system estimates is actually available for new processes, accounting for what can be freed from buffers/cache.
- **Swap**:
  - **total: 2.0Gi**: Your system has 2.0 GiB of swap space, which acts as a backup when RAM runs out.
  - **used: 173Mi**: 173 MiB of swap is currently in use.
  - **free: 1.8Gi**: 1.8 GiB of swap is still free.

This output tells us we have limited RAM (only 468 MiB available), so setting memory limits for our containers is a smart move to avoid overloading the system.

#### Setting Memory Limits for Containers

Docker lets you restrict how much memory a container can use with the `-m` (or `--memory`) flag in the `docker run` command. You can also control swap usage with the `--memory-swap` flag. Let’s go through a few examples using a CentOS container.

**Limit Memory Only (No Swap Restriction)**  
Here, we’ll limit the container’s memory to 150 MiB, but allow it to use as much swap as it wants:

```bash
docker run -itd --name limited_centos1 -m 150M centos:centos7.9.2009
```

This command creates a container named "limited_centos1" based on the `centos:centos7.9.2009` image. The `-m 150M` flag means the container can use up to 150 MiB of RAM. Since we didn’t specify `--memory-swap`, the container can still access the host’s swap space if it exceeds the 150 MiB RAM limit, up to the system’s available swap (1.8 GiB in our case).

**Limit Memory, Allow Unlimited Swap**  
To explicitly allow unlimited swap while limiting RAM, we can set `--memory-swap` to `-1`:

```bash
docker run -itd --name limited_centos2 -m 150M --memory-swap -1 centos:centos7.9.2009
```

Here, "limited_centos2" is restricted to 150 MiB of RAM, but `--memory-swap -1` means it can use as much swap as the host has available (up to 1.8 GiB free swap in our system). This is useful if you want the container to have a safety net for memory overflow without a hard cap on swap.

**Limit Both Memory and Swap**  
Now, let’s limit both RAM and swap for the container:

```bash
docker run -itd --name limited_centos3 -m 150M --memory-swap 1G centos:centos7.9.2009
```

In this case, "limited_centos3" gets 150 MiB of RAM (via `-m 150M`). The `--memory-swap 1G` flag sets the total memory (RAM + swap) the container can use to 1 GiB. Here’s the key part: the swap limit isn’t 1 GiB by itself—it’s the *total* of RAM + swap. So, the container’s swap limit is 1 GiB - 150 MiB = 850 MiB. This means the container can use 150 MiB of RAM and up to 850 MiB of swap, for a total of 1 GiB.

#### What Happens When a Container Exceeds Its Memory and Swap Limits?

If a container tries to use more memory than its allocated limit (e.g., 150 MiB for "limited_centos3"), Docker steps in, thanks to Linux cgroups, which enforce these limits. Here’s what happens:
- **Exceeds RAM Limit (150 MiB)**: If the container needs more than 150 MiB of RAM, it will start using swap space (if swap is allowed). In the case of "limited_centos3", it can use up to 850 MiB of swap. The container’s processes will slow down because swap is much slower than RAM—it’s stored on disk, not in memory.
- **Exceeds Swap Limit (850 MiB)**: If the container uses all 850 MiB of swap (reaching the 1 GiB total limit), it can’t allocate any more memory. At this point, the Linux kernel’s Out-Of-Memory (OOM) killer kicks in. The OOM killer will terminate the container’s processes to free up memory, effectively crashing the container. You might see an error in the container logs indicating it was killed due to memory constraints.
- **No Swap Available**: If swap is disabled (e.g., `--memory-swap 150M`, matching the RAM limit), the container can’t use swap at all. If it exceeds 150 MiB of RAM, the OOM killer will step in immediately and terminate the container.

This behavior ensures your host system doesn’t crash due to one container’s memory overuse, but it means you need to set realistic limits based on your application’s needs and your system’s resources.

#### Setting CPU Limits for Containers

Docker also lets you restrict CPU usage for containers, which is handy for ensuring no single container monopolizes your CPU cores. Unlike VMware, which virtualizes CPUs and abstracts them for virtual machines, Docker containers run as regular Linux processes on the host. This means they have direct access to the host’s CPU cores, and you can assign specific cores to a container using the `--cpuset-cpus` flag. Let’s look at a few examples.

**Restrict to Specific CPU Cores (Cores 0 and 1)**  
Here, we’ll limit the container to use only CPU cores 0 and 1:

```bash
docker run -itd --name limited_centos4 --cpuset-cpus="0,1" centos:centos7.9.2009
```

This command tells Docker to run "limited_centos3" and restrict it to CPU cores 0 and 1. If your system has, say, 4 cores (0, 1, 2, 3), this container can only use two of them, leaving the others free for other containers or processes.

**Restrict to a Single CPU Core (Core 0)**  
Now, let’s limit the container to just core 0:

```bash
docker run -itd --name limited_centos5 --cpuset-cpus="0" centos:centos7.9.2009
```

Here, "limited_centos3" is restricted to CPU core 0 only. This means all its processes will run on that single core, which can help if you want to isolate workloads.

**Restrict to a Range of CPU Cores (Cores 0 to 5)**  
Finally, let’s assign a range of cores, from 0 to 5:

```bash
docker run -itd --name limited_centos6 --cpuset-cpus="0-5" centos:centos7.9.2009
```

This command allows "limited_centos3" to use CPU cores 0 through 5 (a total of 6 cores). If your system has fewer cores than this range (e.g., only 4 cores), Docker will use the available cores within the range (0 to 3 in that case).

**Docker vs. VMware: CPU Access**  
Unlike VMware, which creates virtual CPUs for virtual machines (abstracting the physical CPU and often oversubscribing resources), Docker containers share the host’s CPU directly. In VMware, a virtual machine might think it has 4 virtual CPUs, but those are mapped to physical cores based on the hypervisor’s scheduling, which can lead to performance overhead. In Docker, there’s no such abstraction—containers are just isolated processes on the host, so when you assign cores with `--cpuset-cpus`, you’re giving the container direct access to those physical cores. You can even share a single core across multiple containers, and Docker will schedule their processes on that core, splitting the CPU time between them based on demand.

#### Sharing a CPU Core Between Containers
Docker allows you to assign the same CPU core to multiple containers. For example, if you run two containers and assign both to core 0 (using `--cpuset-cpus="0"`), they’ll share that core. The Linux kernel’s scheduler will divide the core’s time between the containers’ processes, ensuring they both get a fair share. You can fine-tune this further with flags like `--cpu-shares` or `--cpu-quota` to prioritize one container over another, but `--cpuset-cpus` is great for isolating workloads to specific cores.

#### Understanding the Difference Between Memory and Swap

**What is Memory (RAM)?**  
Memory, or RAM (Random Access Memory), is the fast, temporary storage your system uses to run applications and processes. When a container runs, it loads its data and code into RAM for quick access. For example, if "limited_centos3" is running a web server, its application code, runtime data, and temporary variables are stored in RAM (up to the 150 MiB limit we set). RAM is super fast because it’s physically located on memory chips close to the CPU, but it’s limited in size (1.6 GiB total in our system) and volatile—data in RAM disappears when the system shuts down.

**What is Swap?**  
Swap is a space on your disk (usually a dedicated partition or file) that acts as a backup for RAM. When your system runs out of RAM, it moves less frequently used data from RAM to swap, freeing up RAM for other tasks. In our example, the system has 2.0 GiB of swap, with 173 MiB in use. Swap is much slower than RAM because it’s on disk (HDD or SSD), which has higher latency and lower throughput. For "limited_centos3", if it exceeds its 150 MiB RAM limit, it can use up to 850 MiB of swap (as we set with `--memory-swap 1G`), but this will slow down performance because accessing swap involves disk I/O.

**Key Differences and Performance Impact**  
- **Speed**: RAM is lightning-fast (nanoseconds to access), while swap is much slower (milliseconds for SSD, even slower for HDD). A container using swap will experience noticeable performance degradation—think slower response times for a web server.
- **Purpose**: RAM is for active, frequently accessed data (like a web server’s in-memory cache). Swap is a fallback for when RAM is full, storing less urgent data (like inactive pages of a process).
- **Persistence**: RAM is volatile (data is lost on shutdown), while swap is on disk and can persist (though it’s typically cleared on reboot).
- **Impact on Containers**: If a container relies heavily on swap, its performance will suffer, and if it exhausts both RAM and swap, it’ll crash (as explained earlier). For best performance, you want your container to stay within its RAM limit and avoid swap usage altogether.

---

Let’s take the table and examples from the previous response and reformat the commands into the requested Bash code block format (```bash ... ```) without changing any sentence. I’ll preserve the table structure and descriptions exactly as they were, only updating the example commands to use the specified format.

---

## Table of `docker run` RAM, CPU, and Swap Limit Flags

| **Flag**               | **Category** | **Description**                                                                                                               | **Example Command**                                                                                       |
| ---------------------- | ------------ | ----------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------- |
| `--cpus`               | CPU          | Limits the number of CPU cores the container can use (e.g., `1.5` means 1.5 cores).                                           | docker run --cpus="1.5" --name limited_cpu1 centos:centos7.9.2009                                         |
| `--cpu-shares`         | CPU          | Sets the relative CPU priority (weight) for the container (default is 1024). Lower values mean less priority.                 | docker run --cpu-shares=512 --name limited_cpuShares2 centos:centos7.9.2009                               |
| `--cpu-quota`          | CPU          | Limits the CPU time (in microseconds) the container can use within a period (used with `--cpu-period`).                       | docker run --cpu-quota=50000 --cpu-period=100000 --name limited_cpuQuota3 centos:centos7.9.2009           |
| `--cpu-period`         | CPU          | Defines the time period (in microseconds) for the CPU quota (default is 100,000). Used with `--cpu-quota`.                    | (Included in the `--cpu-quota` example above: `limited_cpuQuota3`)                                        |
| `--cpuset-cpus`        | CPU          | Specifies which CPU cores the container can use (e.g., `0-1` means cores 0 and 1).                                            | docker run --cpuset-cpus="0-1" --name limited_cpuSet4 centos:centos7.9.2009                               |
| `--memory` (`-m`)      | RAM          | Sets the maximum amount of memory the container can use (e.g., `512m` for 512 MB).                                            | docker run --memory="512m" --name limited_ram1 centos:centos7.9.2009                                      |
| `--memory-reservation` | RAM          | Sets a soft memory limit (lower than `--memory`). The container can exceed this but may be constrained under memory pressure. | docker run --memory="1g" --memory-reservation="512m" --name limited_ramReservation2 centos:centos7.9.2009 |
| `--memory-swap`        | Swap         | Sets the total amount of memory + swap the container can use. If unset, swap is 2x the `--memory` limit.                      | docker run --memory="512m" --memory-swap="1g" --name limited_ramSwap3 centos:centos7.9.2009               |
| `--memory-swappiness`  | Swap         | Controls the tendency of the container to use swap (0 to 100; 0 disables swap, 100 maximizes swap usage).                     | docker run --memory="512m" --memory-swappiness=0 --name limited_swapiness4 centos:centos7.9.2009          |
| `--oom-kill-disable`   | RAM/Swap     | Disables the Out-Of-Memory (OOM) killer for the container (use with caution; requires `--memory` to be set).                  | docker run --memory="512m" --oom-kill-disable --name limited_oomKill5 centos:centos7.9.2009               |

---

### Explanation of Each Flag and Example

#### CPU-Related Flags
1. **`--cpus`**:
   - **What it does**: Limits the container to a specific number of CPU cores. For example, `--cpus="1.5"` means the container can use up to 1.5 cores.
   - **Example**:
```bash
docker run --cpus="1.5" --name limited_cpu1 centos:centos7.9.2009
```

- This container, named `limited_cpu1`, can use up to 1.5 CPU cores. If the host has 4 cores, this container’s CPU usage in `docker stats` will be capped at 150%.

2. **`--cpu-shares`**:
   - **What it does**: Sets the relative priority of CPU usage. The default is 1024; a lower value like 512 means the container gets less CPU time when there’s contention.
   - **Example**:
```bash
docker run --cpu-shares=512 --name limited_cpuShares2 centos:centos7.9.2009
```

- The container `limited_cpuShares2` has half the CPU priority of a container with the default shares (1024). It can still use more CPU if there’s no contention, but it’ll get less when other containers are busy.

3. **`--cpu-quota` and `--cpu-period`**:
   - **What they do**: `--cpu-quota` sets the maximum CPU time (in microseconds) the container can use in a given `--cpu-period` (also in microseconds). Together, they enforce a hard CPU limit.
   - **Example**:
```bash
docker run --cpu-quota=50000 --cpu-period=100000 --name limited_cpuQuota3 centos:centos7.9.2009
```

- The container `limited_cpuQuota3` can use 50,000 microseconds of CPU time every 100,000 microseconds, effectively limiting it to 50% of one core.

4. **`--cpuset-cpus`**:
   - **What it does**: Restricts the container to specific CPU cores. For example, `0-1` means it can only use cores 0 and 1.
   - **Example**:
```bash
docker run --cpuset-cpus="0-1" --name limited_cpuSet4 centos:centos7.9.2009
```

- The container `limited_cpuSet4` is pinned to CPU cores 0 and 1. If the host has 4 cores, this container can’t use cores 2 or 3, even if they’re idle.

#### RAM-Related Flags
5. **`--memory` (`-m`)**:
   - **What it does**: Sets a hard limit on the amount of RAM the container can use. Units can be `b` (bytes), `k` (kilobytes), `m` (megabytes), or `g` (gigabytes).
   - **Example**:
```bash
docker run --memory="512m" --name limited_ram1 centos:centos7.9.2009
```

- The container `limited_ram1` is limited to 512 MB of RAM. If it tries to use more, the system will start swapping (if swap is enabled) or kill the container if it exceeds the limit.

6. **`--memory-reservation`**:
   - **What it does**: Sets a soft memory limit, which is lower than the `--memory` limit. The container can exceed this under normal conditions but may be constrained when the host is under memory pressure.
   - **Example**:
```bash
docker run --memory="1g" --memory-reservation="512m" --name limited_ramReservation2 centos:centos7.9.2009
```
   
   - The container `limited_ramReservation2` has a hard limit of 1 GB but a soft limit of 512 MB. It can use up to 1 GB if the host has enough memory, but under pressure, Docker will try to keep it closer to 512 MB.

#### Swap-Related Flags
7. **`--memory-swap`**:
   - **What it does**: Sets the total amount of memory + swap the container can use. If `--memory` is 512 MB and `--memory-swap` is 1 GB, the container can use 512 MB of swap in addition to 512 MB of RAM.
   - **Example**:
```bash
docker run --memory="512m" --memory-swap="1g" --name limited_ramSwap3 centos:centos7.9.2009
```

- The container `limited_ramSwap3` can use 512 MB of RAM and an additional 512 MB of swap (since 1 GB total - 512 MB RAM = 512 MB swap).

8. **`--memory-swappiness`**:
   - **What it does**: Controls how likely the container is to use swap memory. A value of 0 disables swap, while 100 makes the container more likely to swap.
   - **Example**:
```bash
docker run --memory="512m" --memory-swappiness=0 --name limited_swapiness4 centos:centos7.9.2009
```

- The container `limited_swapiness4` has swap disabled (`--memory-swappiness=0`), so it can only use its 512 MB of RAM and won’t swap, even if swap is available on the host.

#### RAM/Swap-Related Flag
9. **`--oom-kill-disable`**:
   - **What it does**: Disables the Out-Of-Memory (OOM) killer for the container, meaning the system won’t kill the container if it exceeds its memory limit. This requires `--memory` to be set and should be used carefully.
   - **Example**:
```bash
docker run --memory="512m" --oom-kill-disable --name limited_oomKill5 centos:centos7.9.2009
```

- The container `limited_oomKill5` won’t be killed if it exceeds its 512 MB memory limit, but this could cause the host to run out of memory and affect other processes.

---

### Notes
- **Units for Memory Flags**: For `--memory`, `--memory-swap`, and `--memory-reservation`, you can use `b` (bytes), `k` (kilobytes), `m` (megabytes), or `g` (gigabytes). For example, `512m` is 512 megabytes, and `1g` is 1 gigabyte.
- **Swap Behavior**: If `--memory-swap` is not set, Docker allows the container to use up to 2x the `--memory` limit as swap (e.g., if `--memory="512m"`, the container can use 1 GB of swap by default, unless restricted).
- **Host Requirements**: Some flags, like `--memory-swap` and `--memory-swappiness`, require the host to have swap enabled. If swap is disabled on the host, these settings won’t have any effect.

