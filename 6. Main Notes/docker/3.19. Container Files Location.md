## Exploring Where Docker Stores Files Copied to a Container

Let’s take a closer look at where Docker stores files when you copy them from the Docker host to a container, or when you create new files inside a container. We’ll navigate through Docker’s storage directories, examine the `centos_bash` container from your setup, and see where the new files you created are stored on the host filesystem. I’ll also add some insights about Docker’s storage layers and how they work.

### Navigating Docker’s Storage Directory: `/var/lib/docker`

The `/var/lib/docker` directory is the heart of Docker’s storage on the host system. As you’ve noted, this directory contains everything related to Docker’s operations, including container data, images, volumes, and more. Let’s break down what you did and explore the specific location of the files.

**Listing `/var/lib/docker`**:
In your output, you ran:

```bash
sudo ls -l /var/lib/docker
```

This shows the contents of `/var/lib/docker`, including directories like `containers`, `overlay2`, `plugins`, `volumes`, and more. These directories store different aspects of Docker’s data:
- `containers`: Stores metadata and configuration for each container, including the container’s filesystem changes.
- `overlay2`: The default storage driver on most modern Docker installations (as indicated by your output), which manages the container’s filesystem layers.
- `volumes`: Stores data for Docker volumes.
- `buildkit`, `engine-id`, `network`, etc.: Other components related to Docker’s build system, networking, and runtime.

### Understanding Container Metadata with `docker inspect`

![[3.18.1_img-1_1.png]]

You mentioned that in a previous output, you explored the contents of `/var/lib/docker/containers/<container_id>`. This directory contains metadata for each container, such as its configuration, logs, and runtime state. When you run `docker inspect <container_id>`, Docker pulls the information from this directory. For example, for the `centos_bash` container (ID `7d1539239d41`), the metadata would be in:

```
/var/lib/docker/containers/7d1539239d41
```

This directory includes files like:
- `config.v2.json`: The container’s configuration (e.g., its command, environment variables, mounts).
- `<container_id>-json.log`: The container’s logs (stdout/stderr).
- `hostconfig.json`: Host-specific configuration (e.g., port mappings, resource limits).

**Insight**:  
The `docker inspect` command is a powerful way to debug containers because it gives you a detailed view of this metadata. For example, running `docker inspect centos_bash` would show you the container’s `Path` (`/bin/bash`), its `State` (e.g., `Running`), and its filesystem details.

### Locating Files Copied to or Created in a Container

Now, let’s focus on where Docker stores the actual files for a container, especially when you copy files from the host or create new ones inside the container. You started the `centos_bash` container and created some files inside it:

#### Starting the Container and Creating Files
You ran:

```bash
docker start -ai centos_bash
```

- This starts the `centos_bash` container (ID `7d1539239d41`) and attaches your terminal to its stdin, stdout, and stderr (`-ai`).
- Inside the container, you navigated to the `/home` directory and created three files:

```bash
cd /home
touch container_file
echo hello > container_file_2.txt
echo bye > container_file_3.txt
ls -l
```

**Output**:
```
total 8
-rw-r--r--. 1 root root 0 Mar 31 09:16 container_file
-rw-r--r--. 1 root root 6 Mar 31 09:36 container_file_2.txt
-rw-r--r--. 1 root root 4 Mar 31 09:36 container_file_3.txt
```
- `container_file`: An empty file created with `touch`.
- `container_file_2.txt`: Contains the text `hello` (6 bytes, including the newline).
- `container_file_3.txt`: Contains the text `bye` (4 bytes, including the newline).
- All files are owned by `root` (UID 0, GID 0) because the container runs as the `root` user by default.

#### Where Are These Files Stored on the Host?

![[3.18.1_img-2.png]]

Docker uses a storage driver to manage container filesystems, and your system is using the `overlay2` storage driver (as seen in `/var/lib/docker/overlay2`). The `overlay2` driver uses a layered filesystem to store changes made to a container, such as new or modified files.

To find the files you created, you navigated to:

```
/var/lib/docker/overlay2/<layer_id>/diff/home
```

**How to Find the Right `layer_id`**:  
- The `overlay2` directory contains subdirectories for each layer in Docker’s storage. Each running container has a unique layer where its filesystem changes (like new files) are stored.
- To find the specific layer for `centos_bash`, you can look at the container’s metadata. Run:
  ```bash
  docker inspect centos_bash
  ```
  Look for the `GraphDriver` section in the output, which will include a `LowerDir` and `UpperDir`. The `UpperDir` points to the container’s writable layer, typically something like `/var/lib/docker/overlay2/<layer_id>/diff`.
- In your output, you navigated to `/var/lib/docker/overlay2/<container_id>/diff/home`, but note that `<container_id>` here is a bit of a misnomer—it’s actually the layer ID, not the container ID. The layer ID can be found in the `docker inspect` output under `GraphDriver.Data.UpperDir`. For simplicity, let’s assume the layer ID for `centos_bash` is `1ba5d7f164b01ae74e38bb834f1800328427be376f3667c9254cedf9216cf4a` (one of the layer IDs from your `ls -l /var/lib/docker/overlay2` output).

So, the actual path to the `/home` directory’s contents for `centos_bash` would be:

```
/var/lib/docker/overlay2/1ba5d7f164b01ae74e38bb834f1800328427be376f3667c9254cedf9216cf4a/diff/home
```

**Listing the Files on the Host**:
You ran:

```bash
sudo ls -l /var/lib/docker/overlay2/1ba5d7f164b01ae74e38bb834f1800328427be376f3667c9254cedf9216cf4a/diff/home
```

This would show the same files you created inside the container:
- `container_file`
- `container_file_2.txt`
- `container_file_3.txt`

The ownership and permissions would match what you saw inside the container (`root:root`, `rw-r--r--`), but the UID/GID might appear differently on the host if user namespaces are enabled (more on that below).

#### Understanding the `overlay2` Storage Driver
The `overlay2` storage driver uses a layered filesystem:
- **Lower Layers**: These are read-only layers from the image (e.g., `centos:latest`). They’re stored in `/var/lib/docker/overlay2/<image_layer_id>`.
- **Upper Layer**: This is the writable layer for the container, stored in `/var/lib/docker/overlay2/<layer_id>/diff`. Any changes you make to the container’s filesystem (like creating `container_file`) are stored here.
- **Merged Layer**: The container’s runtime filesystem is a merged view of the lower and upper layers, stored in `/var/lib/docker/overlay2/<layer_id>/merged`. When you run `ls /home` inside the container, you’re seeing the contents of `/var/lib/docker/overlay2/<layer_id>/merged/home`.

**Insight**:  
If you copy a file from the host to the container using `docker cp` (e.g., `docker cp host_file.txt centos_bash:/home/host_file.txt`), that file will also appear in the same `/var/lib/docker/overlay2/<layer_id>/diff/home` directory on the host. This is because `docker cp` modifies the container’s writable layer.

#### Additional Insight: `/etc/resolv.conf` and Other Files
Your output also shows a file in `/var/lib/docker/overlay2/<layer_id>` named `l`, which contains `/etc/resolv.conf`. This file is a special case:
- Docker manages `/etc/resolv.conf` inside the container to configure DNS settings (e.g., using the host’s DNS servers or custom ones specified with `--dns`).
- The `l` file in the `overlay2` directory is a link or placeholder that Docker uses to manage this file. The comment in your output (`# Based on host file: '/etc/resolv.conf' (LEGACY)`) indicates that this is a legacy behavior, as modern Docker versions handle DNS more dynamically.

**Practical Tip**:  
If you need to modify `/etc/resolv.conf` in a container, you can copy a custom version using `docker cp` or mount a custom file using a volume (`-v /path/to/resolv.conf:/etc/resolv.conf`). However, be cautious, as changing DNS settings can affect the container’s ability to resolve domain names.

