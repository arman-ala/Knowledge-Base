## Exploring Docker Log Tags with `--log-opt tag`

Docker allows us to customize log messages by adding tags, which provide additional context about the container generating the logs. These tags are specified using the `--log-opt tag` option when running a container. The image provides a list of markup variables that can be used in the tag, and we’ll expand on this by creating a comprehensive table that covers all possible variables for `--log-opt tag`, along with their descriptions.

### Understanding `--log-opt tag`

The `--log-opt tag` option lets us define a template for adding metadata to log messages. This is particularly useful when forwarding logs to external systems (e.g., `syslog`, `gelf`, or `fluentd`), as it helps identify the source of the logs. The variables in the tag are replaced with actual values from the container’s metadata at runtime.

The image shows an example of using `--log-opt tag`:

```bash
docker run -itd --name mynginx --log-opt tag="{{.ImageName}}/{{.Name}}/{{.ID}}" nginx
```

This command runs an `nginx` container named `mynginx` and sets a custom log tag format. The resulting log message includes the tag:

```
"tag":"nginx/nginx3/8e19f1fafdd"
```

- `nginx` (from `{{.ImageName}}`): The name of the image.
- `nginx3` (from `{{.Name}}`): The container’s name.
- `8e19f1fafdd` (from `{{.ID}}`): The first 12 characters of the container’s ID.

The log message is stored in `/var/lib/docker/containers/<container_id>/<container_id>-json.log`, and its full entry looks like:

```json
{"log":"docker-entrypoint.sh: Configuration complete; ready for start up\n","stream":"stdout","attrs":{"tag":"nginx/nginx3/8e19f1fafdd"},"time":"2020-12-05T08:05:06.550345051Z"}
```

### Table of All Possible Variables for `--log-opt tag`

Below is a table listing all possible variables that can be used with `--log-opt tag`, along with their descriptions. These variables are derived from the container’s metadata and can be combined in any format within the tag template.

| Variable            | Description                                                                                     |
|---------------------|-------------------------------------------------------------------------------------------------|
| `{{.ID}}`           | The first 12 characters of the container’s ID (e.g., `8e19f1fafdd` for a container ID starting with `8e19f1fafdd...`). |
| `{{.FullID}}`       | The full container ID (e.g., `8e19f1fafdd123456789...`).                                        |
| `{{.Name}}`         | The name of the container (e.g., `mynginx` or `nginx3` in the example).                         |
| `{{.ImageID}}`      | The first 12 characters of the image’s ID (e.g., `sha256:53a18edff809` for the `nginx` image).  |
| `{{.ImageFullID}}`  | The full image ID (e.g., `sha256:53a18edff809123456789...`).                                   |
| `{{.ImageName}}`    | The name of the image used by the container (e.g., `nginx` for the `nginx:latest` image).       |
| `{{.DaemonName}}`   | The name of the Docker daemon (e.g., `docker`). This is typically the string `"docker"`.        |

**Insight**:
- These variables are particularly useful when using log drivers like `syslog`, `gelf`, or `fluentd`, as they allow us to add context to log messages for better filtering and analysis in external log management systems.
- We can combine multiple variables in the tag template, separated by any delimiter (e.g., `/`, `-`, or `:`). For example, `--log-opt tag="{{.Name}}-{{.ImageName}}"` would produce a tag like `mynginx-nginx`.
- If a variable is not applicable (e.g., the container has no name), Docker will leave that part of the tag empty, which might result in a tag like `nginx//8e19f1fafdd` if `{{.Name}}` is empty.

### Additional Notes

- **Default Tag Behavior**: If we don’t specify a `--log-opt tag`, Docker uses a default tag format, which typically includes the container’s name and a portion of its ID. For example, with the `json-file` driver, the default tag might look like `mynginx.8e19f1fafdd`.
- **Log Driver Compatibility**: Not all log drivers support the `tag` option. For example, the `json-file` driver includes the tag in the `attrs` field of the log entry (as shown in the example), while `syslog` might prepend the tag to the log message. Drivers like `none` ignore tags entirely since they disable logging.
- **Use Case**: Custom tags are especially helpful in environments with many containers, as they allow us to quickly identify the source of a log message in a centralized logging system like Graylog or ELK Stack. For instance, a tag like `{{.ImageName}}/{{.Name}}` makes it easy to filter logs by image or container name.