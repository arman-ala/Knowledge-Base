# 3.8.2. Container Exceeds 100% CPU Usage

2025-08-09 10:49
Status: #DONE
Tags: [[Docker]]

---

# Container Exceeds 100% CPU Usage

Great question! Seeing a container's CPU usage go above 100% in `docker stats` can be a bit confusing at first, but it's actually a reflection of how Docker measures and reports CPU usage in relation to the host system and the container's configuration. Let's break this down in a human-friendly way.

### Why CPU Usage Can Exceed 100%
The CPU percentage shown in `docker stats` (under the `CPU %` column) represents the container's CPU usage relative to the total CPU resources available to it on the host machine. However, this percentage isn’t capped at 100% because it’s calculated based on the *total CPU capacity of the host* and how the container is utilizing it, especially in multi-core systems. Here are the key reasons why you might see CPU usage higher than 100%:

1. **Multi-Core Systems**:
   - On a multi-core system, the `CPU %` in `docker stats` is calculated as a percentage of *one CPU core*. If your host machine has multiple cores (say, 4 cores), the total CPU capacity is 400% (100% per core).
   - If a container is using more than one core’s worth of CPU, its usage will exceed 100%. For example, if a container uses 2 full cores on a 4-core system, `docker stats` will show its CPU usage as 200%.

2. **No CPU Limits by Default**:
   - By default, Docker containers have no CPU limits—they can use as much CPU as the host has available. If a container runs a CPU-intensive task (like a complex computation or a busy web server) and the host has multiple cores, the container can consume more than 100% of a single core’s capacity.
   - For example, if a container is running on a 4-core system and uses 3 cores fully, its CPU usage will be reported as 300%.

3. **CPU Shares and Limits**:
   - Docker allows you to set CPU limits or shares for containers using flags like `--cpus` or `--cpu-shares` when you run a container. If you set a limit (e.g., `--cpus="1.0"` to limit the container to 1 core), the CPU usage will be capped at 100% for that container. But if no limit is set, the container can use more than one core, leading to percentages above 100%.
   - CPU shares (set with `--cpu-shares`) don’t cap usage but instead define the relative priority of containers when there’s contention for CPU resources. A container with higher shares can still use more than 100% if there’s no hard limit.

4. **Hyper-Threading**:
   - Many modern CPUs use hyper-threading, which makes each physical core appear as two logical cores to the operating system. If your host has 4 physical cores with hyper-threading, the system sees 8 logical cores, and the total CPU capacity is 800%. A container using 2 logical cores would then show 200% CPU usage in `docker stats`.

5. **Bursty Workloads**:
   - Some workloads are bursty—they might spike in CPU usage for a short time. If a container suddenly starts a heavy task (like compiling code or processing a large dataset), it might use multiple cores at once, pushing the CPU usage well above 100% temporarily.

---

### Example Scenario
Let’s say you have a host with 4 cores (400% total CPU capacity). You run a container without any CPU limits, and it starts a multi-threaded application that fully utilizes 3 of those cores. In `docker stats`, the `CPU %` for that container will show as 300% because it’s using 3 out of the 4 available cores. If you had limited the container to 1 core (using `--cpus="1.0"`), its usage would max out at 100%, even if the application tried to use more.

---

### How Docker Calculates CPU %
Docker calculates the CPU percentage by comparing the container’s CPU usage to the total CPU time available on the host over a short time interval (usually 1 second, since `docker stats` updates every second). The formula is roughly:

\[
\text{CPU %} = \left( \frac{\text{CPU time used by the container}}{\text{Time interval} \times \text{Number of cores}} \right) \times 100
\]

- **CPU time used by the container**: This is the total CPU time the container has consumed, measured in nanoseconds, as reported by the Linux kernel’s cgroup (control group) system.
- **Time interval**: The period over which the usage is measured (e.g., 1 second).
- **Number of cores**: The number of CPU cores on the host.

If the container uses more CPU time than a single core can provide in that interval, the percentage will exceed 100%.

---

### How to Control CPU Usage
If you’re seeing CPU usage above 100% and it’s causing issues (like slowing down other containers or the host), you can control it using Docker’s resource management options:

- **Set a CPU Limit**:
  Use the `--cpus` flag when running a container to limit how many cores it can use. For example:
  ```
  docker run --cpus="1.5" my-image
  ```
  This limits the container to 1.5 cores, so its CPU usage in `docker stats` will never exceed 150%.

- **Set CPU Shares**:
  Use the `--cpu-shares` flag to set the relative priority of the container. For example:
  ```
  docker run --cpu-shares=512 my-image
  ```
  The default share is 1024, so setting it to 512 gives the container half the priority of others. This doesn’t cap usage but ensures fair sharing when there’s contention.

- **Use CPU Quotas**:
  Use `--cpu-quota` and `--cpu-period` to set a hard limit on CPU usage over a specific time period. For example:
  ```
  docker run --cpu-quota=50000 --cpu-period=100000 my-image
  ```
  This limits the container to 50,000 microseconds of CPU time every 100,000 microseconds (effectively 50% of one core).

---

### Why It’s Not a Problem (Usually)
Seeing CPU usage above 100% isn’t necessarily a bad thing—it just means the container is making good use of the host’s resources. As long as the host isn’t overloaded and other containers or processes aren’t being starved of CPU, this is normal behavior, especially for multi-threaded applications. However, if it’s causing performance issues, you can use the above methods to set limits.

---

### Relating to Your Image
In the `docker stats` output you shared, all containers are at 0.00% CPU usage, so none of them are exceeding 100%—they’re barely using any CPU at all. But if one of these containers (like `limit_centos1`) started a multi-threaded task and your host has, say, 4 cores, you might see its CPU usage jump to 200% or more if it uses 2 cores fully.
