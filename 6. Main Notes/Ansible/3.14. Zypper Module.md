# 3.14. Zypper Module

2025-08-14 05:17
Status: #DONE 
Tags: [[Ansible]]

---
## Understanding the Ansible Zypper Module: A Comprehensive Guide

In the landscape of DevOps automation, Ansible's extensibility through community collections allows for tailored package management across diverse Linux distributions. The `community.general.zypper` module provides robust support for handling packages on SUSE and openSUSE systems, leveraging the zypper tool and rpm for installations, updates, and removals. This module also accommodates transactional updates, ensuring atomic operations in environments like SUSE MicroOS. Below, we offer a simplified overview for foundational understanding, followed by a detailed analysis of its parameters, including all possible values and their effects, best practices, and illustrative examples with expected outputs. To address specific feedback, this expanded explanation includes in-depth clarifications of key concepts such as "vendor" in package management, "GPG" for signature verification, transactional updates, and other potentially complex topics like package types, conflict resolution, and error handling.

#### Simplified Explanation: Breaking It Down Simply

Picture the `zypper` module as a dedicated package handler for SUSE-based systems: it installs, updates, or removes software using zypper commands, replacing equivalents like apt or yum in other distros. You specify the package name, desired state (e.g., present or latest), and options like disabling GPG checks or forcing resolutions. For example, installing "nmap" is as simple as naming it and setting state to present, with zypper managing dependencies. It's efficient for bulk operations, supports patches and patterns, and can refresh repositories beforehand, making it a go-to for maintaining consistent environments on SUSE or openSUSE without manual CLI intervention.

A "vendor" in Linux package management refers to the organization or entity that builds, maintains, and distributes a software package, such as SUSE, openSUSE, or a third-party like Google for Chrome repositories. This ensures packages are sourced from trusted providers, but switching vendors (e.g., from SUSE to a community repo) can introduce compatibility risks, which is why options like allow_vendor_change exist to control this behavior.

GPG, or GNU Privacy Guard, is an open-source implementation of the OpenPGP standard used in Linux package management to digitally sign packages, verifying their authenticity and integrity to prevent tampering or malicious injections during installation. Disabling GPG checks bypasses this security layer, which is risky but sometimes necessary for unsigned or self-signed packages.

Transactional updates in SUSE Linux are a system management approach where changes (like package installations) are applied atomically in an isolated snapshot of the filesystem; if successful, the snapshot becomes the new active system, allowing easy rollbacks and maintaining immutability for stability in containerized or cloud environments. This differs from traditional updates by preventing partial failures and enabling reversion without data loss.

Other complex topics include:
- **Package types**: Beyond standard packages, zypper handles "patches" (security fixes), "patterns" (grouped packages for roles like "web server"), "products" (major components like base OS), and "srcpackages" (source code for building), allowing targeted management.
- **Conflict resolution**: When packages have incompatible requirements, zypper's resolver suggests solutions; force_resolution automates this, potentially choosing suboptimal paths but avoiding manual intervention.
- **Error handling**: Options like simple_errors simplify output for easier parsing in scripts, while skip_post_errors ignores non-fatal post-install issues, ensuring workflows continue.

#### In-Depth Analysis: Precise and Comprehensive Coverage

The `community.general.zypper` module, from the community.general collection (version 10.7.1), manages packages via zypper and rpm on SUSE and openSUSE. It supports states like present (install), absent (remove), latest (update), and dist-upgrade (full system upgrade), with options for types such as package, patch, or product. The module requires transactional updates by executing zypper within `/sbin/transactional-update`, ensuring reversible operations. These transactions create a read-only snapshot, apply changes in isolation, and activate the new snapshot only if all succeed, reducing downtime and enabling quick rollbacks via tools like `transactional-update rollback`.

Key behaviors include transactional transactional updates allowing vendor changes (switching package providers, which might affect support or compatibility), dependency cleaning (removing unused packages to optimize space), and extra arguments for customization. It processes packages individually in loops for safety, though passing lists to `name` is more efficient. The module emphasizes idempotency, only making changes when necessary, and can be tuned for recommends, GPG checks (verifying signatures to ensure package integrity using public keys), and error handling (e.g., simplified messages or skipping post-install failures).

The module excels in transactional transactional updates, where changes are atomic: either fully applied or discarded, preventing system inconsistencies common in non-transactional updates. Dist-upgrade differs from latest by performing a full distribution upgrade, potentially changing the OS version or architecture, while latest updates individual packages within the current distro.

Below, each parameter is analyzed, including its purpose, type, default value, all possible values and their effects, requirements, and interactions. Best practices, tips, and tricks are incorporated, with examples and expected outputs.

- **allow_vendor_change**: Enables vendor changes during dist-upgrade. Type: boolean. Default: false. Possible values: true (adds `--allow-vendor-change`, effect: permits packages from different vendors, useful for migrations but risks compatibility issues), false (no change, effect: restricts to current vendor, maintains consistency). Required: No. Notes: Added in 0.2.0; for state=dist-upgrade.

  Best practice: Use true only after testing for vendor-specific dependencies. Tip: Vendors like SUSE provide official support; switching to community repos may void warranties. Trick: Combine with `extra_args` for arch changes.

  Example: Allow vendor change.
  ```yaml
  - name: Dist-upgrade with vendor change
    community.general.zypper:
      name: '*'
      state: dist-upgrade
      allow_vendor_change: true
  ```
  Expected output: Upgrades allowing vendor shifts (`changed: true` if updates applied); return: `results` with updated packages, `rc: 0`.

- **clean_deps**: Cleans dependencies on removal. Type: boolean. Default: false. Possible values: true (adds `--clean-deps`, effect: removes unneeded dependencies, frees space and reduces clutter), false (removes only specified, effect: leaves orphans, which may consume resources). Required: No. Notes: Added in 4.6.0; for state=absent.

  Best practice: Use true for clean uninstalls to avoid accumulated unused packages. Tip: Check deps with `zypper info`; trick: Use with `disable_gpg_check` if needed.

  Example: Clean deps on remove.
  ```yaml
  - name: Remove with clean deps
    community.general.zypper:
      name: nmap
      state: absent
      clean_deps: true
  ```
  Expected output: Removes nmap and deps (`changed: true`); return: `results` listing removed packages.

- **disable_gpg_check**: Disables GPG signature checks. Type: boolean. Default: false. Possible values: true (skips checks, effect: installs without verification, risks installing tampered packages), false (enforces checks, effect: safe installs by verifying signatures against trusted keys). Required: No. Notes: For state=present/latest; use cautiously.

  Best practice: Avoid true in production to mitigate security risks like man-in-the-middle attacks. Tip: For internal repos; trick: Use with `extra_args` for key imports.

  Example: Disable GPG.
  ```yaml
  - name: Install without GPG
    community.general.zypper:
      name: custompkg
      state: present
      disable_gpg_check: true
  ```
  Expected output: Installs without check (`changed: true`); return: `rc: 0`, warning if unsigned.

- **disable_recommends**: Modifies recommend installation behavior. Type: boolean. Default: true. Possible values: true (adds `--no-recommends`, effect: installs only required, minimizes footprint and dependencies), false (installs recommends, effect: includes extras for full functionality). Required: No.

  Best practice: Use true for lean systems to avoid bloat. Tip: Recommends are suggested but non-essential; check with `zypper info`. Trick: Override per-task.

  Example: Install with recommends.
  ```yaml
  - name: Install apache2 with recommends
    community.general.zypper:
      name: apache2
      state: present
      disable_recommends: false
  ```
  Expected output: Installs apache2 + recommends (`changed: true`); return: more packages listed.

- **extra_args**: Adds custom options to zypper. Type: string. Default: None. Possible values: Any zypper flags (e.g., '--allow-arch-change --quiet', effect: customizes command for architecture changes or silent operation). Required: No. Notes: Single line as in CLI.

  Best practice: Use for niche flags like '--with-optional'. Tip: Quote spaces; trick: Combine with `extra_args_precommand`.

  Example: Extra args.
  ```yaml
  - name: Upgrade with args
    community.general.zypper:
      name: '*'
      state: dist-upgrade
      extra_args: '--allow-arch-change'
  ```
  Expected output: Allows arch changes (`changed: true` if upgraded).

- **extra_args_precommand**: Adds global options before command. Type: string. Default: None. Possible values: Any global flags (e.g., '--root /chroot', effect: targets alternate root for isolated environments). Required: No.

  Best practice: Use for chroots or custom roots. Tip: Similar to extra_args; trick: For repo management.

  Example: Precommand args.
  ```yaml
  - name: Install in chroot
    community.general.zypper:
      name: vim
      state: present
      extra_args_precommand: '--root /my/chroot'
  ```
  Expected output: Operates in chroot (`changed: true`).

- **force**: Forces actions like downgrade. Type: boolean. Default: false. Possible values: true (adds `--force`, effect: allows downgrade/vendor/arch changes, overriding safety checks), false (safe, respects constraints). Required: No.

  Best practice: Use for specific versions, but test thoroughly to avoid instability. Tip: Risks breaking dependencies; trick: With `allow_vendor_change`.

  Example: Force install.
  ```yaml
  - name: Force downgrade
    community.general.zypper:
      name: pkg=1.0
      state: present
      force: true
  ```
  Expected output: Downgrades if needed (`changed: true`).

- **force_resolution**: Forces resolver choices. Type: boolean. Default: false. Possible values: true (adds `--force-resolution`, effect: automatically resolves conflicts by choosing a solution, potentially uninstalling packages), false (prompts or fails on conflicts, effect: requires manual intervention). Required: No. Notes: Added in 0.2.0.

  Best practice: Use in non-interactive scripts to avoid hangs, but review logs for unintended removals. Tip: Conflicts arise from incompatible dependencies; trick: With `clean_deps` for cleanup.

  Example: Force resolution.
  ```yaml
  - name: Install with resolution
    community.general.zypper:
      name: conflictingpkg
      state: present
      force_resolution: true
  ```
  Expected output: Resolves and installs (`changed: true`).

- **name** (aliases: pkg): Package(s) to manage. Type: list / elements=string. Default: None. Possible values: Name (e.g., 'nmap', effect: single package action), specifier (e.g., 'nmap>1.0', effect: version constraint for targeted install/update), list (effect: processes multiple efficiently), '*' (effect: all packages for bulk updates/dist-upgrades), URL/path (effect: installs from remote/local RPM, bypassing repos). Required: Yes. Notes: Version with <, >, <=, >=, =; loops process individually for safety.

  Best practice: Use lists for efficiency over loops to reduce overhead. Tip: '*' for system-wide; URL for custom RPMs. Trick: Avoid loops for large lists to optimize execution time.

  Example: Install nmap.
  ```yaml
  - name: Install nmap
    community.general.zypper:
      name: nmap
      state: present
  ```
  Expected output: Installs nmap (`changed: true` if new); return: `results` with installed packages.

- **oldpackage**: Allows old packages. Type: boolean. Default: false. Possible values: true (adds `--oldpackage`, effect: installs outdated versions, useful for testing/compatibility), false (installs current, effect: standard behavior). Required: No. Notes: Added in 1.0.0; for state=present/latest.

  Best practice: Use sparingly for legacy support, as it may introduce vulnerabilities. Tip: Combine with specific versions; trick: With `force` for downgrades.

  Example: Install old.
  ```yaml
  - name: Install old package
    community.general.zypper:
      name: oldpkg
      state: present
      oldpackage: true
  ```
  Expected output: Installs old version (`changed: true`).

- **replacefiles**: Replaces conflicting files. Type: boolean. Default: false. Possible values: true (adds `--replacefiles`, effect: overwrites files from other packages, resolves file conflicts), false (fails on conflicts, effect: safer but may halt). Required: No. Notes: Added in 2.1.0; for install/upgrade.

  Best practice: Use when conflicts are known and safe to override. Tip: Conflicts occur when files overlap; trick: With `force_resolution`.

  Example: Replace files.
  ```yaml
  - name: Install with replace
    community.general.zypper:
      name: conflicting
      state: latest
      replacefiles: true
  ```
  Expected output: Overwrites files (`changed: true`).

- **skip_post_errors**: Skips post-install errors. Type: boolean. Default: false. Possible values: true (ignores post-install failures, effect: continues workflow despite non-fatal issues like script errors), false (fails on errors, effect: halts for safety). Required: No. Notes: Added in 10.1.0; for state=present/latest.

  Best practice: Use for known benign errors in custom packages. Tip: Review logs for skipped issues; trick: With `ignore_errors: yes` in playbooks.

  Example: Skip errors.
  ```yaml
  - name: Install skipping errors
    community.general.zypper:
      name: errorpkg
      state: present
      skip_post_errors: true
  ```
  Expected output: Installs, ignores post-errors (`changed: true`); return: warnings in results.

- **state**: Desired package state. Type: string. Default: present. Possible values: present (installs if absent, effect: ensures availability without upgrade), absent (removes if present, effect: uninstalls including configs if transactional), latest (updates to newest, effect: upgrades installed packages), dist-upgrade (full upgrade, effect: upgrades distribution, possibly changing versions/architectures). Required: No.

  Best practice: Use latest for security patches, dist-upgrade for major releases. Tip: Latest is per-package, dist-upgrade system-wide. Trick: Combine with type for scoped updates.

  Example: Update all.
  ```yaml
  - name: Update all
    community.general.zypper:
      name: '*'
      state: latest
  ```
  Expected output: Updates packages (`changed: true` if changes).

- **type**: Package type. Type: string. Default: package. Possible values: package (effect: standard RPM handling), patch (effect: applies security/update patches without full upgrade), pattern (effect: installs grouped packages for roles like "lamp_server"), product (effect: manages major components like add-ons), srcpackage (effect: installs source code for building/customization). Required: No.

  Best practice: Use patch for quick fixes, pattern for predefined setups. Tip: Patterns simplify complex installs; srcpackage for development. Trick: With '*' for all of type.

  Example: Apply patches.
  ```yaml
  - name: Apply patches
    community.general.zypper:
      name: '*'
      state: latest
      type: patch
  ```
  Expected output: Applies patches (`changed: true`).

- **update_cache**: Refreshes repositories before operation. Type: boolean. Default: false. Possible values: true (runs `zypper refresh`, effect: updates metadata for latest packages), false (no refresh, effect: uses cached data, faster but potentially outdated). Required: No. Notes: Disabled in check mode.

  Best practice: Use true to ensure freshness in dynamic repos. Tip: Increases time but prevents stale errors; trick: With `extra_args_precommand` for specific repos.

  Example: Refresh and install.
  ```yaml
  - name: Refresh and install
    community.general.zypper:
      name: openssl
      state: present
      update_cache: true
  ```
  Expected output: Refreshes and installs (`changed: true` if new).

## Additional Examples for the Ansible Zypper Module

#### Example 1: Installing Multiple Packages with Specific Versions
```yaml
- name: Install multiple packages with specific versions
  community.general.zypper:
    name:
      - nginx=1.21.0
      - php7.4=7.4.28
      - mariadb=10.5.13
    state: present
```
**Explanation**: This example installs three packages (nginx, php7.4, and mariadb) with specific versions. The version constraints ensure that exactly these versions are installed, which is useful for maintaining consistent environments across systems. Output shows `changed: true` for each package that was installed, with the specific versions listed in the return values.

#### Example 2: Removing Packages and Cleaning Dependencies
```yaml
- name: Remove packages and clean unused dependencies
  community.general.zypper:
    name:
      - old-app
      - deprecated-lib
    state: absent
    clean_deps: true
```
**Explanation**: This example removes two packages (`old-app` and `deprecated-lib`) and any dependencies that are no longer needed after removal. The `clean_deps: true` parameter ensures that unused dependencies are also removed, preventing accumulation of orphaned packages. Output shows `changed: true` for each removed package and any dependencies that were cleaned up.

#### Example 3: Applying Security Patches Only
```yaml
- name: Apply security patches only
  community.general.zypper:
    name: '*'
    state: latest
    type: patch
    extra_args: '--category security'
```
**Explanation**: This example applies only security-related patches to the system. The `type: patch` parameter specifies that we're dealing with patches rather than full packages, and the `extra_args` adds a category filter to limit to security patches only. This is useful for maintaining security without applying other updates that might require testing. Output shows `changed: true` if security patches were applied.

#### Example 4: Installing a Pattern (Package Group)
```yaml
- name: Install LAMP server pattern
  community.general.zypper:
    name: lamp_server
    state: present
    type: pattern
    disable_recommends: false
```
**Explanation**: This example installs the LAMP server pattern, which is a predefined group of packages for setting up a Linux, Apache, MySQL, PHP server. The `type: pattern` parameter indicates we're installing a pattern rather than individual packages. The `disable_recommends: false` ensures that recommended packages for the pattern are also installed. Output shows `changed: true` if the pattern was installed, with a list of all packages included in the pattern.

#### Example 5: Distribution Upgrade with Vendor Change
```yaml
- name: Perform distribution upgrade allowing vendor changes
  community.general.zypper:
    name: '*'
    state: dist-upgrade
    allow_vendor_change: true
    update_cache: true
```
**Explanation**: This example performs a full distribution upgrade, allowing packages to change vendors if necessary. This is useful when migrating between different SUSE products or when third-party repositories are used. The `update_cache: true` ensures the latest package information is used. Output shows `changed: true` if any packages were upgraded, with details about vendor changes if they occurred.

#### Example 6: Installing from a Local RPM File
```yaml
- name: Install package from local RPM file
  community.general.zypper:
    name: /tmp/custom-app-1.0-1.x86_64.rpm
    state: present
    disable_gpg_check: true
```
**Explanation**: This example installs a package from a local RPM file rather than a repository. The `disable_gpg_check: true` is used because local RPM files often aren't signed with GPG keys that the system recognizes. This is useful for installing custom or third-party packages not available in repositories. Output shows `changed: true` if the package was installed successfully.

#### Example 7: Downgrading a Package
```yaml
- name: Downgrade package to previous version
  community.general.zypper:
    name: nginx=1.20.0
    state: present
    force: true
    oldpackage: true
```
**Explanation**: This example downgrades the nginx package to version 1.20.0, even if a newer version is already installed. The `force: true` parameter allows the downgrade to proceed, and `oldpackage: true` explicitly permits installing an older version. This is useful for rolling back problematic updates. Output shows `changed: true` if the downgrade was successful.

#### Example 8: Installing Source Packages
```yaml
- name: Install source package for compilation
  community.general.zypper:
    name: nginx
    state: present
    type: srcpackage
```
**Explanation**: This example installs the source package for nginx, which contains the source code rather than the compiled binary. The `type: srcpackage` parameter specifies that we want source packages. This is useful for developers who need to compile software from source or examine the source code. Output shows `changed: true` if the source package was installed.

#### Example 9: Handling Package Conflicts
```yaml
- name: Install package with conflict resolution
  community.general.zypper:
    name: conflicting-package
    state: present
    force_resolution: true
    replacefiles: true
```
**Explanation**: This example installs a package that might have conflicts with existing packages. The `force_resolution: true` parameter automatically resolves any dependency conflicts, potentially removing conflicting packages. The `replacefiles: true` allows the package to overwrite files from other packages if necessary. This is useful for resolving complex dependency issues but should be used with caution. Output shows `changed: true` if the package was installed and any conflicts were resolved.

#### Example 10: Skipping Post-Installation Errors
```yaml
- name: Install package ignoring post-installation errors
  community.general.zypper:
    name: problem-pkg
    state: present
    skip_post_errors: true
```
**Explanation**: This example installs a package that might have non-critical post-installation errors (such as script failures). The `skip_post_errors: true` parameter ensures that the installation continues even if these errors occur. This is useful for packages that have known but harmless post-installation issues. Output shows `changed: true` if the package was installed, with any skipped errors noted in the output.

#### Example 11: Installing Packages with Custom Repository
```yaml
- name: Install package from custom repository
  community.general.zypper:
    name: custom-app
    state: present
    extra_args_precommand: '--repo http://custom.repo.example.com/custom'
    update_cache: true
```
**Explanation**: This example installs a package from a custom repository that isn't configured in the system's repository list. The `extra_args_precommand` parameter adds a repository option to the zypper command, and `update_cache: true` ensures the repository metadata is refreshed. This is useful for one-time installations from temporary or specialized repositories. Output shows `changed: true` if the package was installed from the custom repository.

#### Example 12: Installing Product Package
```yaml
- name: Install SUSE Manager product
  community.general.zypper:
    name: SUSE-Manager-Server
    state: present
    type: product
    disable_recommends: false
```
**Explanation**: This example installs the SUSE Manager Server product, which is a collection of packages that provide the SUSE Manager functionality. The `type: product` parameter indicates we're installing a product package, and `disable_recommends: false` ensures all recommended packages are included. This is useful for setting up major SUSE products or add-ons. Output shows `changed: true` if the product was installed, with details about the included packages.

#### Example 13: Performing Dry Run Installation
```yaml
- name: Dry run installation of packages
  community.general.zypper:
    name:
      - apache2
      - php7
      - mariadb
    state: present
    extra_args: '--dry-run'
  check_mode: yes
```
**Explanation**: This example performs a dry run of installing three packages without actually making any changes. The `extra_args: '--dry-run'` parameter tells zypper to simulate the installation, and `check_mode: yes` enables Ansible's check mode. This is useful for testing package installations before applying them in production. Output shows what would have been changed, but with `changed: false` since no actual changes were made.

#### Example 14: Installing Packages with Architecture Specification
```yaml
- name: Install package for specific architecture
  community.general.zypper:
    name: nginx.x86_64
    state: present
    extra_args: '--allow-arch-change'
```
**Explanation**: This example installs the nginx package specifically for the x86_64 architecture, even if the system's default architecture is different. The `extra_args: '--allow-arch-change'` permits the architecture change. This is useful for multi-architecture systems or when specific architecture packages are required. Output shows `changed: true` if the package was installed with the specified architecture.

#### Example 15: Removing Packages While Preserving Configuration
```yaml
- name: Remove package but preserve configuration files
  community.general.zypper:
    name: old-service
    state: absent
    extra_args: '--configfiles'
```
**Explanation**: This example removes a package but preserves its configuration files. The `extra_args: '--configfiles'` parameter tells zypper to leave configuration files in place when removing the package. This is useful when you want to remove a package but keep its configuration for potential reinstallation or reference. Output shows `changed: true` if the package was removed, with a note that configuration files were preserved.

### Summary Table of Arguments

| Argument Name | Type | Default Value | Possible Values and Effects | Required | Notes/Deprecations |
|---------------|------|---------------|------------------------------|----------|--------------------|
| allow_vendor_change | boolean | false | true (allows vendor change in dist-upgrade), false (restricts) | No | Added 0.2.0 |
| clean_deps | boolean | false | true (cleans deps on remove), false (leaves) | No | Added 4.6.0 |
| disable_gpg_check | boolean | false | true (skips GPG), false (enforces) | No | For present/latest |
| disable_recommends | boolean | true | true (no recommends), false (installs) | No | - |
| extra_args | string | None | Any zypper flags (e.g., '--quiet', effect: customizes) | No | Single line |
| extra_args_precommand | string | None | Global flags (e.g., '--root /chroot', effect: alternate root) | No | - |
| force | boolean | false | true (forces downgrade/change), false (safe) | No | - |
| force_resolution | boolean | false | true (forces conflict resolution), false (prompts/fails) | No | Added 0.2.0 |
| name (pkg) | list / elements=string | None | Name/specifier/list/'*'/URL/path (effect: manages specified) | Yes | - |
| oldpackage | boolean | false | true (allows old packages), false (current) | No | Added 1.0.0 |
| replacefiles | boolean | false | true (overwrites conflicts), false (fails) | No | Added 2.1.0 |
| skip_post_errors | boolean | false | true (ignores post-install errors), false (fails) | No | Added 10.1.0 |
| state | string | present | present (install), absent (remove), latest (update), dist-upgrade (full upgrade) | No | - |
| type | string | package | package (RPM), patch (updates), pattern (groups), product (products), srcpackage (sources) | No | - |
| update_cache | boolean | false | true (refreshes repos), false (no) | No | Disabled in check