# 2.9. ansible-playbook Command

2025-08-10 00:02
Status: #DONE 
Tags: [[Ansible]]

---
### Mastering `ansible-playbook`: Flags, Sub-Commands, and DevOps Wisdom  
As a DevOps veteran who’s wrangled infrastructure with Ansible for years, I’ve learned that `ansible-playbook` is the Swiss Army knife of automation. Let’s break down its flags, sub-commands, and pro tips—complete with examples and a cheat sheet. Grab your coffee; this is going to be fun!  

---

### **Core Flags for `ansible-playbook`**  
These flags control playbook execution, targeting, and behavior. I’ll group them by use case for clarity.  

#### **1. Inventory & Targeting Flags**  
Control *which* hosts the playbook runs on.  
- **`-i INVENTORY`** or **`--inventory-file=INVENTORY`**  
  Specify the inventory file (or directory). Default: `/etc/ansible/hosts`.  
```bash
ansible-playbook -i production_hosts deploy.yml  # Use custom inventory
```  
  **Pro Tip:** Use dynamic inventories (e.g., AWS/Azure scripts) with `-i` for cloud environments.  

- **`--limit HOST_PATTERN`**  
  Restrict execution to a subset of hosts. Use regex or group names.  
```bash
ansible-playbook --limit webservers deploy.yml      # Target 'webservers' group
ansible-playbook --limit 'web*:!web01' deploy.yml   # Exclude web01
```  
  **Pro Tip:** Combine with `--list-hosts` to preview targets before running.  

- **`--list-hosts`**  
  List all hosts targeted by the playbook (dry run).  
```bash
ansible-playbook --list-hosts deploy.yml
```  

#### **2. Execution & Behavior Flags**  
Control *how* the playbook runs.  
- **`--check`** or **`-C`**  
  Dry run mode: Predict changes without executing them.  
```bash
ansible-playbook --check deploy.yml  # "What would change?"
```  
  **Pro Tip:** Pair with `--diff` to see file changes.  

- **`--diff`**  
  Show file differences when templates/files change.  
```bash
ansible-playbook --diff deploy.yml  # Highlights changes in output
```  

- **`--step`**  
  Interactive mode: Confirm each task before running.  
```bash
ansible-playbook --step deploy.yml  # Press 'y' to run each task
```  
  **Pro Tip:** Use for debugging complex playbooks.  

- **`--start-at-task=NAME`**  
  Resume playbook from a specific task.  
  ```bash
  ansible-playbook --start-at-task="Install Nginx" deploy.yml
  ```  

- **`--flush-cache`**  
  Clear fact cache for targeted hosts.  
```bash
ansible-playbook --flush-cache deploy.yml  # Useful after host updates
```  

#### **3. Verbosity & Debugging Flags**  
Control output detail.  
- **`-v`**, **`-vv`**, **`-vvv`**, **`-vvvv`**  
  Increase verbosity (up to 4 levels).  
  ```bash
  ansible-playbook -vvv deploy.yml  # Debug SSH/module issues
  ```  
  **Pro Tip:** `-vvvv` exposes SSH connection details.  

- **`--syntax-check`**  
  Validate playbook syntax without execution.  
```bash
ansible-playbook --syntax-check deploy.yml  # Catch YAML errors early
```  

- **`--list-tasks`**  
  List all tasks in the playbook.  
```bash
ansible-playbook --list-tasks deploy.yml
```  

#### **4. Privilege Escalation Flags**  
Control `sudo`/`su` behavior.  
- **`--become`** or **`-b`**  
  Run tasks with privilege escalation (e.g., `sudo`).  
```bash
ansible-playbook --become deploy.yml  # Default: sudo
```  

- **`--become-method=METHOD`**  
  Specify escalation method (e.g., `sudo`, `su`, `doas`).  
```bash
ansible-playbook --become --become-method=su deploy.yml
```  

- **`--become-user=USER`**  
  Escalate to a specific user (default: `root`).  
```bash
ansible-playbook --become --become-user=nginx deploy.yml
```  

- **`--ask-become-pass`** or **`-K`**  
  Prompt for escalation password.  
```bash
ansible-playbook --become --ask-become-pass deploy.yml
```  

#### **5. Tagging Flags**  
Run specific tasks using tags.  
- **`--tags=TAGS`**  
  Execute only tasks with specified tags.  
```bash
ansible-playbook --tags=nginx,config deploy.yml
```  

- **`--skip-tags=TAGS`**  
  Skip tasks with specified tags.  
```bash
ansible-playbook --skip-tags=testing deploy.yml
```  

- **`--list-tags`**  
  List all tags in the playbook.  
```bash
ansible-playbook --list-tags deploy.yml
```  

#### **6. Vault Flags**  
Manage encrypted files.  
- **`--ask-vault-pass`**  
  Prompt for Vault password.  
```bash
ansible-playbook --ask-vault-pass secrets.yml
```  

- **`--vault-password-file=FILE`**  
  Use a file containing the Vault password.  
```bash
ansible-playbook --vault-password-file .vault_pass deploy.yml
```  

#### **7. Variable & Connection Flags**  
Override variables and connection settings.  
- **`--extra-vars=VARS`** or **`-e VARS`**  
  Set variables inline or via JSON/YAML file.  
```bash
ansible-playbook -e "env=prod version=1.2" deploy.yml
ansible-playbook -e "@vars.json" deploy.yml  # Load from file
```  

- **`--private-key=KEY`**  
  Specify SSH private key.  
  ```bash
  ansible-playbook --private-key ~/.ssh/aws.pem deploy.yml
  ```  

- **`--user=USER`** or **`-u USER`**  
  Connect as a specific user.  
```bash
ansible-playbook -u ec2-user deploy.yml
```  

- **`--ssh-common-args=ARGS`**  
  Pass custom arguments to SSH.  
```bash
ansible-playbook --ssh-common-args='-o StrictHostKeyChecking=no' deploy.yml
```  

---

### **Sub-Commands**  
Unlike `ansible`, `ansible-playbook` has no true "sub-commands." Flags like `--list-hosts` or `--syntax-check` act as *actions* rather than sub-commands. However, here are critical pseudo-sub-commands:  

#### **1. `ansible-playbook --list-hosts`**  
List all targeted hosts (as shown earlier).  

#### **2. `ansible-playbook --list-tasks`**  
List all tasks (as shown earlier).  

#### **3. `ansible-playbook --list-tags`**  
List all tags (as shown earlier).  

#### **4. `ansible-playbook --syntax-check`**  
Validate playbook syntax (as shown earlier).  

---

### **Pro Tips & Best Practices**  
From years of battle-tested automation:  

1. **Idempotency is Non-Negotiable**  
   Always test playbooks with `--check` and `--diff`. Idempotent playbooks can run repeatedly without side effects.  

2. **Use Tags Strategically**  
   Tag tasks by function (e.g., `nginx`, `db`, `security`). Example:  
```yaml
- name: Install Nginx
	apt: name=nginx state=present
	tags: ['nginx', 'web']
```  
   Run only `nginx` tasks with `--tags nginx`.  

3. **Dynamic Inventories for Cloud**  
   Use `ansible-inventory` with cloud scripts:  
```bash
ansible-playbook -i inventory/aws_ec2.yml deploy.yml
```  

4. **Vault for Secrets**  
   Encrypt sensitive data:  
```bash
ansible-vault encrypt secrets.yml
```  
   Use `--vault-password-file` in CI/CD pipelines.  

5. **Limit Parallelism Wisely**  
   Adjust `--forks` (default: 5) for large fleets:  
```bash
ansible-playbook --forks=50 deploy.yml  # Faster, but watch load
```  

6. **Handlers & `--force-handlers`**  
   Force handlers to run even if tasks fail:  
```bash
ansible-playbook --force-handlers deploy.yml
```  

7. **Debug with `--step` and `-vvvv`**  
   When playbooks fail, use `--step` for granular control and `-vvvv` for SSH/module debugging.  

8. **Version Control Everything**  
   Store playbooks, inventories, and roles in Git. Use `.gitignore` for Vault files and temporary artifacts.  

9. **Lint Your Playbooks**  
   Use `ansible-lint` to catch issues early:  
```bash
ansible-lint deploy.yml
```  

10. **Test in Staging First**  
    Always run playbooks in a staging environment with `--check` before production.  

---

### **Summary Table: `ansible-playbook` Flags & Actions**  
| **Flag/Action**          | **Description**                                      | **Example**                                      |  
|--------------------------|------------------------------------------------------|--------------------------------------------------|  
| **Inventory & Targeting** |                                                      |                                                  |  
| `-i INVENTORY`           | Specify inventory file/directory                     | `-i hosts.ini`                                   |  
| `--limit HOST_PATTERN`   | Restrict hosts to a subset                           | `--limit webservers`                             |  
| `--list-hosts`           | List targeted hosts                                  | `ansible-playbook --list-hosts deploy.yml`       |  
| **Execution & Behavior** |                                                      |                                                  |  
| `--check` or `-C`        | Dry run (no changes)                                 | `ansible-playbook --check deploy.yml`            |  
| `--diff`                 | Show file differences                                | `ansible-playbook --diff deploy.yml`             |  
| `--step`                 | Interactive task confirmation                        | `ansible-playbook --step deploy.yml`             |  
| `--start-at-task=NAME`   | Resume from a specific task                          | `--start-at-task="Install Nginx"`                |  
| **Verbosity & Debugging** |                                                      |                                                  |  
| `-v`, `-vv`, `-vvv`      | Increase verbosity                                   | `ansible-playbook -vvv deploy.yml`               |  
| `--syntax-check`         | Validate playbook syntax                             | `ansible-playbook --syntax-check deploy.yml`     |  
| `--list-tasks`           | List all tasks                                       | `ansible-playbook --list-tasks deploy.yml`       |  
| **Privilege Escalation** |                                                      |                                                  |  
| `--become` or `-b`       | Enable privilege escalation                          | `ansible-playbook --become deploy.yml`           |  
| `--become-method=METHOD` | Set escalation method (e.g., `sudo`, `su`)            | `--become-method=su`                            |  
| `--ask-become-pass` or `-K` | Prompt for escalation password                     | `ansible-playbook -K deploy.yml`                 |  
| **Tagging**              |                                                      |                                                  |  
| `--tags=TAGS`            | Run only tasks with these tags                       | `--tags nginx,config`                            |  
| `--skip-tags=TAGS`       | Skip tasks with these tags                           | `--skip-tags testing`                            |  
| `--list-tags`            | List all tags                                        | `ansible-playbook --list-tags deploy.yml`        |  
| **Vault**                |                                                      |                                                  |  
| `--ask-vault-pass`       | Prompt for Vault password                            | `ansible-playbook --ask-vault-pass secrets.yml`  |  
| `--vault-password-file=FILE` | Use file for Vault password                     | `--vault-password-file .vault_pass`             |  
| **Variables & Connection** |                                                      |                                                  |  
| `-e VARS` or `--extra-vars=VARS` | Set variables (inline or file)               | `-e "env=prod"` or `-e "@vars.json"`             |  
| `--private-key=KEY`      | Specify SSH private key                              | `--private-key ~/.ssh/key.pem`                   |  
| `--user=USER` or `-u USER` | Connect as a specific user                         | `-u ec2-user`                                    |  

---

### **Final Thoughts**  
`ansible-playbook` is your gateway to infrastructure automation nirvana. Master these flags, embrace idempotency, and always test before deploying to production. Remember:  
> *"Automation isn’t about eliminating humans—it’s about amplifying their impact."*  

Now go automate something awesome! 🚀