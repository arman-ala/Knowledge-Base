# 3.15. Yum Module

2025-08-14 15:31
Status: #DONE 
Tags: [[Ansible]]

---
### Understanding the Ansible Yum Module: A Comprehensive Guide

In the realm of DevOps automation, Ansible's built-in modules for package management are crucial for maintaining consistency across RPM-based Linux distributions like CentOS, RHEL, and Fedora. The `ansible.builtin.yum` module (aliased to `dnf` in Python 3 environments for newer systems) handles installation, upgrades, downgrades, removals, and listing of packages and groups using the yum (or dnf) package manager. Additionally, the `ansible.builtin.yum_repository` module manages YUM repositories, allowing addition or removal of repo configurations. This document provides a detailed exploration of the yum module, with expanded explanations for each parameter, formatted for clarity. To address your request, each parameter is structured with bullet points covering description, type/default, possible values/effects, required status, and notes. Unique examples (distinct from documentation and previous responses) are included to illustrate practical use. Complicated topics like "vendor change" (switching package providers, which can affect compatibility and support) and "GPG" (GNU Privacy Guard, used for verifying package signatures to ensure authenticity and prevent tampering) are explained in detail, along with others like "package groups," "modularity streams" (in dnf for version-locked module installs), and "autoremove" (cleaning unused dependencies to optimize system space).

#### Simplified Explanation: Breaking It Down Simply

Think of the `yum` module as a smart package clerk for RPM-based systems: it installs, updates, or removes software, handling dependencies automatically. You specify the package name (or a list, version constraint, or group like "@Development tools"), set the state (e.g., present for install, latest for update), and add options like enabling repos or disabling GPG checks. For multiple packages, you can install them all at once (as a list for efficiency), one after another (sequential tasks for control), or in a loop (for dynamic lists or conditionals). The `yum_repository` module is the repo manager: it adds or removes repository files (.repo) to define where packages come from, with options like baseurl and gpgcheck. Vendor change allows switching package sources (e.g., from official RHEL to community repos, risking support issues), while GPG verifies package signatures for security. These modules ensure idempotency—no unnecessary changes—and are ideal for provisioning servers or updating fleets.

#### In-Depth Analysis: Precise and Comprehensive Coverage

The `ansible.builtin.yum` module, part of `ansible-core`, manages packages on systems using yum (Python 2) or dnf (Python 3 alias), requiring yum or python3-dnf on the target. It supports states like present (install if absent), absent (remove), latest (upgrade), and installed (alias for present). For multiple packages, lists are preferred for efficiency, as they execute in a single yum transaction, reducing overhead and ensuring atomicity (all or none succeed). Sequential tasks run separate transactions, useful for conditionals or error handling, while loops (with `loop`) process dynamically, ideal for variable lists but less efficient due to per-item executions.

The module excels in handling vendor change, where packages from different vendors (e.g., Red Hat vs. CentOS) can be allowed during updates, potentially leading to mixed systems and compatibility issues like conflicting libraries or lost vendor support. GPG is the cryptographic tool for signing RPMs; disabling it skips integrity checks, exposing to risks like supply-chain attacks. Package groups are predefined sets (e.g., "@Development tools" installs compilers and libraries); modularity streams in dnf allow version-locked modules (e.g., "nodejs:12" for specific Node.js stream). Autoremove cleans leaf packages (unused dependencies), preventing bloat.

The module supports `check_mode` for previews and `diff_mode` for change details, with full action plugins. It requires become for privileged operations.

##### Yum Module Parameters

- **allow_downgrade**:
  - description: Specifies if the named package and version is allowed to downgrade a potentially already installed higher version of that package. Note that setting this to true can make the module behave in a non-idempotent way, as dependencies between the downgraded package and others may cause additional changes to the package set.
  - Type: boolean. Default: false. 
  - Possible values: true (effect: permits downgrades, useful for rolling back to stable versions but risks breaking dependencies or introducing incompatibilities), false (effect: prevents downgrades, maintaining the current or higher version for safety and stability). 
  - Required: No.
  - Notes: Added in 2.7; can lead to unexpected package states due to dep changes.

  Unique example: Downgrade a testing package to stable.
  ```yaml
  - name: Downgrade unstable lib
    ansible.builtin.yum:
      name: unstable-lib=1.5
      state: present
      allow_downgrade: true
  ```
  Expected output: Downgrades to 1.5 if higher exists (`changed: true`); may alter related packages.

- **autoremove**:
  - description: If set to true, removes all "leaf" packages from the system that were originally installed as dependencies of user-installed packages but are no longer required by any such package. Should be used alone or when state is absent to clean up unused deps and free disk space.
  - Type: boolean. Default: false. 
  - Possible values: true (effect: automatically removes orphan dependencies, optimizing system resources but potentially removing packages you might need later if not careful), false (effect: leaves unused dependencies intact, avoiding accidental removals but allowing bloat over time). 
  - Required: No.
  - Notes: Added in 2.7; requires yum >=3.4.3 (RHEL/CentOS 7+).

  Unique example: Clean after app removal.
  ```yaml
  - name: Autoremove after uninstall
    ansible.builtin.yum:
      autoremove: true
  ```
  Expected output: Removes orphan deps (`changed: true` if any removed); system cleaner.

- **bugfix**:
  - description: If set to true and state=latest, only installs updates marked as bugfix related, limiting the upgrade to fixes for known bugs without introducing new features or major changes.
  - Type: boolean. Default: false. 
  - Possible values: true (effect: applies only bugfix updates, enhancing stability by avoiding unrelated changes that could introduce new issues), false (effect: performs full updates, including enhancements and security fixes). 
  - Required: No.
  - Notes: Useful for production to minimize disruption.

  Unique example: Apply bugfixes only.
  ```yaml
  - name: Bugfix update
    ansible.builtin.yum:
      name: '*'
      state: latest
      bugfix: true
  ```
  Expected output: Updates bugfixes (`changed: true` if applicable); no feature upgrades.

- **cacheonly**:
  - description: Tells yum to run entirely from system cache, without downloading or updating metadata, useful for offline operations or air-gapped environments.
  - Type: boolean. Default: false. 
  - Possible values: true (effect: uses cached data only, enabling fast operations without network but risking outdated packages if cache is stale), false (effect: fetches metadata if needed, ensuring current info). 
  - Required: No.
  - Notes: Added in 2.12; requires pre-populated cache.

  Unique example: Offline install from cache.
  ```yaml
  - name: Install from cache
    ansible.builtin.yum:
      name: offlinepkg
      state: present
      cacheonly: true
  ```
  Expected output: Installs from cache (`changed: true` if absent); no network use.

- **conf_file**:
  - description: Specifies the path to a custom yum configuration file to use instead of the default /etc/yum.conf, allowing tailored settings like custom repos or plugins.
  - Type: string. Default: None. 
  - Possible values: Any valid path (effect: uses the specified config, enabling isolated or test environments with different repo setups). 
  - Required: No.
  - Notes: Useful for multi-config systems.

  Unique example: Use custom conf for test repo.
  ```yaml
  - name: Install with custom conf
    ansible.builtin.yum:
      name: testpkg
      state: present
      conf_file: /etc/yum_test.conf
  ```
  Expected output: Uses custom conf for install (`changed: true`).

- **disable_excludes**:
  - description: Disables exclude directives in yum.conf or repos, which normally prevent certain packages from being installed or updated (e.g., kernel* for stability).
  - Type: string. Default: None. 
  - Possible values: 'all' (effect: ignores all excludes globally, allowing previously blocked packages), repo ID (effect: ignores excludes only for that repo, targeted override). 
  - Required: No.
  - Notes: Overrides exclusions for specific operations.

  Unique example: Ignore all excludes for upgrade.
  ```yaml
  - name: Upgrade ignoring excludes
    ansible.builtin.yum:
      name: '*'
      state: latest
      disable_excludes: all
  ```
  Expected output: Upgrades including excluded (`changed: true`).

- **disable_gpg_check**: Disables GPG signature verification for packages, skipping authenticity checks.
  - Type: boolean. Default: false. 
  - Possible values: true (effect: installs without GPG, risking malicious packages), false (effect: enforces checks for security). 
  - Required: No.

- **disable_plugin**: Disables specific yum plugins (e.g., fastestmirror for mirror selection).
  - Type: list / elements=string. Default: None. 
  - Possible values: Plugin names (effect: disables listed, customizing behavior like skipping mirrors for local repos). 
  - Required: No.

- **disable_repo**: Temporarily disables repos during operation.
  - Type: list / elements=string. Default: None. 
  - Possible values: Repo IDs (effect: excludes sources, useful for isolating installs). 
  - Required: No.

- **disablerepo**: Alias for disable_repo.

- **download_dir**: Directory for downloads with download_only.
  - Type: string. Default: None. 
  - Possible values: Any path (effect: saves RPMs there without install). 
  - Required: No.
  - Notes: Added 2.8.

- **download_only**: Downloads without installing.
  - Type: boolean. Default: false. 
  - Possible values: true (effect: downloads to cache/dir, for offline use), false (effect: installs). 
  - Required: No.
  - Notes: Added 2.8; yum >=3.2.1.

- **enable_plugin**: Enables specific plugins.
  - Type: list / elements=string. Default: None. 
  - Possible values: Plugin names (effect: enables listed, e.g., priorities for repo ordering). 
  - Required: No.

- **enablerepo**: Temporarily enables repos.
  - Type: list / elements=string. Default: None. 
  - Possible values: Repo IDs (effect: includes additional sources). 
  - Required: No.

- **exclude**: Excludes packages from operations.
  - Type: list / elements=string. Default: None. 
  - Possible values: Names/globs (effect: skips listed, e.g., kernel* to protect boot). 
  - Required: No.

- **install_repoquery**: Installs repoquery for list if absent.
  - Type: boolean. Default: true. 
  - Possible values: true (effect: auto-installs for queries), false (effect: assumes present). 
  - Required: No.

- **install_weak_deps**: Installs weak deps (suggests) in dnf.
  - Type: boolean. Default: true. 
  - Possible values: true (effect: includes optional), false (effect: minimal). 
  - Required: No.
  - Notes: Added 2.7; dnf only.

- **installroot**: Root for installs.
  - Type: string. Default: "/". 
  - Possible values: Any path (effect: chroot-like). 
  - Required: No.

- **list**: Lists packages.
  - Type: string. Default: None. 
  - Possible values: 'available' (installable), 'installed' (installed), 'updates' (upgradable), name (details). 
  - Required: No.

- **lock_timeout**: Lock wait time.
  - Type: integer. Default: 30. 
  - Possible values: Positive (effect: waits seconds). 
  - Required: No.
  - Notes: Added 2.8; yum >=3.4.3.

- **lockfile**: Custom lock file.
  - Type: string. Default: None. 
  - Possible values: Any path (effect: uses custom). 
  - Required: No.
  - Notes: Added 2.8.

- **name** (pkg): Packages/groups to manage.
  - Type: list / elements=string. Default: None. 
  - Possible values: Name/version/group/'^group'/list/URL/path (effect: manages specified). 
  - Required: Yes for actions.

- **releasever**: Overrides release version.
  - Type: string. Default: None. 
  - Possible values: Any version (effect: uses specified for repos). 
  - Required: No.

- **security**: Security updates only.
  - Type: boolean. Default: false. 
  - Possible values: true (security only), false (full). 
  - Required: No.

- **skip_broken**: Skips broken packages.
  - Type: boolean. Default: false. 
  - Possible values: true (skips issues), false (fails). 
  - Required: No.

- **sslverify**: Verifies SSL for repos.
  - Type: boolean. Default: true. 
  - Possible values: true (secure), false (disables). 
  - Required: No.
  - Notes: Added 2.5.

- **state**: Desired state.
  - Type: string. Default: present. 
  - Possible values: present/installed (installs), absent/removed (uninstalls), latest (upgrades). 
  - Required: No.

- **update_cache**: Refreshes metadata.
  - Type: boolean. Default: false. 
  - Possible values: true (updates cache), false (no). 
  - Required: No.

- **update_only**: Updates without new installs.
  - Type: boolean. Default: false. 
  - Possible values: true (updates existing), false (full). 
  - Required: No.
  - Notes: Added 2.7.

- **use_backend**: Backend selection.
  - Type: string. Default: auto. 
  - Possible values: auto (system), yum (forces yum), dnf/dnf4/dnf5 (forces dnf). 
  - Required: No.
  - Notes: Added 2.17.

- **validate_certs**: Verifies certs for remote.
  - Type: boolean. Default: true. 
  - Possible values: true (secure), false (disables). 
  - Required: No.

### Practical Examples and Expected Outcomes for Multiple Package Installs

1. **At Once (List)**: Single transaction for efficiency.
   ```yaml
   - name: Install multiple at once
     ansible.builtin.yum:
       name:
         - nginx
         - postgresql
       state: present
   ```
   Outcome: Installs both in one go (`changed: true` if new); faster, atomic.

2. **Sequential (Multiple Tasks)**: Separate for control/conditionals.
   ```yaml
   - name: Install nginx
     ansible.builtin.yum:
       name: nginx
       state: present

   - name: Install postgresql
     ansible.builtin.yum:
       name: postgresql
       state: present
   ```
   Outcome: Installs sequentially (`changed` per task); allows per-task when.

3. **In a Loop (Dynamic)**: For variable lists.
   ```yaml
   - name: Install in loop
     ansible.builtin.yum:
       name: "{{ item }}"
       state: present
     loop:
       - nginx
       - postgresql
   ```
   Outcome: Installs per iteration (`changed` per item); flexible for conditions.

Unique example for loop with condition:
```yaml
- name: Install dynamically with condition
  ansible.builtin.yum:
    name: "{{ item.name }}"
    state: present
    when: item.condition
  loop:
    - { name: 'firewalld', condition: firewall_enabled | bool }
    - { name: 'selinux-policy', condition: selinux_enforced | bool }
```
Outcome: Installs conditionally (`changed` per satisfied item).

## Additional Examples for the Ansible Yum Module

#### Example 1: Installing a Package with Specific Version and Temporary Repository
```yaml
- name: Install specific version with temporary repo
  ansible.builtin.yum:
    name: nginx-1.18.0
    state: present
    enablerepo: nginx-stable
    disable_gpg_check: false
```
**Explanation**: Installs nginx version 1.18.0 by temporarily enabling the nginx-stable repository. The GPG check is enforced for security. This is useful when you need a specific version from a repository that's not normally enabled. Output shows `changed: true` if the package was installed, with the specific version noted in the return values.

#### Example 2: Installing a Package Group
```yaml
- name: Install Development Tools group
  ansible.builtin.yum:
    name: "@Development Tools"
    state: present
    disable_recommends: false
```
**Explanation**: Installs the "Development Tools" package group, which includes compilers, debuggers, and other development utilities. The `disable_recommends: false` ensures recommended packages are also installed. This is useful for setting up development environments. Output shows `changed: true` if the group was installed, with a list of all included packages.

#### Example 3: Installing Multiple Packages with Mixed States
```yaml
- name: Install packages with mixed states
  ansible.builtin.yum:
    name:
      - { name: httpd, state: present }
      - { name: mariadb-server, state: latest }
      - { name: php, state: absent }
```
**Explanation**: Installs httpd (if absent), updates mariadb-server to latest version, and removes php if present. This demonstrates handling multiple packages with different states in a single task. Output shows `changed: true` for each package that was installed, updated, or removed.

#### Example 4: Installing from a URL
```yaml
- name: Install package from URL
  ansible.builtin.yum:
    name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
    state: present
    disable_gpg_check: true
```
**Explanation**: Installs the EPEL release package directly from a URL. The `disable_gpg_check: true` is used because the RPM is signed but the key might not be imported yet. This is useful for adding third-party repositories. Output shows `changed: true` if the package was installed.

#### Example 5: Installing with Exclusions
```yaml
- name: Install excluding kernel packages
  ansible.builtin.yum:
    name: '*'
    state: latest
    exclude:
      - kernel*
      - kernel-*
```
**Explanation**: Updates all packages except those matching the kernel patterns. This is useful for applying updates while preserving a specific kernel version. Output shows `changed: true` if packages were updated, with kernel packages excluded.

#### Example 6: Security Updates Only
```yaml
- name: Apply security updates only
  ansible.builtin.yum:
    name: '*'
    state: latest
    security: true
    update_cache: true
```
**Explanation**: Applies only security-related updates to all packages. The `update_cache: true` ensures the latest metadata is used. This is critical for maintaining security without introducing potentially unstable updates. Output shows `changed: true` if security updates were applied.

#### Example 7: Bugfix Updates Only
```yaml
- name: Apply bugfix updates only
  ansible.builtin.yum:
    name: '*'
    state: latest
    bugfix: true
    skip_broken: true
```
**Explanation**: Applies only bugfix updates, skipping any packages with broken dependencies. The `skip_broken: true` allows the update to proceed even if some packages can't be updated due to dependency issues. Output shows `changed: true` if bugfix updates were applied.

#### Example 8: Install and Autoremove
```yaml
- name: Install package and autoremove unused deps
  ansible.builtin.yum:
    name: test-app
    state: present
- name: Autoremove unused dependencies
  ansible.builtin.yum:
    autoremove: true
```
**Explanation**: Installs a package and then removes any unused dependencies that were installed with it but are no longer needed. This two-step approach ensures clean system maintenance. Output shows `changed: true` for the installation and again for any removed dependencies.

#### Example 9: Install in Chroot Environment
```yaml
- name: Install package in chroot
  ansible.builtin.yum:
    name: python3
    state: present
    installroot: /mnt/chroot
    releasever: 8
```
**Explanation**: Installs python3 in a chroot environment at `/mnt/chroot`. The `releasever: 8` specifies the release version for repository paths. This is useful for setting up minimal environments or containers. Output shows `changed: true` if the package was installed in the chroot.

#### Example 10: Download Only
```yaml
- name: Download package without installing
  ansible.builtin.yum:
    name: htop
    state: present
    download_only: true
    download_dir: /tmp/rpms
```
**Explanation**: Downloads the htop package to `/tmp/rpms` without installing it. This is useful for creating offline repositories or for manual installation later. Output shows `changed: true` if the package was downloaded, with the path to the downloaded file.

#### Example 11: Skip Broken Dependencies
```yaml
- name: Install skipping broken dependencies
  ansible.builtin.yum:
    name: conflicting-app
    state: present
    skip_broken: true
```
**Explanation**: Attempts to install a package but skips it if it has broken dependencies. This allows the installation to proceed for other packages in a transaction while avoiding problematic ones. Output shows `changed: false` if the package was skipped due to broken dependencies.

#### Example 12: Disable GPG Check
```yaml
- name: Install without GPG check
  ansible.builtin.yum:
    name: internal-app
    state: present
    disable_gpg_check: true
```
**Explanation**: Installs a package without verifying its GPG signature. This is necessary for internal packages that aren't signed or for testing purposes, but should be used with caution in production. Output shows `changed: true` if the package was installed.

#### Example 13: Use Custom Configuration File
```yaml
- name: Install with custom yum configuration
  ansible.builtin.yum:
    name: custom-app
    state: present
    conf_file: /etc/yum-custom.conf
```
**Explanation**: Installs a package using a custom yum configuration file. This allows using different repository configurations or settings for specific operations. Output shows `changed: true` if the package was installed using the custom configuration.

#### Example 14: Allow Downgrade
```yaml
- name: Downgrade package version
  ansible.builtin.yum:
    name: problematic-app=1.2.0
    state: present
    allow_downgrade: true
```
**Explanation**: Downgrades a package to a specific version, even if a newer version is installed. This is useful for rolling back problematic updates. The `allow_downgrade: true` permits the downgrade operation. Output shows `changed: true` if the package was downgraded.

#### Example 15: Custom Lock Timeout
```yaml
- name: Install with custom lock timeout
  ansible.builtin.yum:
    name: critical-app
    state: present
    lock_timeout: 120
    lockfile: /var/run/yum-custom.lock
```
**Explanation**: Installs a package with a custom lock timeout of 120 seconds and a custom lock file. This is useful for systems where yum operations might take longer or when you need to avoid conflicts with other package management operations. Output shows `changed: true` if the package was installed.

### Summary Table of Arguments

| Argument Name     | Type                   | Default Value | Possible Values and Effects                                                                | Required        | Notes/Deprecations |
| ----------------- | ---------------------- | ------------- | ------------------------------------------------------------------------------------------ | --------------- | ------------------ |
| allow_downgrade   | boolean                | false         | true (permits downgrades), false (prevents)                                                | No              | Added 2.7          |
| autoremove        | boolean                | false         | true (cleans leaves), false (leaves)                                                       | No              | Added 2.7          |
| bugfix            | boolean                | false         | true (bugfixes only), false (full)                                                         | No              | -                  |
| cacheonly         | boolean                | false         | true (cache only), false (fetches)                                                         | No              | Added 2.12         |
| conf_file         | string                 | None          | Any path (custom config)                                                                   | No              | -                  |
| disable_excludes  | string                 | None          | 'all' (ignores all), repo ID (ignores for repo)                                            | No              | -                  |
| disable_gpg_check | boolean                | false         | true (skips GPG), false (enforces)                                                         | No              | -                  |
| disable_plugin    | list / elements=string | None          | Plugin names (disables specific)                                                           | No              | -                  |
| disable_repo      | list / elements=string | None          | Repo IDs (disables temp)                                                                   | No              | -                  |
| disablerepo       | list / elements=string | None          | Alias for disable_repo                                                                     | No              | -                  |
| download_dir      | string                 | None          | Any path (downloads there)                                                                 | No              | Added 2.8          |
| download_only     | boolean                | false         | true (downloads only), false (installs)                                                    | No              | Added 2.8          |
| enable_plugin     | list / elements=string | None          | Plugin names (enables specific)                                                            | No              | -                  |
| enablerepo        | list / elements=string | None          | Repo IDs (enables temp)                                                                    | No              | -                  |
| exclude           | list / elements=string | None          | Names/globs (skips)                                                                        | No              | -                  |
| install_repoquery | boolean                | true          | true (installs repoquery), false (assumes)                                                 | No              | -                  |
| install_weak_deps | boolean                | true          | true (includes suggests), false (minimal)                                                  | No              | Added 2.7          |
| installroot       | string                 | "/"           | Any path (chroot install)                                                                  | No              | -                  |
| list              | string                 | None          | 'available' (installable), 'installed' (installed), 'updates' (upgradable), name (details) | No              | -                  |
| lock_timeout      | integer                | 30            | Positive (wait seconds)                                                                    | No              | Added 2.8          |
| lockfile          | string                 | None          | Any path (custom lock)                                                                     | No              | Added 2.8          |
| name (pkg)        | list / elements=string | None          | Name/version/group/'^group'/list/URL/path (manages specified)                              | Yes for actions | -                  |
| releasever        | string                 | None          | Any version (overrides $releasever)                                                        | No              | -                  |
| security          | boolean                | false         | true (security only), false (full)                                                         | No              | -                  |
| skip_broken       | boolean                | false         | true (skips issues), false (fails)                                                         | No              | -                  |
| sslverify         | boolean                | true          | true (verifies SSL), false (disables)                                                      | No              | Added 2.5          |
| state             | string                 | present       | present/installed (installs), absent/removed (uninstalls), latest (upgrades)               | No              | -                  |
| update_cache      | boolean                | false         | true (updates cache), false (no)                                                           | No              | -                  |
| update_only       | boolean                | false         | true (updates existing), false (full)                                                      | No              | Added 2.7          |
| use_backend       | string                 | auto          | auto (system), yum (forces yum), dnf/dnf4/dnf5 (forces dnf)                                | No              | Added 2.17         |
| validate_certs    | boolean                | true          | true (verifies certs), false (disables)                                                    | No              | -                  |
