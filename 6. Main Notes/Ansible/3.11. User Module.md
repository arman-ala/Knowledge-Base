# 3.11. User Module

2025-08-13 21:07
Status: #DONE 
Tags: [[Ansible]]

---
### Understanding the Ansible User Module: A Comprehensive Guide

In the realm of DevOps automation, Ansible's tools for managing user accounts are essential for maintaining security, access control, and system consistency across remote hosts. The `ansible.builtin.user` module enables the creation, modification, or removal of user accounts, with options to configure attributes like groups, home directories, and SSH keys. This document offers a detailed exploration of the module, informed by its official documentation and practical considerations. It starts with a simplified overview for foundational understanding, followed by an in-depth analysis of its parameters, including all possible values and their effects, best practices, and illustrative examples with expected outputs.

#### Simplified Explanation: Breaking It Down Simply

Picture the `user` module as a user administrator for your servers: it can hire (create) a new employee (user) with a desk (home directory), assign a team (group), set a password policy, or even fire them (remove the account). You specify the user’s name, decide if they need a home, add them to groups, and handle details like SSH keys for secure access. For example, creating a user "jane" with a home directory and adding to "developers" group is straightforward, ensuring the account is set up without manual intervention. It promotes idempotency, so running it multiple times won’t create duplicates, making it reliable for automated setups.

#### In-Depth Analysis: Precise and Comprehensive Coverage

The `ansible.builtin.user` module, part of `ansible-core`, manages user accounts on POSIX platforms by leveraging system commands like `useradd`, `usermod`, and `userdel`. It supports creating (`state: present`) or removing (`state: absent`) users, configuring groups, home directories, passwords, and SSH keys. The module requires specific commands on the target host and offers full `check_mode` support for simulations, though no `diff_mode`. It is POSIX-oriented, with Windows equivalents in `ansible.windows.win_user`.

Evolutions include support for negative `expires` values since Ansible 2.6 to remove expiry, and additions like `password_expire_warn` and `password_expire_account_disable` since Ansible 2.18 for fine-grained password policies on Linux. The module integrates with `group` for cohesive management and emphasizes security through options like `password_lock`.

Each parameter is dissected below, including its purpose, type, default value, all possible values and their effects, requirements, and interactions. Best practices, tips, and tricks are provided, with examples and expected outputs for clarity.

- **append**: Controls group membership behavior when `groups` is specified. Type: boolean. Default: false. Possible values: true (adds user to specified groups without removing from others, effect: preserves existing memberships while extending access), false (replaces all memberships with specified groups, effect: removes from non-listed groups, potentially revoking unintended access). Required: No. Notes: Ignored if `groups` empty.

  Best practice: Use true for incremental additions to avoid disrupting access. Tip: Verify current groups with `getent group`; trick: Use with `register` to check post-change.

  Example: Append to groups.
  ```yaml
  - name: Append user to group
    ansible.builtin.user:
      name: jane
      groups: developers
      append: yes
  ```
  Expected output: Adds `jane` to `developers` without removing others (`changed: true` if added); return: `append: true`, `groups: "developers,existing"`.

- **authorization**: Sets user authorizations (e.g., sudo-like privileges). Type: string. Default: None. Possible values: Comma-separated strings (e.g., 'sudo ALL=(ALL) ALL', 'ALL'), '' (removes all, effect: revokes all authorizations). Required: No. Notes: Supported on Illumos/Solaris only; added in 2.8.

  Best practice: Use for fine-grained privileges on supported platforms. Tip: Format as per `visudo`; trick: Combine with `validate` in related tasks.

  Example: Set authorizations.
  ```yaml
  - name: Set user authorization
    ansible.builtin.user:
      name: bob
      authorization: 'sudo ALL=(ALL) ALL,other'
  ```
  Expected output: Applies authorizations (`changed: true`); no effect on non-Solaris; return: no specific field, but user updated.

- **comment**: Sets the GECOS field (user description). Type: string. Default: None (empty or name on macOS). Possible values: Any string (e.g., 'John Doe, IT Admin'). Required: No. Notes: Defaults to `name` on macOS.

  Best practice: Use for descriptive info in `/etc/passwd`. Tip: Keep concise; trick: Use variables for dynamic comments.

  Example: Set comment.
  ```yaml
  - name: Set user comment
    ansible.builtin.user:
      name: alice
      comment: 'Alice Wonderland, Developer'
  ```
  Expected output: Updates GECOS (`changed: true`); return: `comment: "Alice Wonderland, Developer"`.

- **create_home** (aliases: createhome): Creates a home directory if absent. Type: boolean. Default: true. Possible values: true (creates home, effect: ensures user has directory for files), false (no creation, effect: user without home, useful for system users). Required: No. Notes: Alias changed in 2.5.

  Best practice: Set false for non-interactive users. Tip: Use with `home`; trick: Pair with `file` for custom homes.

  Example: No home creation.
  ```yaml
  - name: Create user without home
    ansible.builtin.user:
      name: serviceuser
      create_home: no
  ```
  Expected output: Creates user without home (`changed: true`); return: `create_home: false`, `home: ""` or default.

- **expires**: Sets account expiry in epoch seconds. Type: float. Default: None (no expiry). Possible values: Positive epoch (e.g., 1735689600 for future date, effect: locks after time), negative (removes expiry, effect: perpetual account; since 2.6). Required: No. Notes: Supported on GNU/Linux, FreeBSD, DragonFlyBSD.

  Best practice: Use for temporary accounts. Tip: Calculate epoch with `date +%s`; trick: Use variables for dynamic dates.

  Example: Set expiry.
  ```yaml
  - name: Set user expiry
    ansible.builtin.user:
      name: tempuser
      expires: 1735689600
  ```
  Expected output: Sets expiry (`changed: true`); return: no specific field, but account locks post-date.

- **force**: Forces actions like removal or key overwrite. Type: boolean. Default: false. Possible values: true (forces delete with directories, overwrites SSH key, effect: complete cleanup), false (standard behavior). Required: No. Notes: For `state: absent` or `generate_ssh_key: yes`.

  Best practice: Use true for thorough removals. Tip: Check `man userdel`; trick: Use with `remove: yes`.

  Example: Force remove.
  ```yaml
  - name: Force user removal
    ansible.builtin.user:
      name: olduser
      state: absent
      force: yes
  ```
  Expected output: Removes user and directories (`changed: true`); return: `force: true`, `remove: true`.

- **generate_ssh_key**: Generates an SSH key pair for the user. Type: boolean. Default: false. Possible values: true (generates key, effect: creates `.ssh/id_rsa` and `.ssh/id_rsa.pub`), false (no action). Required: No. Notes: Overwrites if `force: yes`; sets `mode: 0600` on private key.

  Best practice: Use for secure key-based access. Tip: Specify `ssh_key_bits` for size; trick: Fetch public key with `register`.

  Example: Generate key.
  ```yaml
  - name: Generate SSH key
    ansible.builtin.user:
      name: secureuser
      generate_ssh_key: yes
  ```
  Expected output: Creates keys (`changed: true`); return: `ssh_key_file: "/home/secureuser/.ssh/id_rsa"`, `ssh_public_key`, `ssh_fingerprint`.

- **group**: Sets the primary group. Type: string. Default: None (system default, 'staff' on macOS). Possible values: Any group name. Required: No.

  Best practice: Set for access control. Tip: Ensure group exists; trick: Use with `groups` for secondary.

  Example: Set primary group.
  ```yaml
  - name: Set primary group
    ansible.builtin.user:
      name: bob
      group: admins
  ```
  Expected output: Sets primary group (`changed: true`); return: `group: 1002` (admins GID).

- **groups**: List of secondary groups. Type: list / elements=string. Default: None. Possible values: List of groups (e.g., ['wheel', 'docker']), '' (removes from all except primary). Required: No. Notes: Comma-separated string pre-2.3; use with `append`.

  Best practice: Use for role-based access. Tip: Avoid empty if preserving; trick: Query with `getent passwd`.

  Example: Set groups.
  ```yaml
  - name: Set secondary groups
    ansible.builtin.user:
      name: jane
      groups: developers,testers
  ```
  Expected output: Adds to groups (`changed: true`); return: `groups: "developers,testers"`.

- **hidden**: Hides user on macOS (login/preferences). Type: boolean. Default: false (visible). Possible values: true (hidden, effect: not shown in UI), false (visible). Required: No. Notes: Defaults true if `system: yes`; macOS only.

  Best practice: Use for system users. Tip: Check with `dscl`; trick: Use with `system`.

  Example: Hide user.
  ```yaml
  - name: Hide user
    ansible.builtin.user:
      name: hiddenuser
      hidden: yes
  ```
  Expected output: Hides user (`changed: true`); no return field, but user concealed.

- **home**: Sets home directory path. Type: path. Default: None (system default, e.g., `/home/name`). Possible values: Any path (e.g., `/var/users/name`). Required: No.

  Best practice: Customize for non-standard setups. Tip: Use with `create_home`; trick: Move with `move_home: yes`.

  Example: Custom home.
  ```yaml
  - name: Set home
    ansible.builtin.user:
      name: customhome
      home: /opt/users/customhome
  ```
  Expected output: Sets home (`changed: true`); return: `home: /opt/users/customhome`.

- **local**: Uses local user commands (e.g., `luseradd`). Type: boolean. Default: false. Possible values: true (local commands, effect: manages local users in centralized auth), false (system commands). Required: No. Notes: Requires commands; checks `/etc/passwd`.

  Best practice: Use in LDAP environments. Tip: Verify with `luseradd --version`; trick: Use for isolated users.

  Example: Local user.
  ```yaml
  - name: Create local user
    ansible.builtin.user:
      name: localuser
      local: yes
  ```
  Expected output: Uses `luseradd` (`changed: true`); return: standard fields.

- **login_class**: Sets BSD login class. Type: string. Default: None. Possible values: Any class (e.g., 'staff'). Required: No. Notes: Supported on FreeBSD, DragonFlyBSD, NetBSD, OpenBSD.

  Best practice: Use for resource limits. Tip: Check `/etc/login.conf`; trick: Use with `shell`.

  Example: Set login class.
  ```yaml
  - name: Set login class
    ansible.builtin.user:
      name: bsduser
      login_class: staff
  ```
  Expected output: Applies class (`changed: true`); no return field.

- **move_home**: Moves existing home if different. Type: boolean. Default: false. Possible values: true (moves home, effect: relocates directory), false (no move). Required: No. Notes: Requires `home` change.

  Best practice: Use for reorganization. Tip: Backup first; trick: Use with `create_home: false` if relocating.

  Example: Move home.
  ```yaml
  - name: Move home directory
    ansible.builtin.user:
      name: movinguser
      home: /new/home
      move_home: yes
  ```
  Expected output: Moves home (`changed: true`); return: `move_home: true`, `home: /new/home`.

- **name**: User account name. Type: string. Default: None. Possible values: Any valid username. Required: Yes. Notes: Must be unique.

  Best practice: Use consistent naming. Tip: Avoid reserved names; trick: Use variables.

  Example: Basic user.
  ```yaml
  - name: Create user
    ansible.builtin.user:
      name: newuser
  ```
  Expected output: Creates `newuser` (`changed: true`); return: `name: newuser`.

- **non_unique**: Allows non-unique UIDs. Type: boolean. Default: false. Possible values: true (allow duplicates, effect: shares UID), false (require unique). Required: No. Notes: Requires `uid`; unsupported on macOS/BusyBox; added in 2.8.

  Best practice: Avoid unless legacy. Tip: Check with `getent passwd`; trick: Use for testing.

  Example: Non-unique UID.
  ```yaml
  - name: Create with non-unique UID
    ansible.builtin.user:
      name: dupuser
      uid: 1001
      non_unique: yes
  ```
  Expected output: Creates with UID 1001 (`changed: true`); fails if unsupported.

- **password**: Sets encrypted password. Type: string. Default: None (no password). Possible values: Encrypted hash (e.g., from `mkpasswd`). Required: No. Notes: Not updated if same; returned masked.

  Best practice: Use encrypted hashes. Tip: Generate with `mkpasswd`; trick: Use `password_lock` for no-login.

  Example: Set password.
  ```yaml
  - name: Set password
    ansible.builtin.user:
      name: secureuser
      password: "$6$rounds=656000$saltsalt$hash"
  ```
  Expected output: Sets password (`changed: true`); return: `password: "NOT_LOGGING_PASSWORD"`.

- **password_lock**: Locks/unlocks password. Type: boolean. Default: None (no change). Possible values: true (locks, effect: prevents login with password), false (unlocks). Required: No. Notes: Supported on GNU/Linux, FreeBSD, macOS, NetBSD, OpenBSD.

  Best practice: Lock for key-only access. Tip: Use with `password`; trick: Combine with `ssh_key`.

  Example: Lock password.
  ```yaml
  - name: Lock user password
    ansible.builtin.user:
      name: lockeduser
      password_lock: yes
  ```
  Expected output: Locks account (`changed: true`); no return field.

- **profile**: Sets profile script. Type: string. Default: None. Possible values: Any path (e.g., '/etc/profile.d/custom.sh'). Required: No. Notes: Supported on AIX only.

  Best practice: Use for environment setups. Tip: Ensure script exists; trick: Use `copy` first.

  Example: Set profile.
  ```yaml
  - name: Set user profile
    ansible.builtin.user:
      name: aixuser
      profile: /etc/profile.d/custom.sh
  ```
  Expected output: Applies profile (`changed: true`); no return field.

- **remove**: Removes home and mail spool on deletion. Type: boolean. Default: false. Possible values: true (removes, effect: cleans up files), false (leaves files). Required: No. Notes: For `state: absent`; same as `userdel --remove`.

  Best practice: Use true for complete removal. Tip: Backup first; trick: Use with `force`.

  Example: Remove with cleanup.
  ```yaml
  - name: Remove user with files
    ansible.builtin.user:
      name: olduser
      state: absent
      remove: yes
  ```
  Expected output: Deletes user and files (`changed: true`); return: `remove: true`.

- **role**: Sets role (authorization) on AIX. Type: string. Default: None. Possible values: Any role. Required: No. Notes: AIX only.

  Similar to authorization; best practice: Align with AIX roles.

- **seuser**: Sets SELinux user mapping. Type: string. Default: None. Possible values: Any SELinux user (e.g., 'user_u'). Required: No. Notes: Requires libselinux-python.

  Best practice: Use in SELinux environments. Tip: Check with `semanage`; trick: Use with `setype`.

  Example: Set SEUser.
  ```yaml
  - name: Set SELinux user
    ansible.builtin.user:
      name: seluser
      seuser: user_u
  ```
  Expected output: Applies mapping (`changed: true`); no return field.

- **shell**: Sets login shell. Type: string. Default: None (system default). Possible values: Any shell path (e.g., '/bin/bash', '/usr/sbin/nologin'). Required: No.

  Best practice: Use '/usr/sbin/nologin' for no-login users. Tip: Ensure shell installed; trick: Use for service accounts.

  Example: Set shell.
  ```yaml
  - name: Set user shell
    ansible.builtin.user:
      name: noshelluser
      shell: /usr/sbin/nologin
  ```
  Expected output: Sets shell (`changed: true`); return: `shell: /usr/sbin/nologin`.

- **ssh_key_bits**: Bits for generated SSH key. Type: integer. Default: None (system default, e.g., 2048). Possible values: Valid key sizes (e.g., 2048, 4096). Required: No. Notes: For `generate_ssh_key: yes`.

  Best practice: Use 4096 for security. Tip: Higher bits slower; trick: Specify for compliance.

  Example: Custom key bits.
  ```yaml
  - name: Generate key with bits
    ansible.builtin.user:
      name: keyuser
      generate_ssh_key: yes
      ssh_key_bits: 4096
  ```
  Expected output: Generates 4096-bit key (`changed: true`); return: `ssh_fingerprint` reflects size.

- **ssh_key_comment**: Comment for SSH key. Type: string. Default: 'ansible-generated on $HOSTNAME'. Possible values: Any string. Required: No.

  Best practice: Use for identification. Tip: Include host/user; trick: Use variables.

  Example: Custom comment.
  ```yaml
  - name: Key with comment
    ansible.builtin.user:
      name: commentedkey
      generate_ssh_key: yes
      ssh_key_comment: 'Custom key for access'
  ```
  Expected output: Sets comment (`changed: true`); return: `ssh_public_key` includes comment.

- **ssh_key_file**: Path for SSH private key. Type: string. Default: None (`.ssh/id_rsa`). Possible values: Any path (e.g., `.ssh/custom_id`). Required: No.

  Best practice: Use defaults for standard setups. Tip: Ensure directory exists; trick: Use with `ssh_key_type`.

  Example: Custom key file.
  ```yaml
  - name: Custom key file
    ansible.builtin.user:
      name: customkey
      generate_ssh_key: yes
      ssh_key_file: .ssh/mykey
  ```
  Expected output: Creates at custom path (`changed: true`); return: `ssh_key_file: .ssh/mykey`.

- **ssh_key_passphrase**: Passphrase for encrypted SSH key. Type: string. Default: None (no encryption). Possible values: Any passphrase. Required: No.

  Best practice: Use for added security. Tip: Store in vault; trick: Avoid if keys are agent-managed.

  Example: Encrypted key.
  ```yaml
  - name: Generate encrypted key
    ansible.builtin.user:
      name: encrypteduser
      generate_ssh_key: yes
      ssh_key_passphrase: "secretpass"
  ```
  Expected output: Generates encrypted key (`changed: true`); return: no passphrase field (masked).

- **ssh_key_type**: Type of SSH key. Type: string. Default: rsa. Possible values: rsa, dsa, rsa1, ecdsa, ed25519. Required: No. Notes: Some deprecated (e.g., rsa1).

  Best practice: Use ed25519 for modern security. Tip: Check OpenSSH version; trick: Use with `ssh_key_bits`.

  Example: Ed25519 key.
  ```yaml
  - name: Ed25519 key
    ansible.builtin.user:
      name: eduser
      generate_ssh_key: yes
      ssh_key_type: ed25519
  ```
  Expected output: Generates ed25519 key (`changed: true`); return: `ssh_fingerprint` shows type.

- **state**: User’s desired presence. Type: string. Default: present. Possible values: present (create/update), absent (remove). Required: No.

  Best practice: Use absent for cleanup. Tip: Use with `force/remove`; trick: Check mode for preview.

  Example: Absent state.
  ```yaml
  - name: Remove user
    ansible.builtin.user:
      name: olduser
      state: absent
  ```
  Expected output: Removes user (`changed: true`); return: `state: absent`.

- **system**: Designates system user. Type: boolean. Default: false. Possible values: true (system user, effect: low UID, no aging), false (regular user). Required: No. Notes: Sets `hidden: true` on macOS.

  Best practice: Use for daemons. Tip: Low UIDs; trick: Use with `shell: /usr/sbin/nologin`.

  Example: System user.
  ```yaml
  - name: Create system user
    ansible.builtin.user:
      name: sysuser
      system: yes
  ```
  Expected output: Creates with low UID (`changed: true`); return: `system: true`, `uid` < 1000.

- **uid**: Sets user ID. Type: integer. Default: None (system assigns). Possible values: Any valid UID (e.g., 1000–60000). Required: No. Notes: Must be unique unless `non_unique`; unsupported on macOS/BusyBox.

  Best practice: Assign for consistency. Tip: Avoid low UIDs unless system; trick: Use `uid_min/max`.

  Example: Set UID.
  ```yaml
  - name: Set UID
    ansible.builtin.user:
      name: fixeduid
      uid: 1500
  ```
  Expected output: Sets UID 1500 (`changed: true`); return: `uid: 1500`.

- **uid_max**: Sets maximum UID for creation. Type: integer. Default: None (`/etc/login.defs`). Possible values: Any integer. Required: No. Notes: Linux only; added 2.18; ignored with `local: true`.

  Best practice: Enforce UID ranges. Tip: Align with policies; trick: Use with `uid_min`.

  Example: Set UID max.
  ```yaml
  - name: Create with UID max
    ansible.builtin.user:
      name: rangeduser
      uid_max: 50000
  ```
  Expected output: Assigns UID ≤ 50000 (`changed: true`); return: `uid` within range.

- **uid_min**: Sets minimum UID for creation. Type: integer. Default: None (`/etc/login.defs`). Possible values: Any integer. Required: No. Notes: Linux only; added 2.18; ignored with `local: true`.

  Best practice: Avoid system UID overlap. Tip: Start from 1000; trick: Use with `uid_max`.

  Example: Set UID min.
  ```yaml
  - name: Create with UID min
    ansible.builtin.user:
      name: minuser
      uid_min: 2000
  ```
  Expected output: Assigns UID ≥ 2000 (`changed: true`); return: `uid` within range.

- **umask**: Sets umask for user. Type: string. Default: None. Possible values: Octal string (e.g., '0022'). Required: No. Notes: Supported on FreeBSD, DragonFlyBSD, OpenBSD, NetBSD, Solaris.

  Best practice: Use for file permission defaults. Tip: Format as string; trick: Use with `profile`.

  Example: Set umask.
  ```yaml
  - name: Set umask
    ansible.builtin.user:
      name: umaskuser
      umask: '0077'
  ```
  Expected output: Sets umask (`changed: true`); no return field.

- **update_password**: Controls password updates. Type: string. Default: always. Possible values: always (updates if different), on_create (only on creation). Required: No. Notes: For `state: present` with `password`.

  Best practice: Use on_create for initial setup. Tip: Avoid always for production to prevent unnecessary changes; trick: Use with vaulted passwords.

  Example: Password on create.
  ```yaml
  - name: Password on create
    ansible.builtin.user:
      name: initpass
      password: "$6$hash"
      update_password: on_create
  ```
  Expected output: Sets password only if new (`changed: true` on create); no change later.

- **password_expire_max**: Days until password must change. Type: integer. Default: None. Possible values: Positive integer (e.g., 90), -1 (no expiry). Required: No. Notes: Linux only; added 2.18.

  Best practice: Enforce policy (e.g., 90 days). Tip: -1 disables; trick: Use with `password_expire_min`.

  Example: Set max expiry.
  ```yaml
  - name: Set password max expiry
    ansible.builtin.user:
      name: expireuser
      password_expire_max: 90
  ```
  Expected output: Sets max days (`changed: true`); no return field.

- **password_expire_min**: Minimum days between changes. Type: integer. Default: None. Possible values: Positive integer (e.g., 7), -1 (no min). Required: No. Notes: Linux only; added 2.18.

  Best practice: Prevent frequent changes. Tip: Balance with max; trick: Use for compliance.

  Example: Set min expiry.
  ```yaml
  - name: Set password min expiry
    ansible.builtin.user:
      name: minexpire
      password_expire_min: 7
  ```
  Expected output: Sets min days (`changed: true`).

- **password_expire_warn**: Days to warn before expiry. Type: integer. Default: None. Possible values: Positive integer (e.g., 7), -1 (no warn). Required: No. Notes: Linux only; added 2.18.

  Best practice: Give notice (e.g., 14 days). Tip: -1 disables; trick: Use with expiry params.

  Example from resource: Set warn.
  ```yaml
  - name: Set password warn
    ansible.builtin.user:
      name: jane157
      password_expire_warn: 30
  ```
  Expected output: Sets warn days (`changed: true`).

- **password_expire_account_disable**: Days after expiry to disable account. Type: integer. Default: None. Possible values: Positive integer (e.g., 30), -1 (no disable). Required: No. Notes: Linux only; added 2.18.

  Best practice: Grace period post-expiry. Tip: -1 keeps active; trick: Use for temporary accounts.

  Example from resource: Set disable.
  ```yaml
  - name: Set account disable
    ansible.builtin.user:
      name: jimholden2016
      password_expire_account_disable: 15
  ```
  Expected output: Sets disable days (`changed: true`).

## Additional Examples for the Ansible User Module

#### Example 1: Creating a User with Multiple Groups and SSH Key
```yaml
- name: Create developer user with SSH key and multiple groups
  ansible.builtin.user:
    name: devuser
    comment: "Developer Account"
    groups: 
      - developers
      - docker
      - sudo
    append: yes
    shell: /bin/bash
    generate_ssh_key: yes
    ssh_key_bits: 4096
    ssh_key_type: ed25519
    ssh_key_comment: "devuser@{{ inventory_hostname }}"
    password: "$6$rounds=656000$saltsalt$hash"
    update_password: on_create
```
**Explanation**: This creates a developer user with multiple groups (developers, docker, sudo) using `append: yes` to preserve existing group memberships. It generates an ED25519 SSH key with 4096 bits and a custom comment. The password is set only on creation (`update_password: on_create`). Output shows `changed: true` if the user was created, with SSH key details and group information in the return values.

#### Example 2: Creating a System User with No Home Directory
```yaml
- name: Create system user for service
  ansible.builtin.user:
    name: serviceaccount
    system: yes
    create_home: no
    shell: /usr/sbin/nologin
    comment: "Service Account for Application"
    groups: servicegroup
```
**Explanation**: This creates a system user for running services. The `system: yes` parameter assigns a low UID and marks it as a system account. No home directory is created (`create_home: no`), and the shell is set to `/usr/sbin/nologin` to prevent login. The user is added to the servicegroup. Output shows `changed: true` if the user was created, with `system: true` and `uid` < 1000 in the return values.

#### Example 3: Modifying User with Password Expiry Settings
```yaml
- name: Configure user with password expiry policy
  ansible.builtin.user:
    name: policyuser
    password_expire_max: 90
    password_expire_min: 7
    password_expire_warn: 14
    password_expire_account_disable: 30
    password_lock: no
```
**Explanation**: This configures password expiry settings for an existing user. The password must be changed every 90 days, with a minimum of 7 days between changes. Users are warned 14 days before expiry, and the account is disabled 30 days after expiry. The password is unlocked (`password_lock: no`). Output shows `changed: true` if any settings were modified, with no specific return fields for these parameters.

#### Example 4: Creating a User with Custom Home Directory and Moving Existing Home
```yaml
- name: Create user with custom home and move existing
  ansible.builtin.user:
    name: customhomeuser
    home: /opt/customhome
    move_home: yes
    create_home: yes
    comment: "User with Custom Home Directory"
    shell: /bin/bash
```
**Explanation**: This creates a user with a custom home directory at `/opt/customhome`. If the user already exists with a different home directory, `move_home: yes` moves the existing home directory to the new location. The home directory is created if it doesn't exist. Output shows `changed: true` if the user was created or the home was moved, with `move_home: true` and the custom home path in the return values.

#### Example 5: Creating a User with SELinux Context
```yaml
- name: Create user with SELinux mapping
  ansible.builtin.user:
    name: selinuxuser
    comment: "User with SELinux Context"
    shell: /bin/bash
    seuser: staff_u
    groups: users
```
**Explanation**: This creates a user with a specific SELinux user mapping (`staff_u`). The user is added to the users group and uses the Bash shell. This is useful in environments with strict SELinux policies. Output shows `changed: true` if the user was created, with no specific return field for the SELinux context.

#### Example 6: Creating a User with Non-Unique UID
```yaml
- name: Create user with non-unique UID
  ansible.builtin.user:
    name: shareduiduser
    uid: 1500
    non_unique: yes
    comment: "User sharing UID"
    groups: sharedgroup
```
**Explanation**: This creates a user with a specific UID (1500) that may already be in use by another user (`non_unique: yes`). This is useful in legacy systems where UID sharing is required. The user is added to the sharedgroup. Output shows `changed: true` if the user was created, with `uid: 1500` and `non_unique: true` in the return values.

#### Example 7: Creating a User with Encrypted SSH Key
```yaml
- name: Create user with encrypted SSH key
  ansible.builtin.user:
    name: secureuser
    generate_ssh_key: yes
    ssh_key_type: rsa
    ssh_key_bits: 4096
    ssh_key_file: .ssh/encrypted_key
    ssh_key_passphrase: "SuperSecretPassphrase"
    ssh_key_comment: "Encrypted key for {{ inventory_hostname }}"
```
**Explanation**: This creates a user and generates an encrypted RSA SSH key with 4096 bits. The key is stored at `.ssh/encrypted_key` and protected with a passphrase. The comment includes the hostname for identification. Output shows `changed: true` if the user and key were created, with SSH key details in the return values (though the passphrase is masked).

#### Example 8: Creating a User with UID Range Constraints
```yaml
- name: Create user within UID range
  ansible.builtin.user:
    name: rangeduser
    uid_min: 2000
    uid_max: 2999
    comment: "User with UID in range"
    groups: users
```
**Explanation**: This creates a user with a UID constrained between 2000 and 2999. The module automatically selects an available UID within this range. This is useful for maintaining consistent UID assignments across systems. Output shows `changed: true` if the user was created, with the assigned UID in the return values (e.g., `uid: 2045`).

#### Example 9: Force Removing a User with Home Directory
```yaml
- name: Force remove user and home directory
  ansible.builtin.user:
    name: olduser
    state: absent
    remove: yes
    force: yes
```
**Explanation**: This forcefully removes a user and their home directory. The `remove: yes` parameter deletes the home directory and mail spool, while `force: yes` ensures removal even if the user is the primary group for other users. Output shows `changed: true` if the user was removed, with `remove: true` and `force: true` in the return values.

#### Example 10: Creating a User with BSD-Specific Settings
```yaml
- name: Create user with BSD login class and umask
  ansible.builtin.user:
    name: bsduser
    comment: "BSD User with Custom Settings"
    shell: /bin/csh
    login_class: staff
    umask: '0022'
    groups: wheel
```
**Explanation**: This creates a user with BSD-specific settings. The user is assigned to the `staff` login class (for resource limits) and has a custom umask of `0022`. The shell is set to `/bin/csh` and the user is added to the wheel group (for administrator access). Output shows `changed: true` if the user was created, with no specific return fields for the BSD-specific parameters.
#### Summary Table of Arguments

| Argument Name | Type | Default Value | Possible Values and Effects | Required | Notes/Deprecations |
|---------------|------|---------------|------------------------------|----------|--------------------|
| append | boolean | false | true (adds to groups without removal, effect: extends memberships), false (replaces all groups, effect: revokes non-listed) | No | Ignored if groups empty |
| authorization | string | None | Comma-separated strings (e.g., 'sudo ALL=(ALL) ALL', effect: sets privileges), '' (removes all, effect: revokes) | No | Solaris only; added 2.8 |
| comment | string | None | Any string (effect: sets GECOS description), defaults to name on macOS | No | - |
| create_home (createhome) | boolean | true | true (creates home, effect: provides directory), false (no creation, effect: no home) | No | Alias changed 2.5 |
| expires | float | None | Positive epoch (effect: sets expiry date), negative (effect: removes expiry; since 2.6) | No | GNU/Linux, FreeBSD, DragonFlyBSD |
| force | boolean | false | true (forces delete/overwrites, effect: complete cleanup), false (standard) | No | With state: absent or generate_ssh_key |
| generate_ssh_key | boolean | false | true (generates key, effect: creates pair), false (no action) | No | Overwrites with force: yes |
| group | string | None | Any group (effect: sets primary), 'staff' on macOS | No | - |
| groups | list / elements=string | None | List of groups (effect: sets secondary), '' (removes all except primary) | No | Comma string pre-2.3 |
| hidden | boolean | false | true (hides user, effect: not in UI), false (visible); true if system: yes | No | macOS only |
| home | path | None | Any path (effect: sets home directory) | No | - |
| local | boolean | false | true (uses local commands, effect: local users in central auth), false (system) | No | Requires local commands |
| login_class | string | None | Any class (effect: sets resource limits) | No | BSD only |
| move_home | boolean | false | true (moves home, effect: relocates), false (no move) | No | With home change |
| name | string | None | Any username (effect: account name) | Yes | - |
| non_unique | boolean | false | true (allows duplicate UID, effect: shares ID), false (unique) | No | With uid; added 2.8 |
| password | string | None | Encrypted hash (effect: sets password) | No | Masked in return |
| password_lock | boolean | None | true (locks, effect: no password login), false (unlocks) | No | GNU/Linux, FreeBSD, macOS, etc. |
| profile | string | None | Any path (effect: sets profile script) | No | AIX only |
| remove | boolean | false | true (removes home/mail, effect: cleanup), false (leaves) | No | With state: absent |
| role | string | None | Any role (effect: sets authorization) | No | AIX only |
| seuser | string | None | Any SELinux user (effect: maps user) | No | Requires libselinux-python |
| shell | string | None | Any shell path (effect: sets login shell) | No | - |
| ssh_key_bits | integer | None | Valid sizes (e.g., 2048, effect: key strength) | No | With generate_ssh_key |
| ssh_key_comment | string | 'ansible-generated on $HOSTNAME' | Any string (effect: key comment) | No | With generate_ssh_key |
| ssh_key_file | string | None | Any path (effect: key location) | No | With generate_ssh_key |
| ssh_key_passphrase | string | None | Any passphrase (effect: encrypts key) | No | With generate_ssh_key |
| ssh_key_type | string | rsa | rsa, dsa, rsa1, ecdsa, ed25519 (effect: key algorithm) | No | With generate_ssh_key |
| state | string | present | present (create/update), absent (remove) | No | - |
| system | boolean | false | true (system user, effect: low UID/no aging), false (regular) | No | hidden: true on macOS |
| uid | integer | None | Any UID (effect: sets user ID) | No | Unique unless non_unique |
| uid_max | integer | None | Any integer (effect: max UID assigned) | No | Linux only; added 2.18 |
| uid_min | integer | None | Any integer (effect: min UID assigned) | No | Linux only; added 2.18 |
| umask | string | None | Octal string (effect: default file perms) | No | BSD/Solaris only |
| update_password | string | always | always (updates if different), on_create (only on creation) | No | With password |
| password_expire_max | integer | None | Positive (effect: days to change), -1 (no max) | No | Linux only; added 2.18 |
| password_expire_min | integer | None | Positive (effect: min days between changes), -1 (no min) | No | Linux only; added 2.18 |
| password_expire_warn | integer | None | Positive (effect: warn days before expiry), -1 (no warn) | No | Linux only; added 2.18 |
| password_expire_account_disable | integer | None | Positive (effect: disable days post-expiry), -1 (no disable) | No | Linux only; added 2.18
