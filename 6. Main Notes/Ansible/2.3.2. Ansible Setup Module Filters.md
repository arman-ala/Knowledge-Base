# 2.3.2. Ansible Setup Module Filters

2025-08-06 20:01
Status: #DONE
Tags: [[Ansible]]

---
# Optimizing Fact Gathering with Ansible’s `setup` Module: A Comprehensive Guide

## For the Curious Minds

The `setup` module in Ansible functions as a meticulous data collector, gathering extensive system information (facts) from managed nodes, such as CPU specifications, network configurations, and operating system details. Without optimization, it generates a voluminous dataset, potentially slowing down playbook execution. By employing filtering techniques and subset controls, administrators can focus on essential data, significantly enhancing performance and reducing resource consumption. This targeted approach ensures playbooks execute efficiently while providing only the necessary insights.

## Diving Deeper: Optimization Mechanics

The `setup` module collects a wide array of facts, which can be resource-intensive, particularly in large-scale environments. Optimization techniques, including the `filter` and `gather_subset` parameters, fact caching, and parallel execution, allow precise control over data collection, minimizing performance overhead. Below, we explore these methods, covering all possible fact categories and providing sample outputs for clarity.

### 1. Wildcard Patterns (`*`) for Broad Filtering

Wildcard patterns utilize Unix-style matching to group related facts efficiently:

- `*`: Matches any sequence of characters.
- `?`: Matches a single character.

**Example**:

```bash
ansible all -m ansible.builtin.setup -a "filter=ansible_*_mb"
```

**Sample Output**:

```json
{
  "ansible_facts": {
    "ansible_memtotal_mb": 2924,
    "ansible_swapfree_mb": 1481,
    "ansible_memfree_mb": 898
  }
}
```

**Explanation**: This command retrieves memory-related facts (e.g., total, free, swap memory). Wildcards are ideal for grouping related facts, such as `ansible_*_ipv*` for IP addresses.  
**Optimization Benefit**: Reduces data collection to specific fact groups, minimizing processing time.  
**Best Practice**: Use wildcards for broad categories (e.g., `ansible_*_mb` for memory stats) in resource-constrained environments.

### 2. Regular Expressions (`~`) for Complex Patterns

Regular expressions, prefixed with `~`, enable intricate filtering using Python regex syntax:

- `^`: Denotes the start of a string.
- `.*`: Matches any characters.
- Escape special characters (e.g., `\.` for a literal dot).

**Example**:

```bash
ansible all -m ansible.builtin.setup -a "filter=~^(ansible_env|ansible_python).*"
```

**Sample Output**:

```json
{
  "ansible_facts": {
    "ansible_env": {
      "HOME": "/home/arman_ala_ansible",
      "LANG": "en_US.UTF-8",
      "PATH": "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin",
      "PWD": "/home/arman_ala_ansible",
      "SHELL": "/bin/bash",
      "TERM": "xterm-256color",
      "USER": "arman_ala_ansible"
    },
    "ansible_python": {
      "executable": "/usr/bin/python3",
      "has_sslcontext": true,
      "type": "cpython",
      "version": {
        "major": 3,
        "minor": 12,
        "micro": 3,
        "releaselevel": "final",
        "serial": 0
      }
    }
  }
}
```

**Explanation**: This regex pattern matches facts starting with `ansible_env` or `ansible_python`, collecting environment variables and Python details.  
**Optimization Benefit**: Limits data to specific categories, avoiding irrelevant details.  
**Tip**: Validate regex patterns locally using Python’s `re` module to ensure accuracy.

### 3. Explicit Fact Names for Precision

Specifying exact fact names retrieves only critical data, ideal for targeted use cases.

**Example**:

```bash
ansible all -m ansible.builtin.setup -a "filter=ansible_distribution,ansible_distribution_version"
```

**Sample Output**:

```json
{
  "ansible_facts": {
    "ansible_distribution": "Ubuntu",
    "ansible_distribution_version": "24.04"
  }
}
```

**Explanation**: This command retrieves only the distribution name and version, useful for OS-specific tasks.  
**Optimization Benefit**: Minimizes output to specific facts, reducing processing time.  
**Best Practice**: Use explicit names for playbooks requiring precise data (e.g., OS version checks).

### 4. Combining Multiple Filters

Chain multiple fact names in a comma-separated list to collect diverse data.

**Example**:

```bash
ansible all -m ansible.builtin.setup -a "filter=ansible_devices,ansible_processor"
```

**Sample Output**:

```json
{
  "ansible_facts": {
    "ansible_devices": {
      "sda": {
        "model": "VMware Virtual S",
        "size": "10.00 GB",
        "rotational": true,
        "holders": [],
        "host": "SCSI storage controller: Broadcom / LSI 53c1030 PCI-X Fusion-MPT Dual Ultra320 SCSI (rev 01)",
        "vendor": "VMware,"
      }
    },
    "ansible_processor": [
      "GenuineIntel",
      "Intel(R) Core(TM) i9-14900HX"
    ]
  }
}
```

**Explanation**: This collects disk device details and CPU information, avoiding extraneous facts.  
**Optimization Benefit**: Limits data to hardware and CPU facts, maintaining performance.  
**Tip**: Restrict to two or three filters to preserve performance gains.

### 5. `gather_subset` for Category-Based Optimization

The `gather_subset` parameter allows inclusion or exclusion of fact categories, offering coarse-grained control.

**Syntax**:

```yaml
- name: Gather selective facts
  ansible.builtin.setup:
    gather_subset:
      - "!all"          # Exclude all facts
      - "network"       # Include network facts
      - "!virtual"      # Exclude virtualization facts
```

**Example**:

```bash
ansible all -m ansible.builtin.setup -a "gather_subset=['min', '!all']"
```

**Sample Output**:

```json
{
  "ansible_facts": {
    "ansible_hostname": "armanalaansiblehost2",
    "ansible_default_ipv4": {
      "address": "192.168.1.6",
      "gateway": "192.168.1.1",
      "interface": "ens33",
      "macaddress": "00:0c:29:23:4a:95",
      "mtu": 1500,
      "netmask": "255.255.255.0",
      "network": "192.168.1.0",
      "prefix": "24",
      "type": "ether"
    }
  }
}
```

**Explanation**: This collects only minimal facts (e.g., hostname, default IPv4), reducing data volume.  
**Optimization Benefit**: Significantly reduces data collection, ideal for large-scale deployments.  
**Best Practice**: Combine `!all` with specific subsets (e.g., `network`, `hardware`) to tailor collection.

### 6. Fact Caching for Repeated Use

Caching facts avoids redundant gathering across tasks or playbooks.

**Configuration**: Enable in `ansible.cfg`:

```ini
[defaults]
fact_caching = jsonfile
fact_caching_timeout = 86400  # Cache for 24 hours
fact_cache_dir = /tmp/ansible_cache
```

**Example**:

```yaml
- name: Use cached facts
  ansible.builtin.setup:
    cacheable: yes
    filter: ansible_distribution
```

**Sample Output**:

```json
{
  "ansible_facts": {
    "ansible_distribution": "Ubuntu"
  }
}
```

**Explanation**: Facts are cached in `/tmp/ansible_cache`, reused in subsequent tasks.  
**Optimization Benefit**: Eliminates repeated `setup` calls, boosting performance.  
**Tip**: Clear cache (`rm -rf /tmp/ansible_cache/*`) if facts become outdated.

### 7. Parallel Fact Gathering

Adjust concurrency to optimize multi-host operations.

**Example**:

```bash
ansible all -m ansible.builtin.setup -f 20 -a "filter=ansible_hostname"
```

**Sample Output**:

```json
{
  "ansible_facts": {
    "ansible_hostname": "armanalaansiblehost2"
  }
}
```

**Explanation**: Increases forks to 20, speeding up fact collection across multiple hosts.  
**Optimization Benefit**: Enhances performance in large environments.  
**Best Practice**: Tune `-f` based on system resources to avoid overload.

### Comprehensive List of Fact Categories

The `setup` module supports a wide range of fact categories, which can be filtered using `filter` or `gather_subset`. Below is a comprehensive list of possible values, as derived from Ansible documentation ([https://docs.ansible.com/ansible/latest/collections/ansible/builtin/setup_module.html](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/setup_module.html)):

|Fact Category|Description|Example Output|
|---|---|---|
|`ansible_all_ipv4_addresses`|All IPv4 addresses on the host|`["192.168.1.6", "172.17.0.1"]`|
|`ansible_all_ipv6_addresses`|All IPv6 addresses on the host|`["fe80::20c:29ff:fe23:4a95"]`|
|`ansible_apparmor`|AppArmor status|`{"status": "enabled"}`|
|`ansible_architecture`|System architecture|`"x86_64"`|
|`ansible_bios_date`|BIOS date|`"11/12/2020"`|
|`ansible_bios_vendor`|BIOS vendor|`"Phoenix Technologies LTD"`|
|`ansible_bios_version`|BIOS version|`"6.00"`|
|`ansible_board_asset_tag`|Motherboard asset tag|`"NA"`|
|`ansible_board_name`|Motherboard name|`"440BX Desktop Reference Platform"`|
|`ansible_board_serial`|Motherboard serial number|`"NA"`|
|`ansible_board_vendor`|Motherboard vendor|`"Intel Corporation"`|
|`ansible_board_version`|Motherboard version|`"None"`|
|`ansible_chassis_asset_tag`|Chassis asset tag|`"No Asset Tag"`|
|`ansible_chassis_serial`|Chassis serial number|`"NA"`|
|`ansible_chassis_vendor`|Chassis vendor|`"No Enclosure"`|
|`ansible_chassis_version`|Chassis version|`"N/A"`|
|`ansible_cmdline`|Kernel command line parameters|`{"BOOT_IMAGE": "/vmlinuz-6.8.0-71-generic", "ro": true}`|
|`ansible_date_time`|System date and time|`{"date": "2025-08-06", "time": "16:17:46"}`|
|`ansible_default_ipv4`|Default IPv4 configuration|`{"address": "192.168.1.6", "gateway": "192.168.1.1"}`|
|`ansible_default_ipv6`|Default IPv6 configuration|`{}`|
|`ansible_device_links`|Device link information|`{"ids": {"dm-0": ["dm-name-ubuntu--vg-ubuntu--lv"]}}`|
|`ansible_devices`|Disk devices|`{"sda": {"size": "10.00 GB"}}`|
|`ansible_distribution`|OS distribution|`"Ubuntu"`|
|`ansible_distribution_file_parsed`|OS release file parsed status|`true`|
|`ansible_distribution_file_path`|Path to OS release file|`"/etc/os-release"`|
|`ansible_distribution_file_variety`|OS release file variety|`"Debian"`|
|`ansible_distribution_major_version`|Major OS version|`"24"`|
|`ansible_distribution_release`|OS release codename|`"noble"`|
|`ansible_distribution_version`|OS version|`"24.04"`|
|`ansible_dns`|DNS configuration|`{"nameservers": ["127.0.0.53"]}`|
|`ansible_effective_group_id`|Effective group ID|`1000`|
|`ansible_effective_user_id`|Effective user ID|`1000`|
|`ansible_env`|Environment variables|`{"HOME": "/home/arman_ala_ansible"}`|
|`ansible_fibre_channel_wwn`|Fibre Channel WWN|`[]`|
|`ansible_fips`|FIPS mode status|`false`|
|`ansible_form_factor`|System form factor|`"Other"`|
|`ansible_fqdn`|Fully qualified domain name|`"armanalaansiblehost2"`|
|`ansible_hostname`|Hostname|`"armanalaansiblehost2"`|
|`ansible_hostnqn`|NVMe host NQN|`""`|
|`ansible_interfaces`|Network interfaces|`["lo", "ens33", "docker0"]`|
|`ansible_is_chroot`|Chroot environment status|`false`|
|`ansible_iscsi_iqn`|iSCSI initiator name|`""`|
|`ansible_kernel`|Kernel version|`"6.8.0-71-generic"`|
|`ansible_kernel_version`|Full kernel version|`"#71-Ubuntu SMP PREEMPT_DYNAMIC Tue Jul 22 16:52:38 UTC 2025"`|
|`ansible_loadavg`|System load averages|`{"1m": 0.11572265625, "5m": 0.11962890625}`|
|`ansible_local`|Local facts|`{}`|
|`ansible_locally_reachable_ips`|Locally reachable IPs|`{"ipv4": ["127.0.0.1", "192.168.1.6"]}`|
|`ansible_lsb`|LSB release information|`{"id": "Ubuntu", "release": "24.04"}`|
|`ansible_lvm`|LVM configuration|`"N/A"`|
|`ansible_machine`|Machine type|`"x86_64"`|
|`ansible_machine_id`|Machine ID|`"8cf5872588c24b94bf9f08f094491d90"`|
|`ansible_memfree_mb`|Free memory in MB|`898`|
|`ansible_memory_mb`|Memory details|`{"real": {"free": 898, "total": 2924}}`|
|`ansible_memtotal_mb`|Total memory in MB|`2924`|
|`ansible_mounts`|Mounted filesystems|`[{"mount": "/", "size_total": 8610254848}]`|
|`ansible_nodename`|Node name|`"armanalaansiblehost2"`|
|`ansible_os_family`|OS family|`"Debian"`|
|`ansible_pkg_mgr`|Package manager|`"apt"`|
|`ansible_proc_cmdline`|Process command line|`{"BOOT_IMAGE": "/vmlinuz-6.8.0-71-generic"}`|
|`ansible_processor`|Processor details|`["GenuineIntel", "Intel(R) Core(TM) i9-14900HX"]`|
|`ansible_processor_cores`|CPU cores|`2`|
|`ansible_processor_count`|CPU count|`2`|
|`ansible_processor_nproc`|Number of processors|`4`|
|`ansible_processor_threads_per_core`|Threads per core|`1`|
|`ansible_processor_vcpus`|Virtual CPUs|`4`|
|`ansible_product_name`|Product name|`"VMware Virtual Platform"`|
|`ansible_product_serial`|Product serial number|`"NA"`|
|`ansible_product_uuid`|Product UUID|`"NA"`|
|`ansible_product_version`|Product version|`"None"`|
|`ansible_python`|Python interpreter details|`{"executable": "/usr/bin/python3"}`|
|`ansible_python_version`|Python version|`"3.12.3"`|
|`ansible_real_group_id`|Real group ID|`1000`|
|`ansible_real_user_id`|Real user ID|`1000`|
|`ansible_selinux`|SELinux status|`{"status": "disabled"}`|
|`ansible_selinux_python_present`|SELinux Python support|`true`|
|`ansible_service_mgr`|Service manager|`"systemd"`|
|`ansible_ssh_host_key_dsa_public`|DSA SSH host key|`""`|
|`ansible_ssh_host_key_ecdsa_public`|ECDSA SSH host key|`"AAAAE2VjZHNhLXNoYTItbmlzdHAyNTY..."`|
|`ansible_ssh_host_key_ed25519_public`|ED25519 SSH host key|`"AAAAC3NzaC1lZDI1NTE5AAAAINoFnQqz..."`|
|`ansible_ssh_host_key_rsa_public`|RSA SSH host key|`"AAAAB3NzaC1yc2EAAAADAQABAAABgQC2n6AD..."`|
|`ansible_ssh_host_pub_keys`|All SSH public keys|`[]`|
|`ansible_swapfree_mb`|Free swap memory in MB|`1481`|
|`ansible_swaptotal_mb`|Total swap memory in MB|`1481`|
|`ansible_system`|System type|`"Linux"`|
|`ansible_system_capabilities`|System capabilities|`[""]`|
|`ansible_system_capabilities_enforced`|Capabilities enforcement|`"True"`|
|`ansible_system_vendor`|System vendor|`"VMware, Inc."`|
|`ansible_uptime_seconds`|System uptime in seconds|`2657`|
|`ansible_user_dir`|User home directory|`"/home/arman_ala_ansible"`|
|`ansible_user_gecos`|User GECOS field|`"Arman Ala"`|
|`ansible_user_gid`|User group ID|`1000`|
|`ansible_user_id`|User ID|`"arman_ala_ansible"`|
|`ansible_user_shell`|User shell|`"/bin/bash"`|
|`ansible_user_uid`|User UID|`1000`|
|`ansible_userspace_architecture`|Userspace architecture|`"x86_64"`|
|`ansible_userspace_bits`|Userspace bits|`"64"`|
|`ansible_virtualization_role`|Virtualization role|`"guest"`|
|`ansible_virtualization_tech_guest`|Guest virtualization tech|`["VMware"]`|
|`ansible_virtualization_tech_host`|Host virtualization tech|`[]`|
|`ansible_virtualization_type`|Virtualization type|`"VMware"`|

### Pro Tips & Tricks for Optimization

1. **Pre-Filtering**: Apply `filter` or `gather_subset` before execution to minimize data collection overhead. Avoid `gather_subset: all` in production environments.
2. **Incremental Gathering**: Start with `gather_subset: min`, adding specific subsets (e.g., `network`) as needed.
3. **Debugging Efficiency**:
    
    ```bash
    ansible localhost -m ansible.builtin.setup -a "filter=ansible_default_ipv4"
    ```
    
    - Quickly verifies primary IP without collecting full facts.
4. **Playbook Optimization Example**:
    
    ```yaml
    - name: Optimize disk fact collection
      hosts: all
      tasks:
        - name: Gather only disk facts
          ansible.builtin.setup:
            gather_subset: "!all"
            filter: "ansible_devices"
          register: disk_facts
        - name: Display disk sizes
          ansible.builtin.debug:
            msg: "{{ item.value.size }}"
          loop: "{{ disk_facts.ansible_facts.ansible_devices | dict2items }}"
    ```
    
    - **Benefit**: Collects only disk data, reducing execution time and memory usage.
5. **Monitor Performance**: Use `time ansible-playbook playbook.yml` to measure `setup` impact and adjust filters accordingly.
6. **Cache Validation**: Periodically validate cached facts against live data to ensure accuracy in dynamic environments.
7. **Combine Techniques**: Use `filter` with `gather_subset` for fine-grained control, e.g., `gather_subset: network` with `filter: ansible_default_ipv4`.

### Summary Table: Optimization Techniques

|**Technique**|**Syntax Example**|**Use Case**|**Performance Gain**|
|---|---|---|---|
|**Wildcards**|`filter=ansible_*_mb`|Memory stats collection|Moderate (targets groups)|
|**Regex**|`filter=~^ansible_env.*`|Environment and Python facts|High (complex patterns)|
|**Explicit Names**|`filter=ansible_distribution`|Single fact retrieval|High (minimal data)|
|**Multiple Filters**|`filter=ansible_devices,ansible_processor`|Hardware and CPU data|Moderate (limited scope)|
|**`gather_subset`**|`gather_subset: ['min', '!all']`|Minimal facts only|Very High (category control)|
|**Fact Caching**|`cacheable: yes` (in playbook)|Reuse facts across tasks|Very High (eliminates calls)|
|**Parallel Gathering**|`-f 20`|Speed up multi-host collection|High (concurrency boost)|

### Conclusion

Optimizing the `setup` module through filters, `gather_subset`, caching, and parallel execution transforms fact-gathering into a precise, efficient process. By leveraging the comprehensive list of fact categories and applying targeted filtering techniques, administrators can significantly reduce playbook execution time and resource usage. These strategies ensure Ansible remains a powerful and scalable tool for automation, even in large and complex infrastructures. For further details, refer to the Ansible documentation: [https://docs.ansible.com/ansible/latest/collections/ansible/builtin/setup_module.html](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/setup_module.html).