# 2.10.8. Variables Priorities Part 2

2025-08-11 23:12
Status: #DONE 
Tags: [[Ansible]]

---
# Ansible Variable Precedence: A Unified Guide for DevOps Practitioners

## Introduction

In Ansible, variables are essential for creating flexible and reusable automation workflows. Understanding variable precedence—how Ansible determines which variable definition to use when the same variable is defined in multiple locations—is critical for predictable configuration management. This article consolidates the precedence rules for all variable sources discussed previously, including command-line extra variables, task-level variables (e.g., `set_fact`), role variables, external variable files (`vars_files`), playbook variables, inventory host and group variables, and role defaults. We provide a single comprehensive example to illustrate these concepts and a unified table summarizing all precedence levels, ensuring clarity for DevOps practitioners.

## In Simple Terms: The Variable Pecking Order

Picture a busy kitchen where chefs are competing to decide the menu. The head chef (command-line variables) gets the final say, followed by the sous-chef (task variables), line cooks (role variables), and so on, down to the prep cooks (role defaults). If multiple chefs suggest different ingredients for the same dish, the highest-ranking chef’s choice wins. In Ansible, variables work the same way: each source has a rank, and the highest-ranking source determines the final value. By knowing this order, you can ensure your automation recipes turn out exactly as planned.

## In-Depth Analysis: Variable Precedence in Ansible

Ansible’s variable precedence hierarchy governs which definition of a variable is used when multiple sources define the same variable. Below, we present a single comprehensive example that incorporates all variable sources, followed by a detailed explanation and a unified table summarizing precedence levels.

### Comprehensive Example

**Directory Structure:**
```
.
├── inventory
│   └── hosts.yml
├── project.yml
├── vars
│   ├── vars1.yml
│   └── vars2.yml
└── roles
    └── myrole
        ├── defaults
        │   └── main.yml
        ├── tasks
        │   └── main.yml
        └── vars
            └── main.yml
```

**File Contents:**

**inventory/hosts.yml:**
```yaml
all:
  hosts:
    localhost:
      ansible_connection: local
      app_status: "inventory_host_defined_status"
  vars:
    app_status: "inventory_group_defined_status"
```
**Explanation**: Defines `app_status` at both host (`inventory_host_defined_status`) and group (`inventory_group_defined_status`) levels. Host variables have higher precedence than group variables.

**project.yml:**
```yaml
---
- name: Test variable precedence
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    app_status: "playbook_defined_status"

  vars_files:
    - vars/vars1.yml
    - vars/vars2.yml

  roles:
    - myrole

  tasks:
    - name: Display final value of app_status
      debug:
        msg: "Final value of app_status: {{ app_status }}"
      tags: var_priority
```
**Explanation**: Defines `app_status` in the playbook’s `vars` section and includes two external variable files. The `debug` task outputs the final value, tagged for selective execution.

**vars/vars1.yml:**
```yaml
app_status: "vars1_defined_status"
```
**Explanation**: Sets `app_status` for the first external file, loaded before `vars2.yml`.

**vars/vars2.yml:**
```yaml
app_status: "vars2_defined_status"
```
**Explanation**: Sets `app_status` for the second external file, overriding `vars1.yml` due to load order.

**roles/myrole/defaults/main.yml:**
```yaml
app_status: "default_defined_status"
```
**Explanation**: Defines `app_status` as a role default, with the lowest precedence.

**roles/myrole/vars/main.yml:**
```yaml
app_status: "role_vars_defined_status"
```
**Explanation**: Defines `app_status` in role variables, overriding defaults, playbook `vars`, and `vars_files`.

**roles/myrole/tasks/main.yml:**
```yaml
---
- name: Set app_status with set_fact
  set_fact:
    app_status: "set_fact_defined_status"

- name: Display app_status in role tasks
  debug:
    msg: "app_status in role tasks: {{ app_status }}"
  tags: var_priority
```
**Explanation**: Uses `set_fact` to set `app_status` dynamically, overriding all other sources except command-line extras.

### Testing the Example

We run the playbook multiple times, modifying or removing variable definitions to observe precedence:

1. **Command-Line Extra Variable:**
   ```bash
   ansible-playbook -i inventory/hosts.yml project.yml --tags var_priority -e "app_status=command_line_defined_status"
   ```
   **Output**: `Final value of app_status: command_line_defined_status`
   **Explanation**: The command-line extra variable (`-e`) has the highest precedence, overriding all other definitions.

2. **Task-Level Variable (`set_fact`):**
   ```bash
   ansible-playbook -i inventory/hosts.yml project.yml --tags var_priority
   ```
   **Output**: `app_status in role tasks: set_fact_defined_status`
   **Explanation**: With no command-line override, `set_fact` in `tasks/main.yml` takes precedence.

3. **Role Variables (`vars/main.yml`):**
   - Comment out the `set_fact` task in `tasks/main.yml`.
   ```bash
   ansible-playbook -i inventory/hosts.yml project.yml --tags var_priority
   ```
   **Output**: `Final value of app_status: role_vars_defined_status`
   **Explanation**: Role variables override `vars_files`, playbook `vars`, inventory, and defaults.

4. **External Variable Files (`vars_files`):**
   - Comment out `vars/main.yml` content.
   ```bash
   ansible-playbook -i inventory/hosts.yml project.yml --tags var_priority
   ```
   **Output**: `Final value of app_status: vars2_defined_status`
   **Explanation**: The last `vars_files` entry (`vars2.yml`) overrides `vars1.yml`, playbook `vars`, inventory, and defaults.

5. **Playbook Variables (`vars`):**
   - Remove `vars_files` from `project.yml`.
   ```bash
   ansible-playbook -i inventory/hosts.yml project.yml --tags var_priority
   ```
   **Output**: `Final value of app_status: playbook_defined_status`
   **Explanation**: Playbook `vars` override inventory and defaults.

6. **Inventory Host Variables:**
   - Remove `vars` from `project.yml`.
   ```bash
   ansible-playbook -i inventory/hosts.yml project.yml --tags var_priority
   ```
   **Output**: `Final value of app_status: inventory_host_defined_status`
   **Explanation**: Host variables in the inventory override group variables and defaults.

7. **Inventory Group Variables:**
   - Remove `app_status` from the host definition in `hosts.yml`.
   ```bash
   ansible-playbook -i inventory/hosts.yml project.yml --tags var_priority
   ```
   **Output**: `Final value of app_status: inventory_group_defined_status`
   **Explanation**: Group variables override defaults.

8. **Role Defaults:**
   - Remove `app_status` from the group vars in `hosts.yml`.
   ```bash
   ansible-playbook -i inventory/hosts.yml project.yml --tags var_priority
   ```
   **Output**: `Final value of app_status: default_defined_status`
   **Explanation**: Role defaults are used when no other sources define the variable.

### Inventory Group Variables and Merging

For hosts in multiple inventory groups, Ansible merges variables with the following precedence (within inventory):
1. `all` group variables (lowest).
2. Parent group variables.
3. Child group variables.
4. Host variables (highest).

For same-level groups, ASCII alphabetical order determines precedence unless `ansible_group_priority` is set. Higher priority values override lower ones.

**Example Modification for Group Merging:**
Update `inventory/hosts.yml`:
```yaml
all:
  hosts:
    localhost:
      ansible_connection: local
      app_status: "inventory_host_defined_status"
  vars:
    app_status: "inventory_all_group_status"
  children:
    webservers:
      hosts:
        localhost:
      vars:
        app_status: "webservers_group_status"
        ansible_group_priority: 10
    dbservers:
      hosts:
        localhost:
      vars:
        app_status: "dbservers_group_status"
        ansible_group_priority: 5
```
**Test Command:**
```bash
ansible-playbook -i inventory/hosts.yml project.yml --tags var_priority
```
**Output (after commenting out `set_fact`, role `vars`, `vars_files`, playbook `vars`)**: `Final value of app_status: inventory_host_defined_status`
**Explanation**: Host variables override all group variables. If the host variable is removed, `app_status=webservers_group_status` (higher `ansible_group_priority` overrides `dbservers` despite ASCII order).

## Best Practices for Variable Management

1. **Use Descriptive Names**: Choose clear names like `app_status` for clarity.
   ```yaml
   app_status: "production_ready"
   ```
2. **Scope Appropriately**: Use host variables for unique settings, group variables for shared settings, and defaults for fallbacks.
3. **Test Precedence**: Use `ansible-inventory --list` to verify merged variables.
   ```bash
   ansible-inventory --list -i inventory/hosts.yml
   ```
4. **Document Sources**: Comment variable definitions for clarity.
   ```yaml
   # group_vars/webservers.yml
   http_port: 80  # Default web server port
   ```
5. **Control vars_files Order**: List `vars_files` in order of increasing specificity.
   ```yaml
   vars_files:
     - vars/common.yml
     - vars/production.yml
   ```
6. **Use ansible_group_priority**: Override ASCII merging for logical precedence.
   ```ini
   [group:vars]
   app_status=enabled
   ansible_group_priority=20
```
7. **Secure Sensitive Data**: Use Ansible Vault for passwords or tokens.
   ```bash
   ansible-vault create group_vars/secrets.yml
   ```
8. **Enable Merging for Lists/Dicts**: Set `hash_behaviour=merge` in `ansible.cfg` for complex data.
```ini
   [defaults]
   hash_behaviour=merge
```
9. **Validate Variables**: Use `assert` to ensure critical variables are set.
   ```yaml
   - name: Ensure app_status is defined
     assert:
       that: "app_status is defined"
       fail_msg: "app_status must be set"
   ```
10. **Use YAML for Inventories**: Prefer YAML for complex group structures.

## Conclusion

Ansible’s variable precedence hierarchy ensures predictable automation by defining a clear order for variable resolution. From command-line extras to role defaults, each source has a specific role in managing configurations. The comprehensive example demonstrates how these sources interact, with higher-precedence sources overriding lower ones. By following best practices, you can create robust, maintainable automation that scales with your infrastructure.

## Unified Variable Precedence Table

| Variable Source | Precedence Level (Highest to Lowest) | Description and Override Behavior | Example from Playbook | Observed/Expected Output |
|-----------------|--------------------------------------|-----------------------------------|-----------------------|--------------------------|
| Command-line extra vars (`-e`) | Highest | Overrides all other sources; ideal for temporary or runtime-specific changes. | `-e "app_status=command_line_defined_status"` | `command_line_defined_status` |
| Task vars (`set_fact`, registered vars) | High | Defined dynamically in tasks; overrides role vars, vars_files, playbook vars, inventory, and defaults. | `set_fact: app_status: "set_fact_defined_status"` | `set_fact_defined_status` |
| Role vars (`vars/main.yml`) | Medium-High | Overrides vars_files, playbook vars, inventory, and defaults; specific to the role. | `app_status: "role_vars_defined_status"` | `role_vars_defined_status` |
| Play vars_files | Medium | Loaded files override playbook vars, inventory, and defaults; later files override earlier ones. | `vars2.yml: app_status: "vars2_defined_status"` | `vars2_defined_status` |
| Play vars | Medium-Low | Defined in playbook; overrides inventory vars and role defaults. | `vars: app_status: "playbook_defined_status"` | `playbook_defined_status` |
| Inventory host vars | Low | Specific to individual hosts; overrides group vars and defaults. | `localhost: app_status: "inventory_host_defined_status"` | `inventory_host_defined_status` |
| Inventory group vars | Lower | Shared across group hosts; overrides defaults; child groups > parent groups > `all`. | `all: vars: app_status: "inventory_group_defined_status"` | `inventory_group_defined_status` |
| Role defaults (`defaults/main.yml`) | Lowest | Fallback values; overridden by all other sources. | `app_status: "default_defined_status"` | `default_defined_status` |

- *project.yml content:*
```yml
---
- name: Test variable precedence
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    app_status: "playbook_defined_status"

  vars_files:
    - vars/vars1.yml
    - vars/vars2.yml

  roles:
    - myrole

  tasks:
    - name: Display final value of app_status
      debug:
        msg: "Final value of app_status: {{ app_status }}"
      tags: var_priority
```
