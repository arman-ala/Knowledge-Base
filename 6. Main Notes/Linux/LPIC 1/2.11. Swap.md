# Swap

2025-10-15 01:32
Status: #DONE 
Tags: [[Linux]]

---
# Understanding Linux Swap Space: Configuration and Management for Enterprise Environments

## Introduction
In Linux systems, swap space plays a critical role in memory management, particularly in enterprise environments where system reliability and performance are paramount. Swap extends the system's virtual memory by allowing the kernel to move less frequently used data from RAM to disk, ensuring that active processes have sufficient memory. This article provides an in-depth exploration of swap space, its configuration, management, and best practices, tailored for LPIC certification candidates and DevOps professionals.

## What is Swap Space?
Swap space is a dedicated portion of disk storage used as virtual memory in Linux. Unlike RAM, which is the system's physical memory, swap acts as an overflow area when RAM is fully utilized. The Linux kernel employs a Least Recently Used (LRU) algorithm to move inactive memory pages from RAM to swap, freeing up space for active processes. Unlike regular filesystems, swap does not have a mount point; it is managed directly by the kernel, similar to CPU and RAM resources.

### Swap vs. Page File
- **Page File**: Used by Windows systems as virtual memory. It is not relevant in Linux environments.
- **Swap**: The Linux equivalent, stored on a disk partition or file, used exclusively by the kernel.

## Why Swap is Essential in Enterprise Environments
In enterprise setups, swap is critical for system stability. While modern systems often have ample RAM, swap ensures that the system can handle memory-intensive workloads or unexpected spikes in demand. However, excessive reliance on swap can degrade performance due to slower disk I/O compared to RAM. Thus, proper sizing and configuration are vital.

### Minimum Partition Requirements
- **Single Partition**: At a minimum, a Linux system requires one partition mounted at `/` (root).
- **Enterprise Setup**: At least two partitions are recommended:
  - Root (`/`): For the operating system and user data.
  - Swap: For virtual memory management.

## Determining Swap Size
Historically, swap size was calculated using a formula based on RAM size:
```
1.5 * RAM <= swap <= 3.5 * RAM
```
For example, a system with 4GB of RAM would have a swap size between 6GB and 14GB. However, this formula is outdated for modern systems with large RAM capacities (e.g., 1TB). In such cases, swap usage is minimal, and sizes are determined based on workload and experience rather than a strict formula.

### Best Practices for Swap Sizing
- **Small RAM Systems (<8GB)**: Allocate 1-2 times the RAM size for swap to handle memory-intensive tasks.
- **Large RAM Systems (>32GB)**: A smaller swap size (e.g., 4-8GB) is often sufficient, as swap is rarely used.
- **Workload Consideration**: Memory-intensive applications (e.g., databases) may require larger swap spaces.
- **Hibernation**: If hibernation is enabled, swap size should be at least equal to RAM to store the system state.

Excessive swap size increases kernel overhead, so balance is key. Monitor usage with tools like `free -h` to adjust as needed.

## Checking Swap Usage
To view swap usage, use the `free` command with the `-h` flag for human-readable output:
```bash
free -h
```
Example output:
```
              total        used        free      shared  buff/cache   available
Mem:           15Gi       5.1Gi       4.7Gi       888Mi       6.4Gi        10Gi
Swap:          4.0Gi          0B       4.0Gi
```
This shows a total swap size of 4GB, with none currently used. Note that swap does not appear in the `df -hT` output, as it lacks a mount point:
```bash
df -hT
```
Example output:
```
Filesystem                        Type      Size  Used Avail Use% Mounted on
tmpfs                             tmpfs     1.6G  2.5M  1.6G   1% /run
/dev/mapper/ubuntu--vg-ubuntu--lv ext4      913G  108G  760G  13% /
tmpfs                             tmpfs     7.8G   25M  7.8G   1% /dev/shm
tmpfs                             tmpfs     5.0M  8.0K  5.0M   1% /run/lock
efivarfs                          efivarfs  100K   88K  7.6K  93% /sys/firmware/efi/efivars
tmpfs                             tmpfs     7.8G     0  7.8G   0% /run/qemu
/dev/sda2                         ext4      2.0G  404M  1.4G  23% /boot
/dev/sda1                         vfat      1.1G  6.2M  1.1G   1% /boot/efi
tmpfs                             tmpfs     1.6G  248K  1.6G   1% /run/user/1000
/dev/sdb1                         fuseblk   1.9T  1.7T  179G  91% /mnt/external_usb
```
The swap space is typically part of a logical volume (e.g., `/dev/mapper/ubuntu--vg-ubuntu--lv`) managed by Logical Volume Manager (LVM), which is covered in LPIC-2.

## Viewing Disk Layout with lsblk
The `lsblk` command displays the disk and partition structure:
```bash
lsblk
```
Example output:
```
NAME                      MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
sda                         8:0    0 931.5G  0 disk 
├─sda1                      8:1    0     1G  0 part /boot/efi
├─sda2                      8:2    0     2G  0 part /boot
└─sda3                      8:3    0 928.5G  0 part 
  └─ubuntu--vg-ubuntu--lv 252:0    0 928.5G  0 lvm  /
sdb                         8:16   0   1.8T  0 disk 
└─sdb1                      8:17   0   1.8T  0 part /mnt/external_usb
```
This shows that `/dev/sda3` is an LVM partition hosting the root filesystem and potentially the swap space.

## Configuring Swap Space
Configuring swap involves a series of steps, similar to setting up a regular filesystem, but with specific commands for swap.

### Steps for Regular Filesystem
1. **Cable Connection**: Ensure the disk is physically connected.
2. **Partitioning**: Use `fdisk` to create partitions.
3. **Choosing a Filesystem**: Select a filesystem type (e.g., ext4).
4. **Formatting**: Format the partition with `mkfs`.
5. **Mounting**: Mount the filesystem using `mount`.
6. **Viewing**: Check the mounted filesystem with `df -h`.

### Steps for Swap Space
1. **Cable Connection**: Ensure the disk is connected.
2. **Partitioning**: Use `fdisk` to create a swap partition.
3. **Choosing a Filesystem**: Select the `swap` type.
4. **Formatting**: Format the partition with `mkswap`.
5. **Adding to System Swap**: Activate swap with `swapon`.
6. **Viewing**: Check swap status with `free -h`.

### Example: Creating a Swap Partition
Let’s walk through creating a 500MB swap partition on `/dev/sdc`.

#### Step 1: Partitioning with fdisk
Run `fdisk` to create a new partition:
```bash
sudo fdisk /dev/sdc
```
- **Prompt**: You’ll see a welcome message warning that the disk is in use. Ensure no filesystems are mounted and swap is disabled (`swapoff`).
- **Command**: Enter `n` to create a new partition.
- **Partition Type**: Select `p` for primary.
- **Partition Number**: Accept the default (e.g., 1).
- **First Sector**: Accept the default.
- **Last Sector**: Specify `+500M` for a 500MB partition.
- **Change Type**: Enter `t`, select partition 1, and set the type to `82` (Linux swap / Solaris).
- **Verify**: Use `p` to print the partition table:
  ```
  Disk /dev/sdc: 15.11 GiB, 16219373568 bytes, 31678464 sectors
  Device     Boot   Start     End Sectors  Size Id Type
  /dev/sdc1       1026048 2050047 1024000  500M 82 Linux swap / Solaris
  ```
- **Write Changes**: Enter `w` to save and exit.

![[2.11. fdisk.png]]

#### Step 2: Formatting with mkswap
Format the partition as swap:
```bash
sudo mkswap /dev/sdc1
```
Output:
```
Setting up swapspace version 1, size = 500 MiB (524283904 bytes)
no label, UUID=7bcf1597-2c58-44c4-985d-a3bb6323366d
```
This assigns a UUID and prepares the partition for swap use.

#### Step 3: Activating Swap with swapon
Enable the swap partition:
```bash
sudo swapon /dev/sdc1
```
Verify the change:
```bash
free -h
```
Output:
```
              total        used        free      shared  buff/cache   available
Mem:           15Gi       5.7Gi       3.5Gi       1.0Gi       6.9Gi       9.8Gi
Swap:          4.5Gi          0B       4.5Gi
```
The swap size increases from 4GB to 4.5GB, confirming the addition.

#### Step 4: Deactivating Swap with swapoff
To disable the swap partition:
```bash
sudo swapoff /dev/sdc1
```
Verify:
```bash
free -h
```
Output:
```
              total        used        free      shared  buff/cache   available
Mem:           15Gi       5.8Gi       3.4Gi       1.0Gi       6.9Gi       9.8Gi
Swap:          4.0Gi          0B       4.0Gi
```
The swap size reverts to 4GB.

![[2.11. create, add and dismount.png]]

### Making Swap Persistent
To ensure the swap partition is automatically enabled at boot, add it to `/etc/fstab`. First, note the UUID from the `mkswap` output or use:
```bash
lsblk -f
```
Then, edit `/etc/fstab`:
```bash
sudo nano /etc/fstab
```
Add a line like:
```
UUID=7bcf1597-2c58-44c4-985d-a3bb6323366d none swap sw 0 0
```
Save and exit. Test the configuration:
```bash
sudo swapon -a
```
This activates all swap spaces listed in `/etc/fstab`.

## Creating Swap Using a File
An alternative method to configure swap involves creating a swap file within an existing partition, such as the root filesystem (`/`). This approach is flexible and avoids the need for additional partitions. The process uses the `/dev/zero` device and the `dd` command to generate a file of a specified size, which is then formatted and activated as swap. Below is a detailed explanation of the provided method:

### Steps to Create a Swap File
1. **Generate the Swap File**: Use the `dd` command to create a 500MB file named `additional_swap` in the `/root` directory:
   ```bash
   dd if=/dev/zero of=/root/additional_swap bs=500M count=1
   ```
   - **Explanation**: 
     - `if=/dev/zero`: Reads from `/dev/zero`, a special file that provides an infinite stream of null (zero) bytes.
     - `of=/root/additional_swap`: Specifies the output file path and name.
     - `bs=500M`: Sets the block size to 500 megabytes.
     - `count=1`: Indicates that one block of this size should be written, resulting in a 500MB file.
   - **Output Example**: `524288000 bytes (524 MB, 500 MiB) copied, 0.420512 s, 1.2 MB/s` confirms the file creation.

2. **Set Permissions**: Restrict access to the file for security:
   ```bash
   chmod 0600 /root/additional_swap
   ```
   - **Explanation**: Sets permissions to read and write only for the owner (root), aligning with the `0600` mode (owner: rw-, group: ---, others: ---).

3. **Format as Swap**: Prepare the file for use as swap space:
   ```bash
   mkswap /root/additional_swap
   ```
   - **Output Example**: `Setting up swapspace version 1, size = 500 MiB (524283904 bytes) no label, UUID=2ded2bca-3a74-4648-8dea-74454acd0122`.
   - **Explanation**: This command initializes the file as a swap area, assigning a unique UUID.

4. **Activate the Swap File**: Enable the new swap space:
   ```bash
   swapon /root/additional_swap
   ```
   - **Verification**: Use `free -h` to confirm the additional swap space is active, increasing the total swap size by 500MB.

![[2.11. file as swap.png]]

4. **Make Persistent**: Add the swap file to `/etc/fstab` for automatic mounting at boot:
   ```bash
   echo '/root/additional_swap none swap sw 0 0' | sudo tee -a /etc/fstab
   ```
   - **Explanation**: The `tee` command appends the entry, ensuring the system activates the swap file on reboot.

### Advantages and Considerations
- **Flexibility**: Ideal for systems where repartitioning is impractical or additional disks are unavailable.
- **Security**: Storing the swap file in `/root` requires root access, but it’s recommended to use a directory like `/var` or a dedicated mount point to avoid cluttering the root directory.
- **Performance**: Swap files on spinning disks may perform slower than dedicated partitions due to filesystem overhead, though this is negligible on SSDs.

## Best Practices
- **Size Appropriately**: For systems with large RAM, use 4-8GB swap unless specific workloads require more.
- **Monitor Usage**: Regularly check swap usage with `free -h` to avoid performance issues.
- **Use LVM**: Consider placing swap in an LVM volume for flexibility in resizing.
- **Backup fstab**: Before editing `/etc/fstab`, create a backup to avoid boot issues.

## Troubleshooting
- **Swap Not Activating**: Ensure the UUID in `/etc/fstab` matches the output of `lsblk -f`.
- **Performance Issues**: Excessive swap usage indicates insufficient RAM or misconfigured applications. Investigate with `top` or `htop`.

## Best Practices and Tips
- **Monitor Swap Usage**: Use `free -h` or `vmstat` to monitor swap activity. Excessive swapping indicates RAM shortages or misconfigured applications.
- **Use Swap Files**: For flexibility, consider using a swap file instead of a partition, especially in environments where disk layout changes frequently.
  ```bash
  sudo fallocate -l 2G /swapfile
  sudo chmod 600 /swapfile
  sudo mkswap /swapfile
  sudo swapon /swapfile
  ```
  Add to `/etc/fstab`:
  ```
  /swapfile none swap sw 0 0
  ```
- **LVM for Flexibility**: Placing swap in an LVM volume allows dynamic resizing without repartitioning.
- **Swappiness Parameter**: Adjust the kernel’s tendency to use swap with the `vm.swappiness` parameter in `/etc/sysctl.conf`. Default is 60; lower values (e.g., 10) reduce swap usage.
  ```bash
  echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf
  sudo sysctl -p
  ```
- **Backup Before Changes**: Always back up `/etc/fstab` before editing to prevent boot failures.
- **Test Swap Activation**: After modifying `/etc/fstab`, test with `swapon -a` to ensure no errors.

![[2.11. swap methods.png]]

## Comparison of Swap Space Solutions
The provided diagram outlines five methods to increase or manage swap space, including the additional method of creating a swap file using `/dev/zero` and `dd`. Below is a ranked list from best to worst, with reasons based on practicality, performance, and enterprise applicability:

1. **Buy a New Second Hard Disk and Create a Second Section for Swap or Fully Transfer to New Hard**
   - **Reason**: Offers the best long-term solution by adding dedicated storage, reducing contention on the primary disk. Full transfer to a new disk improves performance if the original disk is slow or full. Ideal for enterprise scalability but requires hardware investment and downtime for migration.

2. **Delete Swap and Recreate it with Greater Size**
   - **Reason**: Simple and effective for systems with sufficient unallocated space. Avoids hardware costs and leverages existing resources. However, it requires downtime and careful resizing to avoid data loss, making it less ideal for live production environments.

3. **Use a Swap File (e.g., `/root/additional_swap` with `dd`)**
   - **Reason**: Highly flexible and requires no repartitioning, suitable for quick deployment or systems with limited free partitions. Performance may be slightly lower due to filesystem overhead, and security concerns arise if not properly restricted (e.g., using `/root`). Best for temporary or small-scale adjustments.

4. **Change Filesystem Type of f1 to Swap Using `mkfs`**
   - **Reason**: Reuses existing partitions, saving space, but requires reformatting, leading to data loss on the affected partition (e.g., `/home`). This is risky in production and less flexible unless the partition contains non-critical data, making it a niche solution.

5. **Resize Other Partitions and Give More Space to Swap (if using LVM)**
   - **Reason**: Dependent on LVM and available free space, this method is complex and risks data loss if not managed carefully. It’s less practical than adding a new disk or swap file due to potential filesystem inconsistencies and downtime.

6. **Delete Last 2 Partitions and Make it One Partition for Swap Use (if no important data on `/home`)**
   - **Reason**: Least preferred due to high risk of data loss and irreversible changes. Only viable if `/home` is expendable and no backup exists, which is rare in enterprise settings. This method lacks flexibility and safety.

*if you visit /etc/fstab you may see "/swap.img	none	   swap	sw	 0 0" and wonder why the mount point is declared. The reason is that if you do not write anything the order of arguments becomes wrong so you should write at least a non-sense there.*

## Conclusion
Swap space is a vital component of Linux memory management, particularly in enterprise environments. By understanding its configuration, sizing, and management, system administrators can ensure optimal performance and stability. The provided steps and best practices equip LPIC candidates and DevOps professionals with the knowledge to effectively manage swap space in production systems.