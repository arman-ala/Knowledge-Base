# 3.17. Apt Module

2025-08-15 14:48
Status: #DONE 
Tags: [[Ansible]]

---
### Understanding the Ansible Apt Module: A Comprehensive Guide

In the domain of DevOps automation, Ansible's built-in modules for package management are vital for ensuring consistent software installations across Debian and Ubuntu-based systems. The `ansible.builtin.apt` module manages packages using the apt package manager, handling installations, upgrades, removals, and system maintenance tasks like cache cleaning. This module is particularly suited for Debian OS family distributions, where apt replaces tools like yum or zypper used in RPM-based systems. Below, we present a simplified overview for foundational understanding, followed by a detailed analysis of its parameters, including all possible values and their effects, best practices, and illustrative examples with expected outputs.

#### Simplified Explanation: Breaking It Down Simply

Imagine the `apt` module as a smart shopper for your Debian server: it buys (installs) software packages, updates your shopping list (cache), or returns items (removes packages) from repositories. You tell it what packages to handle (e.g., "nginx" or a list), set the state (present for install, absent for remove), and add options like forcing upgrades or skipping security checks. For example, installing "nginx" ensures it's there without redundant actions, while upgrading the system cleans and updates everything. It's idempotent—runs only if changes are needed—and handles Debian-specific features like build dependencies or .deb files. Use it for quick setups, like adding a repo and installing from it, keeping your system tidy and secure.

#### In-Depth Analysis: Precise and Comprehensive Coverage

The `ansible.builtin.apt` module, part of `ansible-core`, manages apt packages on Debian/Ubuntu systems, requiring python-apt (or python3-apt) and aptitude (pre-2.4). It supports states like present (install), absent (remove), latest (update), and build-dep (install build deps). The module includes an action plugin for controller-side execution and fully supports `check_mode` for simulations and `diff_mode` for change previews. It is POSIX-oriented, with no direct Windows equivalent.

Complex topics include:
- **GPG (GNU Privacy Guard)**: An encryption tool for signing packages; apt uses it to verify authenticity via public keys, preventing installation of tampered software. Disabling checks (e.g., allow_unauthenticated) bypasses this, useful for local repos but risky for external ones.
- **Vendor changes**: In apt, this relates to allowing packages from different sources or versions, controlled by parameters like allow_downgrade (permits lower versions) or force (overrides holds), which can lead to non-idempotent behavior if deps change unexpectedly.
- **Autoremove and autoclean**: Autoremove removes unused dependencies (leaves) to free space, while autoclean clears old package files from cache, preventing bloat.
- **Build-dep**: Installs dependencies for building source packages, useful for compilation without full install.

The module emphasizes idempotency, only acting if the system state differs from desired. It integrates with `apt_repository` for repo management and `stat` for checks.

Below, each parameter is analyzed in detail, including its purpose, type, default value, all possible values and their effects, requirements, and interactions. Best practices, tips, and tricks are provided, with examples and expected outputs.

- **allow_change_held_packages**:
  - description: Determines if the module can change versions of packages marked as held (pinned to specific versions via apt-mark hold).
  - Type: boolean. Default: false. 
  - Possible values: true (effect: allows upgrading/downgrading held packages, overriding holds for flexibility), false (effect: respects holds, preventing changes to pinned packages for stability). 
  - Required: No.
  - Notes: Added in 2.13; useful for forced updates but risks breaking pinned configs.

  Example: Change held package.
  ```yaml
  - name: Upgrade held package
    ansible.builtin.apt:
      name: heldpkg
      state: latest
      allow_change_held_packages: true
  ```
  Expected output: Upgrades heldpkg (`changed: true` if updated); ignores hold.

- **allow_downgrade** (aliases: allow-downgrade, allow_downgrades, allow-downgrades):
  - description: Permits downgrading packages to lower versions if specified, corresponding to apt's --allow-downgrades.
  - Type: boolean. Default: false. 
  - Possible values: true (effect: allows lower versions, non-idempotent as deps may shift), false (effect: prevents downgrades, maintaining higher or equal versions). 
  - Required: No.
  - Notes: Added in 2.12; supported by apt only, ignored with aptitude; can alter package set unexpectedly.

  Example: Allow downgrade.
  ```yaml
  - name: Downgrade package
    ansible.builtin.apt:
      name: pkg=1.0
      state: present
      allow_downgrade: true
  ```
  Expected output: Downgrades to 1.0 (`changed: true`); may affect deps.

- **allow_unauthenticated** (aliases: allow-unauthenticated):
  - description: Ignores authentication failures for packages, useful for bootstrapping or unsigned repos.
  - Type: boolean. Default: false. 
  - Possible values: true (effect: installs unauthenticated packages, risky but for trusted sources), false (effect: requires authentication, secure). 
  - Required: No.
  - Notes: For state=install/present; bypasses GPG/signature checks.

  Example: Install unauthenticated.
  ```yaml
  - name: Install from unsigned repo
    ansible.builtin.apt:
      name: unsignedpkg
      state: present
      allow_unauthenticated: true
  ```
  Expected output: Installs without auth (`changed: true`); warning if unsigned.

- **autoclean**:
  - description: Runs apt-get autoclean to remove old package files from cache.
  - Type: boolean. Default: false. 
  - Possible values: true (effect: cleans obsolete files, frees space), false (effect: no clean). 
  - Required: No.
  - Notes: Standalone or with other ops.

  Example: Autoclean cache.
  ```yaml
  - name: Clean cache
    ansible.builtin.apt:
      autoclean: yes
  ```
  Expected output: Removes old files (`changed: true` if cleaned).

- **autoremove**:
  - description: Removes unused dependencies (leaves).
  - Type: boolean. Default: false. 
  - Possible values: true (effect: cleans orphans, optimizes space), false (effect: leaves them). 
  - Required: No.
  - Notes: Use alone or with state=absent; with purge for configs.

  Example: Autoremove deps.
  ```yaml
  - name: Remove unused deps
    ansible.builtin.apt:
      autoremove: yes
  ```
  Expected output: Removes leaves (`changed: true`).

- **cache_valid_time**:
  - description: Sets cache validity time in seconds; skips update if cache fresher.
  - Type: integer. Default: 0 (always update). 
  - Possible values: Positive integer (e.g., 3600 effect: 1 hour validity), 0 (effect: always refresh). 
  - Required: No.
  - Notes: With update_cache=true.

  Example: Cache for 1 hour.
  ```yaml
  - name: Update if older than 1h
    ansible.builtin.apt:
      update_cache: yes
      cache_valid_time: 3600
  ```
  Expected output: Updates if stale (`changed: true` if refreshed).

- **deb**: Path/URL to .deb file.
  - description: Installs from .deb package.
  - Type: string. Default: None. 
  - Possible values: Local path/URL (effect: installs deb, resolves deps via apt). 
  - Required: No.
  - Notes: For state=present.

  Example: Install deb.
  ```yaml
  - name: Install deb
    ansible.builtin.apt:
      deb: /tmp/custom.deb
  ```
  Expected output: Installs deb (`changed: true`).

- **default_release**: Preferred release for upgrades.
  - description: Sets default release (e.g., stable/testing).
  - Type: string. Default: None. 
  - Possible values: Release name (effect: pins to release). 
  - Required: No.
  - Notes: For state=latest/upgrade.

  Example: Pin to stable.
  ```yaml
  - name: Upgrade from stable
    ansible.builtin.apt:
      upgrade: dist
      default_release: stable
  ```
  Expected output: Upgrades from stable (`changed: true`).

- **dpkg_options**: dpkg options for deb installs.
  - description: Passes options to dpkg (e.g., force-confold).
  - Type: string. Default: "force-confdef,force-confold". 
  - Possible values: Comma-separated options (effect: customizes deb install). 
  - Required: No.

  Example: Custom dpkg.
  ```yaml
  - name: Install with dpkg options
    ansible.builtin.apt:
      deb: /tmp/pkg.deb
      dpkg_options: 'force-confnew'
  ```
  Expected output: Uses options (`changed: true`).

- **force**: Forces actions like removal.
  - description: Forces installs/removals, overriding holds or conflicts.
  - Type: boolean. Default: false. 
  - Possible values: true (effect: forces operation), false (respects holds). 
  - Required: No.
  - Notes: With state=absent for held packages.

  Example: Force remove.
  ```yaml
  - name: Force remove
    ansible.builtin.apt:
      name: heldpkg
      state: absent
      force: yes
  ```
  Expected output: Removes held (`changed: true`).

- **force_apt_get**: Forces apt-get over aptitude.
  - description: Uses apt-get instead of aptitude.
  - Type: boolean. Default: false. 
  - Possible values: true (effect: uses apt-get), false (uses aptitude if available). 
  - Required: No.

  Example: Force apt-get.
  ```yaml
  - name: Use apt-get
    ansible.builtin.apt:
      name: pkg
      state: present
      force_apt_get: yes
  ```
  Expected output: Uses apt-get (`changed: true`).

- **install_recommends**: Installs recommended packages.
  - description: Includes recommended (non-essential) packages.
  - Type: boolean. Default: true. 
  - Possible values: true (effect: full install with recommends), false (effect: minimal, only required). 
  - Required: No.

  Example: No recommends.
  ```yaml
  - name: Minimal install
    ansible.builtin.apt:
      name: apache2
      state: present
      install_recommends: false
  ```
  Expected output: Installs without extras (`changed: true`).

- **name** (aliases: pkg, package): Packages to manage.
  - description: Specifies packages for action.
  - Type: list / elements=string. Default: None. 
  - Possible values: Name (effect: single package), list (effect: multiple), '*' (effect: all for upgrade). 
  - Required: Yes for most states.

  Example: Install list.
  ```yaml
  - name: Install packages
    ansible.builtin.apt:
      name:
        - nginx
        - mariadb-server
      state: present
  ```
  Expected output: Installs both (`changed: true`).

- **only_upgrade**: Upgrades only if installed.
  - description: Upgrades existing packages without new installs.
  - Type: boolean. Default: false. 
  - Possible values: true (effect: updates present packages), false (effect: installs new if specified). 
  - Required: No.
  - Notes: With state=latest.

  Example: Only upgrade.
  ```yaml
  - name: Upgrade existing
    ansible.builtin.apt:
      name: pkg
      state: latest
      only_upgrade: true
  ```
  Expected output: Upgrades if installed (`changed: true` if updated).

- **policy_rc_d**: Sets policy-rc.d value for init scripts.
  - description: Controls return codes for policy-rc.d during upgrades.
  - Type: integer. Default: None. 
  - Possible values: Integer (e.g., 101 effect: prevents service restarts). 
  - Required: No.
  - Notes: For dist/full upgrades.

  Example: Prevent restarts.
  ```yaml
  - name: Upgrade without restarts
    ansible.builtin.apt:
      upgrade: dist
      policy_rc_d: 101
  ```
  Expected output: Upgrades without starting services (`changed: true`).

- **purge**: Purges configs on removal.
  - description: Removes configs with packages.
  - Type: boolean. Default: false. 
  - Possible values: true (effect: full purge), false (effect: leaves configs). 
  - Required: No.
  - Notes: With state=absent/autoremove.

  Example: Purge package.
  ```yaml
  - name: Purge pkg
    ansible.builtin.apt:
      name: oldpkg
      state: absent
      purge: yes
  ```
  Expected output: Removes with configs (`changed: true`).

- **state**: Desired package state.
  - description: Defines action for packages.
  - Type: string. Default: present. 
  - Possible values: absent (effect: removes), build-dep (effect: installs build deps), latest (effect: installs/updates to latest), present (effect: installs if absent), fixed (effect: fixes broken deps). 
  - Required: No.

  Example: Build-dep.
  ```yaml
  - name: Build deps for foo
    ansible.builtin.apt:
      name: foo
      state: build-dep
  ```
  Expected output: Installs deps (`changed: true`).

- **update_cache**: Refreshes apt cache.
  - description: Runs apt update.
  - Type: boolean. Default: false. 
  - Possible values: true (effect: refreshes cache), false (effect: no refresh). 
  - Required: No.
  - Notes: With cache_valid_time.

  Example: Update cache.
  ```yaml
  - name: Update cache
    ansible.builtin.apt:
      update_cache: yes
  ```
  Expected output: Refreshes cache (`changed: true` if updated).

- **upgrade**: Upgrade type.
  - description: Specifies upgrade scope.
  - Type: string. Default: no. 
  - Possible values: no (effect: no upgrade), dist (effect: full dist-upgrade), full (effect: full upgrade), safe (effect: safe upgrade), yes (effect: standard upgrade). 
  - Required: No.

  Example: Dist upgrade.
  ```yaml
  - name: Dist upgrade
    ansible.builtin.apt:
      upgrade: dist
  ```
  Expected output: Full upgrade (`changed: true` if changes).

## Additional Examples for the Ansible Apt Module

#### Example 1: Installing Multiple Packages with Different States
```yaml
- name: Install packages with mixed states
  ansible.builtin.apt:
    name:
      - { name: nginx, state: present }
      - { name: apache2, state: absent }
      - { name: mysql-server, state: latest }
```
**Explanation**: This example demonstrates managing multiple packages with different states in a single task. Nginx is installed if absent, Apache2 is removed if present, and MySQL server is updated to the latest version. This is efficient for managing multiple packages with different requirements. Output shows `changed: true` for each package that was installed, removed, or updated.

#### Example 2: Installing a .deb File from a URL
```yaml
- name: Install package from remote .deb file
  ansible.builtin.apt:
    deb: https://example.com/packages/custom-app_1.0.0_amd64.deb
    state: present
    allow_unauthenticated: true
```
**Explanation**: This example installs a package directly from a remote .deb file URL. The `allow_unauthenticated: true` is used because the remote package might not be signed with a trusted GPG key. This is useful for installing custom packages from a web server. Output shows `changed: true` if the package was installed.

#### Example 3: Upgrading with a Specific Default Release
```yaml
- name: Upgrade packages from testing repository
  ansible.builtin.apt:
    upgrade: full
    default_release: testing
    update_cache: yes
```
**Explanation**: This example performs a full upgrade but only from the 'testing' repository. The `default_release` parameter pins the operation to that specific release. This is useful for selectively upgrading from a specific repository without affecting packages from other releases. Output shows `changed: true` if any packages were upgraded.

#### Example 4: Installing Build Dependencies for a Source Package
```yaml
- name: Install build dependencies for a package
  ansible.builtin.apt:
    name: nginx
    state: build-dep
    update_cache: yes
```
**Explanation**: This example installs all the build dependencies required to compile the nginx package from source. The `state: build-dep` is specifically for this purpose. This is useful for development environments where you need to compile packages from source. Output shows `changed: true` if any build dependencies were installed.

#### Example 5: Upgrading with Policy Control to Prevent Service Restarts
```yaml
- name: Upgrade without restarting services
  ansible.builtin.apt:
    upgrade: dist
    policy_rc_d: 101
    update_cache: yes
```
**Explanation**: This example performs a distribution upgrade but prevents services from restarting during the upgrade. The `policy_rc_d: 101` sets the return code for policy-rc.d to 101, which typically prevents service restarts. This is useful for critical systems where service interruptions must be avoided. Output shows `changed: true` if any packages were upgraded.

#### Example 6: Installing Packages with Custom Dpkg Options
```yaml
- name: Install package with custom dpkg options
  ansible.builtin.apt:
    name: custom-package
    state: present
    dpkg_options: 'force-confnew,force-overwrite'
```
**Explanation**: This example installs a package with custom dpkg options. The `force-confnew` option always installs the new configuration file, and `force-overwrite` overwrites files from other packages. This is useful for resolving conflicts or ensuring specific configurations. Output shows `changed: true` if the package was installed.

#### Example 7: Upgrading Only Existing Packages
```yaml
- name: Upgrade only existing packages
  ansible.builtin.apt:
    name: '*'
    state: latest
    only_upgrade: true
    update_cache: yes
```
**Explanation**: This example upgrades only the packages that are already installed on the system. The `only_upgrade: true` parameter prevents the installation of new packages. This is useful for maintaining the current set of packages without adding new ones. Output shows `changed: true` if any existing packages were upgraded.

#### Example 8: Installing Packages Without Recommendations
```yaml
- name: Install minimal package without recommendations
  ansible.builtin.apt:
    name: nginx
    state: present
    install_recommends: false
```
**Explanation**: This example installs nginx without installing recommended packages. The `install_recommends: false` parameter ensures that only the required dependencies are installed, not the recommended ones. This is useful for minimal installations or when you want to avoid unnecessary packages. Output shows `changed: true` if the package was installed.

#### Example 9: Forcing Upgrade of Held Packages
```yaml
- name: Force upgrade of held package
  ansible.builtin.apt:
    name: held-package
    state: latest
    allow_change_held_packages: true
    update_cache: yes
```
**Explanation**: This example forces the upgrade of a package that has been held (pinned to a specific version). The `allow_change_held_packages: true` parameter allows the module to change the version of a held package. This is useful when you need to override a hold for a specific upgrade. Output shows `changed: true` if the package was upgraded.

#### Example 10: Purging Configuration Files on Removal
```yaml
- name: Remove package and purge configuration files
  ansible.builtin.apt:
    name: old-package
    state: absent
    purge: true
```
**Explanation**: This example removes a package and also purges its configuration files. The `purge: true` parameter ensures that all configuration files associated with the package are removed. This is useful for completely removing a package and its traces. Output shows `changed: true` if the package was removed.

#### Example 11: Updating Cache with Validity Time
```yaml
- name: Update cache only if older than 2 hours
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 7200
```
**Explanation**: This example updates the apt cache only if it's older than 2 hours (7200 seconds). The `cache_valid_time` parameter improves efficiency by avoiding unnecessary cache updates. This is useful for playbooks that run frequently but don't always need the latest package information. Output shows `changed: true` only if the cache was updated.

#### Example 12: Allowing Downgrade of a Package
```yaml
- name: Downgrade package to specific version
  ansible.builtin.apt:
    name: package-name=1.2.3-1
    state: present
    allow_downgrade: true
```
**Explanation**: This example downgrades a package to a specific version. The `allow_downgrade: true` parameter allows the module to install an older version of the package. This is useful for rolling back problematic updates. Output shows `changed: true` if the package was downgraded.

#### Example 13: Installing from a Local .deb File
```yaml
- name: Install package from local .deb file
  ansible.builtin.apt:
    deb: /path/to/local-package.deb
    state: present
    dpkg_options: 'force-confdef'
```
**Explanation**: This example installs a package from a local .deb file. The `dpkg_options: 'force-confdef'` option uses the default action for configuration file conflicts. This is useful for installing packages that are not available in repositories. Output shows `changed: true` if the package was installed.

#### Example 14: Performing Safe Upgrade
```yaml
- name: Perform safe upgrade
  ansible.builtin.apt:
    upgrade: safe
    update_cache: yes
```
**Explanation**: This example performs a safe upgrade, which only installs updates that won't break existing packages. The `upgrade: safe` parameter is more conservative than a full upgrade. This is useful for maintaining system stability while still applying security updates. Output shows `changed: true` if any packages were upgraded.

#### Example 15: Fixing Broken Dependencies
```yaml
- name: Fix broken dependencies
  ansible.builtin.apt:
    state: fixed
    update_cache: yes
```
**Explanation**: This example fixes broken dependencies on the system. The `state: fixed` parameter attempts to resolve dependency issues without installing or removing packages unnecessarily. This is useful for repairing systems with broken package dependencies. Output shows `changed: true` if any dependency issues were resolved.

### Summary Table of Arguments

| Argument Name | Type | Default Value | Possible Values and Effects | Required | Notes/Deprecations |
|---------------|------|---------------|------------------------------|----------|--------------------|
| allow_change_held_packages | boolean | false | true (changes held), false (respects holds) | No | Added 2.13 |
| allow_downgrade | boolean | false | true (allows downgrades), false (prevents) | No | Added 2.12 |
| allow_unauthenticated | boolean | false | true (installs unauth), false (requires auth) | No | For install/present |
| autoclean | boolean | false | true (cleans old files), false (no) | No | - |
| autoremove | boolean | false | true (removes leaves), false (no) | No | With purge for configs |
| cache_valid_time | integer | 0 | Positive (validity seconds), 0 (always refresh) | No | With update_cache |
| deb | string | None | Path/URL (installs deb) | No | For present |
| default_release | string | None | Release name (pins release) | No | For latest/upgrade |
| dpkg_options | string | "force-confdef,force-confold" | Comma-separated (customizes deb install) | No | - |
| force | boolean | false | true (forces ops), false (respects) | No | With absent |
| force_apt_get | boolean | false | true (uses apt-get), false (uses aptitude if avail) | No | - |
| install_recommends | boolean | true | true (includes recommends), false (minimal) | No | - |
| name (pkg, package) | list / elements=string | None | Name/list/'*' (manages packages) | Yes for most | - |
| only_upgrade | boolean | false | true (upgrades existing), false (installs new) | No | With latest |
| policy_rc_d | integer | None | Integer (controls rc.d codes) | No | For upgrades |
| purge | boolean | false | true (purges configs), false (leaves) | No | With absent/autoremove |
| state | string | present | absent (removes), build-dep (build deps), latest (installs/updates), present (installs), fixed (fixes deps) | No | - |
| update_cache | boolean | false | true (refreshes cache), false (no) | No | - |
| upgrade | string | no | no (none), dist/full (full upgrade), safe (safe), yes (standard) | No | -