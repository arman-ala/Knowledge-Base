# 3.6. Expect vs Command vs Shell vs Raw

2025-08-13 03:31
Status: #DONE 
Tags: [[Ansible]]

---
## Comparative Analysis of Ansible's Expect, Command, Shell, and Raw Modules

In the domain of DevOps, Ansible's core modules for executing commands on remote hosts constitute the foundation of automation tasks. Among them, the `expect`, `command`, `shell`, and `raw` modules each fulfill distinct roles, prompting considerations about their appropriate applications. This document delineates their similarities and differences, leveraging official documentation to offer a clear comparison. It begins with a simplified overview for immediate comprehension, followed by a detailed analysis, concluding with an extensive table that encompasses all facets—from parameters and attributes to best practices and use cases.

#### Simplified Explanation: Breaking It Down Simply

Imagine these modules as specialized tools in your toolkit for managing remote computers. The `command` module functions like a precise screwdriver: it executes commands exactly as written, ensuring safety and predictability, but it cannot handle advanced features like pipes or wildcards. The `shell` module resembles a versatile multi-tool: it runs commands through a shell, supporting shortcuts such as `|`, `>`, or `*`, though it demands caution to prevent unintended outcomes. The `expect` module acts as an interactive assistant: it executes a command and automatically responds to prompts (e.g., passwords), ideal for interactive setups. Lastly, the `raw` module is a basic messenger: it sends simple commands directly to the remote shell without needing Python, perfect for bootstrapping systems or managing devices without Python installed. Choose `command` for straightforward tasks, `shell` for complex commands, `expect` for interactive needs, and `raw` for Python-less environments, always opting for the simplest suitable tool to maintain security and efficiency.

#### In-Depth Analysis: Precise and Comprehensive Coverage

Ansible's `ansible.builtin.command`, `ansible.builtin.shell`, `ansible.builtin.expect`, and `ansible.builtin.raw` modules are integral to `ansible-core`, targeting POSIX platforms with varying support for other systems. Their operational paradigms differ significantly.

The `command` module executes commands directly, avoiding shell processing to enhance security by preventing metacharacter interpretation (e.g., no `*` or `|` expansion). This design supports idempotency with `creates` or `removes`, though it lacks shell features. Environment variables are resolved via Python (unless `expand_argument_vars` is disabled), making it suitable for literal executions. Best practice: Use as the default for non-shell tasks to reduce risks; tip: Employ `argv` for arguments with spaces; trick: Register outputs for conditional workflows.

The `shell` module processes commands through a shell (default `/bin/sh`), enabling full shell syntax—pipes, redirects, and variable expansions. This flexibility compromises inherent security and idempotency, necessitating variable sanitization (e.g., `{{ var | quote }}`). It is appropriate for complex command chains but should be a last resort. Best practice: Specify `executable` (e.g., `/bin/bash`) for shell-specific features; tip: Use `creates/removes` for idempotency; trick: Consider `script` for inline scripts.

The `expect` module executes commands directly (no shell by default) but integrates the `pexpect` library for interactive prompt responses via regex (e.g., case-insensitive with `(?i)`). It requires Python 2.6+ and pexpect 3.3+, using `creates/removes` for idempotency. It suits interactive tasks like password prompts but is limited for complex scripting—switch to `shell` with expect code for advanced cases. Best practice: Use lists in `responses` for varying answers; tip: Set `timeout: null` for long interactions; trick: Encode non-UTF-8 outputs with `base64`.

The `raw` module bypasses the module subsystem, executing commands directly through the remote shell (e.g., via SSH) without requiring Python. It is designed for bootstrapping Python (e.g., `yum install -y python`) or managing non-Python devices (e.g., routers). It lacks change handlers and `check_mode` support, relying on the shell for execution. Best practice: Use solely for initial setup or Python-less devices; tip: Disable fact gathering (`gather_facts: no`) for bootstrapping; trick: Specify `executable` for non-default shells.

Commonalities include `chdir`, `creates`, `removes`, and return values (e.g., `stdout`, `stderr`, `rc`), with limited `diff_mode` support and partial `check_mode` via `creates/removes` for most. Notes advocate for `shell` and `raw` only when necessary, emphasizing input sanitization and specialized modules (e.g., `reboot`). The choice depends on the task: `command` for security, `shell` for shell features, `expect` for interactivity, and `raw` for Python-less environments. Tip: Test with `--check` mode; trick: Use `register` and `when` for dynamic execution.

#### Comparison Table: In-Depth Breakdown

The following table provides a side-by-side comparison, incorporating all documented aspects including parameters (with types, defaults, choices, and comments), attributes, requirements, notes, examples (summarized with key outputs/explanations), return values, and more. Data is sourced from the latest Ansible documentation (as of the current context), ensuring completeness.

| Aspect                  | Expect Module                                                                 | Command Module                                                                | Shell Module                                                                  | Raw Module                                                                    |
|-------------------------|-------------------------------------------------------------------------------|-------------------------------------------------------------------------------|-------------------------------------------------------------------------------|-------------------------------------------------------------------------------|
| **Purpose/Synopsis**   | Executes a command and responds to prompts. No shell processing by default; variables/ops like $HOME, <, >, |, & won't work without explicit shell. | Executes commands directly (no shell); takes command + args. No metacharacters (*, <, >, |, ;, &); vars resolved via Python. Use for safe, literal runs. | Executes commands through shell (/bin/sh); supports metacharacters and full shell syntax. Almost like command but with shell. | Executes low-level SSH commands, bypassing module subsystem. No Python required; for bootstrapping Python or non-Python devices. |
| **Requirements**       | Python >= 2.6; pexpect >= 3.3.                                               | None specified.                                                               | None specified.                                                               | None specified (no Python needed).                                            |
| **Parameters**         | - **chdir**: path; Change directory before run. Default: None.<br>- **command**: string (required); Command to run.<br>- **creates**: path; Skip if file/glob exists. Default: None.<br>- **echo**: boolean; Echo responses. Choices: false (default), true.<br>- **removes**: path; Run only if file/glob exists. Default: None.<br>- **responses**: dictionary (required); Regex prompts to answers (string/list). E.g., keys as regex, values as string (repeat) or list (sequential).<br>- **timeout**: any; Wait time (secs) for strings; null disables. Default: 30. | - **argv**: list/elements=string; Command as list (avoids quoting). Mutually exclusive with cmd/free_form. Default: None.<br>- **chdir**: path; Change directory. Default: None.<br>- **cmd**: string; Command to run. Alternative to free_form/argv.<br>- **creates**: path; Skip if file/glob exists (checked first). Default: None.<br>- **expand_argument_vars**: boolean (added 2.16); Expand vars like $HOME. Choices: false, true (default).<br>- **free_form**: string; Free-form command (no actual param).<br>- **removes**: path; Run if file/glob exists (checked after creates). Default: None.<br>- **stdin**: string; Direct stdin value. Default: None.<br>- **stdin_add_newline**: boolean (added 2.8); Append newline to stdin. Choices: false, true (default).<br>- **strip_empty_ends**: boolean (added 2.8); Strip trailing empty lines from output. Choices: false, true (default). | - **chdir**: path; Change directory. Default: None.<br>- **cmd**: string; Command + args.<br>- **creates**: path; Skip if file exists. Default: None.<br>- **executable**: path; Shell path (e.g., /bin/bash). Default: /bin/sh.<br>- **free_form**: string; Free-form command (no actual param).<br>- **removes**: path; Run if file does not exist. Default: None.<br>- **stdin**: string; Direct stdin. Default: None.<br>- **stdin_add_newline**: boolean (added 2.8); Append newline. Choices: false, true (default). | - **executable**: string; Shell path (e.g., '/bin/bash'). Default: None (default shell with become).<br>- **free_form**: string (required); Free-form command (e.g., 'yum install python'). |
| **Attributes**         | - **check_mode**: none.<br>- **diff_mode**: none.<br>- **platform**: posix. | - **check_mode**: partial (via creates/removes).<br>- **diff_mode**: none.<br>- **platform**: posix.<br>- **raw**: full (free-form string parsing). | - **check_mode**: partial (via creates/removes).<br>- **diff_mode**: none.<br>- **platform**: posix.<br>- **raw**: full. | - **check_mode**: none.<br>- **diff_mode**: none.<br>- **platform**: all (no Python required).<br>- **raw**: full. |
| **Notes**              | - Specify shell for ops like | (e.g., /bin/bash -c "...").<br>- Case-insensitive: (?i) prefix.<br>- Pexpect: 2000-byte window, no multiline regex; use (?m)^ for line start.<br>- For complex: Use expect in shell/script.<br>- Encode non-UTF-8 with base64. | - Use shell for metacharacters.<br>- creates/removes/ chdir after command.<br>- Check_mode with creates/removes.<br>- Executable removed (2.4+); use shell.<br>- For Windows: win_command.<br>- For reboots: reboot module.<br>- Encode non-UTF-8 with base64. | - Prefer command for security; use shell judiciously.<br>- Quote vars: {{ var \| quote }}.<br>- Alt: script + template.<br>- For reboots: reboot.<br>- Encode non-UTF-8 with base64. | - Use with `gather_facts: no` for Python bootstrapping.<br>- Prefer command/shell for secure/predictable execution.<br>- `environment` requires `executable` or `become`.<br>- Encode non-UTF-8 with base64. |
| **See Also**           | - script: Run local script remotely.<br>- shell: Execute shell commands. | - raw: Low-level command.<br>- script: Run local script.<br>- shell: Shell commands.<br>- win_command: Windows equivalent. | - command: Non-shell commands.<br>- raw: Low-level.<br>- script: Local script.<br>- win_shell: Windows equivalent. | - command: Non-shell commands.<br>- shell: Shell commands.<br>- win_command: Windows command.<br>- win_shell: Windows shell. |
| **Examples (Summarized with Explanations)** | - Case-insensitive password: expect passwd, respond to "(?i)password" with pass. No_log: true. (Handles prompts securely.)<br>- Multi-regex: Respond to "Question" with list [response1,2,3]; repeat for another prompt. (Sequential/varying answers.)<br>- Multi-questions: Respond to name/db user/pass prompts with vars. (Templated responses.) | - Register motd: cat /etc/motd. (Capture output.)<br>- Conditional run: make_database.sh if no db (with creates, args, or cmd). (Idempotent install.)<br>- Chdir + become: Run as user in dir. (Context switch.)<br>- Argv: Handle spaces in args. (Safe parsing.)<br>- Mixed argv: Positional + options. (Flexible formats.)<br>- Templated: cat {{ myfile\|quote }}. (Safe var use.) | - Redirect output: somescript.sh >> file. (Shell ops.)<br>- Chdir: Run in dir. (Context.)<br>- Conditional: Chdir + creates. (Idempotent.)<br>- Cmd: ls -l \| grep log in dir. (Pipeline.)<br>- Executable: cat < /tmp/*txt with bash. (Non-POSIX.)<br>- Templated: cat {{ myfile\|quote }}. (Safe.)<br>- Expect inline: Use /usr/bin/expect for PXE boot interaction. (Complex scripting.) | - Bootstrap Python: dnf install -y python2. (Installs Python.)<br>- Bash-specific: cat < /tmp/*txt with /bin/bash. (Non-POSIX shell.)<br>- Templated: {{ package_mgr }} install {{ python }}. (Safe var use.)<br>- Windows users: Get-WmiObject -Class Win32_UserAccount. (Windows query.) |
| **Return Values**      | Not explicitly detailed in docs; inherits common (e.g., changed, msg). Assumes similar to command/shell: cmd, delta, end, msg, rc, start, stderr(_lines), stdout(_lines). | - **cmd**: list/string; Executed command. Always.<br>- **delta**: string; Exec time delta.<br>- **end**: string; End time.<br>- **msg**: boolean; Changed.<br>- **rc**: int; Return code (0=success).<br>- **start**: string; Start time.<br>- **stderr**: string; Stderr.<br>- **stderr_lines**: list; Stderr lines.<br>- **stdout**: string; Stdout.<br>- **stdout_lines**: list; Stdout lines. | - **cmd**: string; Executed command.<br>- **delta**: string; Delta time.<br>- **end**: string; End time.<br>- **msg**: boolean; Changed.<br>- **rc**: int; Return code.<br>- **start**: string; Start time.<br>- **stderr**: string; Stderr.<br>- **stderr_lines**: list; Stderr lines.<br>- **stdout**: string; Stdout.<br>- **stdout_lines**: list; Stdout lines. | - **rc**: int; Return code (0=success). Always.<br>- **stderr**: string; Stderr. When available.<br>- **stdout**: string; Stdout. When available.<br>- No `changed`, `cmd`, or timing fields due to no change handler. |
| **Authors**            | Matt Martz (@sivel).                                                         | Ansible Core Team; Michael DeHaan.                                            | Ansible Core Team; Michael DeHaan.                                            | Ansible Core Team; Michael DeHaan.                                            |
| **Best Practices/Tips/Tricks** | Best: Lists for multi-responses; timeout null for long waits. Tip: (?i) for case-insens. Trick: Pipe to base64 for encoding. Prefer for simple prompts; else shell+expect. | Best: Default for non-shell; argv for spaces. Tip: Quote templated vars. Trick: --check with creates/removes; register for conditions. | Best: Only when needed; quote vars. Tip: Executable for bash/zsh. Trick: Inline expect for interactions; alt script for cleanliness. | Best: Use for Python-less setup; switch to command/shell after. Tip: gather_facts: no for bootstrapping. Trick: executable for non-default shells; encode non-UTF-8 with base64. |
